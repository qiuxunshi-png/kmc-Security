<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="KMC Security Operations Management System - Bilingual Edition">
    
    <title>KMC SiteOps V13.9 (Visual Fix / 视觉交互修复版)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* 1. CSS VARIABLES & ROOT SETTINGS */
        :root {
            --bg-body: #0f172a;       /* Slate 900 */
            --bg-card: #1e293b;       /* Slate 800 */
            --bg-input: #020617;      /* Slate 950 */
            --border: #334155;        /* Slate 700 */
            --text: #f8fafc;          /* Slate 50 */
            --text-sub: #94a3b8;      /* Slate 400 */
            --primary: #3b82f6;       /* Blue 500 */
            --success: #10b981;       /* Emerald 500 */
            --danger: #f43f5e;        /* Rose 500 */
            --warning: #f59e0b;       /* Amber 500 */
            --inspect: #3b82f6;       /* Supervision Blue */
            
            /* 强制浏览器表单控件使用暗黑UI */
            color-scheme: dark;
        }

        /* 针对日期等 input 增加高亮交互 */
        input[type="date"].ind-input {
            color: #94a3b8; /* 默认灰色 */
            text-transform: uppercase;
        }
        input[type="date"].ind-input.has-value {
            color: #f8fafc; /* 选中后变白，增强对比度 */
            border-color: rgba(59, 130, 246, 0.5);
        }
        select.ind-input option {
            background-color: #0f172a;
            color: #f8fafc;
        }

        /* 2. GLOBAL RESET */
        body {
            background-color: var(--bg-body);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            line-height: 1.5;
        }

        .app-container {
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            min-height: 100vh;
            background-color: var(--bg-body);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* 3. COMPONENT: CARDS & CONTAINERS */
        .ind-card {
            background-color: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        
        .ind-card:active { transform: scale(0.995); }

        /* --- 高级版：记录卡片样式 (Glassmorphism + Neon Strip) --- */
        .log-card { 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            background: rgba(30, 41, 59, 0.6); /* 半透明底色 */
            backdrop-filter: blur(12px); /* 毛玻璃模糊效果 */
            position: relative; 
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 16px;
        }
        
        /* 独立的极光色带，代替死板的 border-left */
        .log-card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0; width: 4px;
            z-index: 10;
        }
        
        /* 日常任务：清透蓝 */
        .log-card.type-routine::before { 
            background: #3b82f6; 
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.6); 
        }
        /* 临时/特殊任务：琥珀金 */
        .log-card.type-temp::before { 
            background: #f59e0b; 
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.6); 
        }
        /* 异常/求救：霓虹红 */
        .log-card.type-sos::before { 
            background: #f43f5e; 
            box-shadow: 0 0 12px rgba(244, 63, 94, 0.6); 
        }
        /* 督察任务：高级紫 */
        .log-card.type-inspect::before { 
            background: #8b5cf6; 
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.6); 
        }
        
        /* 让卡片内的背景更加通透，适配深色 UI */
        .log-card .border-b { border-color: rgba(255, 255, 255, 0.05) !important; }
        .log-card .bg-slate-800\/30 { background-color: transparent !important; }

        /* 4. COMPONENT: INPUTS */
        .ind-input {
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            border-radius: 8px;
            width: 100%;
            padding: 14px 12px;
            transition: all 0.3s ease;
            font-size: 13px;
            outline: none;
            box-sizing: border-box;
        }
        .ind-input:focus { border-color: var(--primary); background-color: #111827; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .ind-input::placeholder { color: #475569; font-style: italic; }
        textarea.ind-input { resize: none; line-height: 1.6; }

        /* 5. COMPONENT: BUTTONS (3D/Acrylic Style) */
        .btn {
            font-weight: 600;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            font-size: 11px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            letter-spacing: 0.5px;
            gap: 6px;
        }
        .btn:active { transform: scale(0.96); }
        .btn:disabled, .btn.disabled { opacity: 0.6; filter: grayscale(0.8); cursor: not-allowed; pointer-events: none; }
        
        /* --- 高级版：按钮质感 --- */
        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: white; 
            border: 1px solid rgba(96, 165, 250, 0.4); 
            box-shadow: 0 4px 12px -2px rgba(59, 130, 246, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.2); 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-primary:hover {
            box-shadow: 0 6px 16px -2px rgba(59, 130, 246, 0.6), inset 0 1px 1px rgba(255, 255, 255, 0.3);
            filter: brightness(1.05);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%); 
            color: white; 
            border: 1px solid rgba(251, 113, 133, 0.4); 
            box-shadow: 0 4px 12px -2px rgba(244, 63, 94, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.2); 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-danger:hover { filter: brightness(1.05); }

        .btn-temp { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: #fff; /* 琥珀色按钮搭配白字更高级 */
            border: 1px solid rgba(252, 211, 77, 0.4); 
            box-shadow: 0 4px 12px -2px rgba(245, 158, 11, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.2); 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .btn-success { background-color: var(--success); color: white; border: 1px solid #34d399; }
        .btn-inspect { background-color: #334155; color: white; border: 1px solid #475569; }
        .btn-ghost { border: 1px solid var(--border); color: var(--text-sub); background-color: transparent; }
        .btn-ghost:hover { background-color: rgba(255, 255, 255, 0.05); color: white; }

        /* 6. COMPONENT: NAVIGATION */
        .header-bar {
            padding: 16px;
            background-color: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(12px);
        }
        .nav-bar {
            display: flex;
            background-color: #0f172a;
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .nav-item {
            flex: 1;
            padding: 12px 0;
            color: var(--text-sub);
            font-size: 9px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .nav-item i { font-size: 16px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); background-color: rgba(59, 130, 246, 0.05); border-top: 2px solid var(--primary); }
        .nav-item.active-inspect { color: white; background-color: #334155; border-top: 2px solid #94a3b8; }

        /* 7. COMPONENT: TABS & FILTERS */
        .tab-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px; scrollbar-width: none; }
        .tab-bar::-webkit-scrollbar { display: none; }
        .tab-btn {
            white-space: nowrap; padding: 8px 16px; border-radius: 99px; font-size: 11px; font-weight: bold;
            background-color: #334155; color: #94a3b8; border: 1px solid transparent; transition: all 0.2s; cursor: pointer;
        }
        .tab-btn.tab-all.active { background-color: #475569; color: white; border-color: #94a3b8; }
        .tab-btn.tab-patrol.active { background-color: var(--primary); color: white; border-color: #60a5fa; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
        .tab-btn.tab-incident.active { background-color: var(--danger); color: white; border-color: #fb7185; box-shadow: 0 0 10px rgba(244, 63, 94, 0.4); }
        .tab-btn.tab-supervision.active { background-color: #475569; color: white; border-color: #94a3b8; box-shadow: 0 0 10px rgba(71, 85, 105, 0.4); }

        /* 8. COMPONENT: UTILITIES */
        .need-translate { border: 1px dashed var(--danger) !important; background-color: rgba(244, 63, 94, 0.05) !important; }
        .has-translated { border: 1px solid var(--success) !important; background-color: rgba(16, 185, 129, 0.05) !important; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .content-collapsed { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; opacity: 0.7; transition: all 0.3s; }
        .content-expanded { display: block; opacity: 1; }
        #signature-pad { touch-action: none; background-color: #fff; border-radius: 4px; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.9); z-index: 100;
            display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: var(--bg-card); width: 100%; max-width: 450px; border-radius: 16px; padding: 24px;
            border: 1px solid var(--border); max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Mode Selection Cards */
        .mode-card {
            cursor: pointer; border: 2px solid var(--border); background-color: #1e293b; border-radius: 12px; padding: 20px;
            text-align: center; transition: all 0.2s; opacity: 0.6;
        }
        .mode-card:hover { opacity: 0.8; }
        .mode-card.active { opacity: 1; border-color: var(--primary); background-color: rgba(59, 130, 246, 0.1); transform: scale(1.02); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .mode-card.active-temp { opacity: 1; border-color: var(--warning); background-color: rgba(245, 158, 11, 0.1); transform: scale(1.02); box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
        
        /* KPI Dashboard */
        .kpi-card {
            background: linear-gradient(135deg, rgba(30,41,59,1) 0%, rgba(15,23,42,1) 100%);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden;
        }
        .kpi-card:active { transform: scale(0.95); }

        /* --- PDF & PRINT STYLES (CRITICAL FIX) --- */
        .pdf-container {
            display: none;
        }
        .pdf-active {
            display: block !important;
            position: absolute !important; 
            top: 0 !important;
            left: 0 !important; /* 强制死死贴住屏幕左上角的 0,0 坐标 */
            width: 800px !important; /* 锁定桌面级宽度 */
            background-color: #ffffff !important;
            color: #000000 !important;
            margin: 0 !important;
            padding: 0 !important; 
            z-index: 99990 !important;
            transform-origin: 0 0 !important;
        }

        /* --- 新增：批量导出 PDF 白底黑字 A4 打印优化样式 (终极修复版) --- */
        .pdf-export-mode {
            background-color: #ffffff !important;
            color: #000000 !important;
            padding: 20px 10px !important; 
        }

        /* 1. 【核心修复：解决朦胧白雾】禁用所有动画和过渡，强制透明度为1 */
        .pdf-export-mode * {
            animation: none !important;
            transition: none !important;
        }
        .pdf-export-mode .animate-fade-in {
            opacity: 1 !important;
            transform: none !important;
        }

        /* 2. 【核心修复：解决图片拉长】为图片容器设定绝对高度，重置图片宽高属性 */
        .pdf-export-mode .grid-cols-2 > div {
            height: 220px !important; /* 强制锁定 A4 纸上的图片高度 */
            min-height: 220px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background-color: #f3f4f6 !important; /* 浅灰底色 */
            border: 1px solid #d1d5db !important;
        }
        .pdf-export-mode img {
            width: auto !important; 
            height: auto !important;
            max-width: 100% !important;
            max-height: 100% !important;
            object-fit: contain !important;
            background-color: transparent !important;
        }

        /* 3. 【彻底的白底黑字化】消灭所有浅色和彩色文字 */
        .pdf-export-mode .pdf-export-header h2 { color: #000000 !important; }
        .pdf-export-mode .pdf-export-header p { color: #4b5563 !important; border-bottom-color: #e5e7eb !important; }
        
        /* 卡片容器变白底 */
        .pdf-export-mode .ind-card, .pdf-export-mode .log-card {
            background: #ffffff !important;
            border: 1px solid #9ca3af !important; /* 加深外边框 */
            box-shadow: none !important;
            page-break-inside: avoid !important; /* 防止卡片被跨页切断 */
            break-inside: avoid !important;
            margin-bottom: 20px !important;
        }
        
        /* 内部区块浅灰底 */
        .pdf-export-mode .bg-slate-800\/30,
        .pdf-export-mode .bg-slate-900\/50,
        .pdf-export-mode .bg-slate-900\/80 {
            background-color: #f9fafb !important; 
            border-color: #e5e7eb !important;
        }

        /* 强制所有字体变黑/深灰，忽略 Tailwind 的 text-xxx-xxx 类名 */
        .pdf-export-mode [class*="text-"] {
            color: #111827 !important; 
        }
        /* 特殊的小字号或备注用深灰色 */
        .pdf-export-mode .text-slate-400,
        .pdf-export-mode .text-slate-500,
        .pdf-export-mode .opacity-50 {
            color: #4b5563 !important; 
            opacity: 1 !important; /* 去除字体自带的透明度 */
        }
        
        /* 边框颜色统一加深 */
        .pdf-export-mode .border-slate-700\/50,
        .pdf-export-mode .border-slate-700\/30,
        .pdf-export-mode .border-slate-700 {
            border-color: #d1d5db !important;
        }
        
        /* 导出时隐藏不需要的按钮 */
        .pdf-export-mode .export-hide { display: none !important; }
        /* 导出时的专属页眉 */
        .pdf-export-header { display: none; margin-bottom: 16px; text-align: center; border-bottom: 2px solid #334155; padding-bottom: 12px; }
        .pdf-export-mode .pdf-export-header { display: block; }

        @media print {
            .no-print { display: none; }
            body { background-color: white; color: black; }
        }
    </style>
</head>
<body>

<div id="app" style="display: none;">
    
    <!-- 全屏加载遮罩 (单页 PDF 生成时显示) -->
    <div v-if="isGeneratingPDF" class="fixed inset-0 bg-slate-900 z-[99999] flex flex-col items-center justify-center text-white backdrop-blur-sm">
        <i class="fas fa-spinner fa-spin text-5xl mb-4 text-blue-500"></i>
        <h2 class="text-xl font-bold tracking-widest uppercase">Rendering PDF</h2>
        <p class="text-xs text-slate-400 mt-2 font-mono">Processing document, please wait... / 正在生成文件，请稍候...</p>
    </div>

    <!-- 全屏加载遮罩 (批量 PDF 生成时显示) -->
    <div v-if="isExportingList" class="fixed inset-0 bg-slate-900/90 z-[99999] flex flex-col items-center justify-center text-white backdrop-blur-sm">
        <i class="fas fa-spinner fa-spin text-5xl mb-4 text-rose-500"></i>
        <h2 class="text-xl font-bold tracking-widest uppercase">Exporting All Records</h2>
        <p class="text-xs text-slate-400 mt-2 font-mono">Capturing WYSIWYG Document... / 正在截取全部记录...</p>
    </div>

    <div v-if="!currentUser" class="min-h-screen flex flex-col items-center justify-center p-8 bg-slate-900">
        <div class="mb-10 text-center animate-fade-in">
            <div class="w-24 h-24 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-slate-700 shadow-2xl">
                <i class="fas fa-shield-alt text-5xl text-blue-500"></i>
            </div>
            <h1 class="text-4xl font-bold text-white tracking-tight">KMC SiteOps</h1>
            <div class="flex flex-col items-center mt-3 gap-1">
                <span class="px-2 py-0.5 rounded bg-blue-500/10 text-blue-400 text-[10px] font-bold border border-blue-500/20">V13.9</span>
                <p class="text-xs text-slate-500 uppercase tracking-widest">2026-02 Config / 双语适配版</p>
            </div>
        </div>
        
        <div class="w-full max-w-sm space-y-4 animate-fade-in" style="animation-delay: 0.1s;">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-user text-slate-500 text-xs"></i>
                </div>
                <select v-model="loginForm.id" class="ind-input bg-slate-900 h-12 pl-10">
                    <option value="" disabled>-- Select Identity / 选择身份 --</option>
                    <optgroup label="Management / 管理层">
                        <option v-for="u in staffList.filter(x=>x.role!=='patrol')" :value="u.login_id">{{u.name}}</option>
                    </optgroup>
                    <optgroup label="Patrol / 安保队">
                        <option v-for="u in staffList.filter(x=>x.role==='patrol')" :value="u.login_id">{{u.name}}</option>
                    </optgroup>
                </select>
            </div>

            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-lock text-slate-500 text-xs"></i>
                </div>
                <input type="password" v-model="loginForm.password" class="ind-input bg-slate-900 text-center tracking-widest h-12 pl-10" placeholder="Password / 密码">
            </div>
            
            <button @click="handleLogin" :disabled="isLoading" class="btn btn-primary w-full shadow-lg h-12 text-xs font-bold tracking-wider">
                <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                {{ isLoading ? 'VERIFYING / 验证中...' : 'LOGIN SYSTEM / 登录系统' }}
            </button>
            
            <p class="text-center text-[10px] text-slate-600 mt-4">Protected System. Authorized Access Only.<br>内部系统 仅限授权访问</p>
        </div>
    </div>

    <div v-else class="app-container" v-show="!isGeneratingPDF">
        
        <header class="header-bar">
            <div class="flex items-center">
                <div v-if="currentView !== 'tasks'" @click="goBack" class="flex items-center gap-2 cursor-pointer text-slate-400 hover:text-white transition group">
                    <div class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center group-hover:bg-slate-700 transition">
                        <i class="fas fa-arrow-left text-xs"></i>
                    </div>
                    <span class="text-xs font-bold uppercase group-hover:text-blue-400 transition">Back / 返回</span>
                </div>
                
                <div v-else class="flex items-center gap-3 cursor-pointer group" @click="openPwdModal(currentUser)" title="Click to change password / 点击修改密码">
                    <div class="w-9 h-9 rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center text-xs font-bold text-blue-500 shadow-inner group-hover:border-blue-500 transition">
                        {{currentUser.name[0]}}
                    </div>
                    <div class="flex flex-col">
                        <h2 class="text-sm font-bold text-slate-100 leading-none mb-1 group-hover:text-blue-400 transition">
                            {{currentUser.name}} <i class="fas fa-pen text-[9px] ml-1 opacity-50"></i>
                        </h2>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-[9px] text-slate-400 uppercase font-medium">Online / 在线</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <button @click="logout" class="text-[10px] text-rose-500 border border-rose-500/30 px-3 py-1.5 rounded hover:bg-rose-500/10 transition">
                <i class="fas fa-sign-out-alt mr-1"></i> Exit / 退出
            </button>
        </header>

        <main class="flex-1 p-4 overflow-y-auto pb-24 scroll-smooth">

            <div v-if="currentView === 'tasks'" class="animate-fade-in">
                
                <div class="flex justify-between items-end mb-4 border-b border-slate-800 pb-3">
                    <div>
                        <h2 class="text-lg font-bold text-slate-100">Tasks / 任务列表</h2>
                        <p class="text-[10px] text-slate-500 font-mono mt-0.5">
                            {{ new Date().toLocaleDateString() }} • {{ sortedTasks.length }} Active
                        </p>
                    </div>
                    
                    <div class="flex gap-2">
                        <button v-if="!isManagement" @click="openInspection" class="btn btn-inspect px-3 py-2 text-[10px] rounded-full shadow-lg">
                             <i class="fas fa-search-plus mr-1"></i> INSPECT / 督察
                        </button>

                        <button v-if="isManagement" @click="editTask(null)" class="btn btn-primary px-4 py-2 text-[10px] rounded-full shadow-lg">
                            <i class="fas fa-plus mr-1"></i> New / 新增
                        </button>
                    </div>
                </div>

                <div v-if="sortedTasks.length===0" class="flex flex-col items-center justify-center py-12 text-slate-600 border border-dashed border-slate-800 rounded-xl bg-slate-800/20">
                    <i class="fas fa-clipboard-check text-4xl mb-3 opacity-20"></i>
                    <p class="text-xs font-medium">No tasks found / 暂无任务数据</p>
                </div>

                <div v-for="task in sortedTasks" :key="task.id" class="ind-card relative border-l-4 group" :class="task.is_temp ? 'border-l-warning' : 'border-l-primary'">
                    
                    <div class="p-3 bg-slate-800/50 border-b border-slate-700/50 flex justify-between items-start">
                        <div class="flex items-center flex-wrap gap-1.5">
                            <span v-if="task.is_temp" class="text-[9px] font-bold px-2 py-0.5 rounded bg-amber-500 text-black uppercase shadow-sm">TEMP / 临时</span>
                            <span class="text-[9px] font-bold px-2 py-0.5 rounded border uppercase" :class="task.priority==='high'?'text-rose-400 border-rose-500/30 bg-rose-500/10':'text-blue-400 border-blue-500/30 bg-blue-500/10'">
                                {{task.priority}}
                            </span>
                            <span v-if="task.assigned_team" class="text-[10px] text-slate-300 bg-slate-700/50 border border-slate-600/50 px-2 py-0.5 rounded truncate max-w-[120px]">
                                <i class="fas fa-shield-alt text-[9px] mr-1 opacity-50"></i>{{task.assigned_team}}
                            </span>
                        </div>
                        <span class="text-[10px] font-mono tabular-nums text-slate-400 tracking-wider">{{formatDate(task.due_date)}}</span>
                    </div>
                    
                    <div class="p-4 cursor-pointer hover:bg-slate-800/30 transition" @click="toggleExpand(task.id)">
                        <h3 class="font-bold text-base text-slate-200 mb-1 leading-snug">{{task.title}}</h3>
                        
                        <div class="text-xs text-slate-400 font-mono mt-2" :class="expanded.includes(task.id)?'content-expanded':'content-collapsed'">
                            <span class="text-yellow-500 font-bold mr-1">REQ:</span> {{task.content}}
                        </div>
                        
                        <div class="text-center mt-3 opacity-30 group-hover:opacity-100 transition-opacity">
                            <i class="fas text-[10px]" :class="expanded.includes(task.id)?'fa-chevron-up':'fa-chevron-down'"></i>
                        </div>
                    </div>

                    <div class="p-3 bg-slate-900 border-t border-slate-800 flex gap-2">
                        <button v-if="!isManagement" @click="goToExec(task)" class="btn btn-primary flex-1 py-3 text-xs shadow-lg hover:brightness-110 transition">
                            <i class="fas fa-play mr-2"></i> EXECUTE / 执行任务
                        </button>
                        
                        <div v-if="isManagement" class="flex w-full gap-2 items-center justify-between">
                            <label class="flex items-center gap-2 text-[10px] text-slate-400 bg-slate-800 px-3 py-2 rounded border border-slate-700 cursor-pointer hover:border-slate-500 transition">
                                <input type="checkbox" v-model="task.active" @change="saveTask(task, true)" class="accent-blue-500 w-4 h-4"> Active / 启用
                            </label>
                            <div class="flex gap-2">
                                <button @click="editTask(task)" class="btn btn-ghost px-3 py-1.5 text-[10px] text-blue-400 border-blue-500/30 hover:bg-blue-500/10">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button @click="deleteTask(task.id)" class="btn btn-ghost px-3 py-1.5 text-[10px] text-rose-500 border-rose-500/30 hover:bg-rose-500/10">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'inspection'" class="pt-2 animate-fade-in">
                 <div class="mb-6">
                    <span class="text-[10px] text-slate-400 font-bold uppercase mb-1 block tracking-wider">Supervision / 督察</span>
                    <h2 class="text-lg font-bold text-slate-100">Report Violation / 违规上报</h2>
                </div>

                <div class="space-y-6">
                    <div class="p-4 bg-slate-800/50 rounded-xl border border-slate-600/30 shadow-sm">
                        <label class="text-[10px] text-slate-500 uppercase font-bold block mb-2">Target / 目标 <span class="text-rose-500">*</span></label>
                        <div class="space-y-3">
                             <select v-model="inspectionForm.company" class="ind-input text-xs font-bold text-blue-100 bg-blue-900/10 border-blue-500/30 h-10">
                                <option value="">-- Select Company / 选择公司 --</option>
                                <option v-for="c in config.companies" :value="c">{{c}}</option>
                            </select>
                            
                            <div v-if="inspectionForm.company" class="animate-fade-in">
                                <select v-model="inspectionForm.point" class="ind-input text-xs text-slate-300 border-slate-600 h-10">
                                    <option value="">-- Select Point / 选择点位 --</option>
                                    <option v-for="p in (config.pointsMap[inspectionForm.company] || [])" :value="p.name">{{p.name}}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Violation Details / 违规详情 <span class="text-rose-500">*</span></label>
                        
                        <div class="relative bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                            <div class="flex justify-between items-center bg-slate-900/50 px-3 py-2 border-b border-slate-700">
                                <span class="text-[9px] text-slate-400 font-bold uppercase">Content Editor</span>
                                <button @click="translate('content', inspectionForm)" :disabled="isLoading" 
                                        class="flex items-center gap-1.5 px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-[9px] font-bold transition-colors">
                                    <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                                    <i v-else class="fas fa-language"></i>
                                    TRANSLATE / 翻译
                                </button>
                            </div>
                            
                            <textarea v-model="inspectionForm.content" class="w-full bg-transparent text-white text-xs p-3 h-32 outline-none resize-none" 
                                      :class="checkTranslationStatus(inspectionForm.content)?'text-emerald-300':'text-slate-200'" 
                                      placeholder="Describe the violation (Sleeping, Uniform, etc) / 描述违规情况 (睡觉、未穿制服等)..."></textarea>
                        </div>

                        <p class="text-[10px] mt-1 transition-colors duration-300 text-right font-mono" :class="checkTranslationStatus(inspectionForm.content)?'text-emerald-500':'text-rose-500'">
                            {{ checkTranslationStatus(inspectionForm.content) ? '[✔ Translated / 已翻译]' : '[⚠ Click Translate / 请先点击翻译]' }}
                        </p>
                    </div>

                    <div class="p-4 border border-slate-500/30 rounded-xl bg-slate-800/20">
                        <div class="text-xs text-slate-400 font-bold mb-3 uppercase flex items-center gap-2">
                             <i class="fas fa-camera"></i> Evidence / 证据照片 (Required)
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="border-2 border-dashed border-slate-500/50 bg-slate-800 rounded flex flex-col items-center justify-center h-20 cursor-pointer relative hover:bg-slate-700/50 transition">
                                <i class="fas fa-camera text-xl text-slate-500"></i>
                                <input type="file" accept="image/*" capture="environment" @change="handleInspectionPhoto" class="absolute inset-0 opacity-0 w-full h-full">
                            </div>
                            <div v-for="(img, idx) in inspectionForm.photos" :key="idx" class="relative h-20 bg-black rounded border border-slate-700 overflow-hidden group">
                                <img :src="img" class="w-full h-full object-cover">
                                <button @click="inspectionForm.photos.splice(idx,1)" class="absolute top-0 right-0 bg-black/50 text-white w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">×</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                         <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Patrol Sign / 巡逻员签字</label>
                            <div @click="openSigModal('inspection')" class="ind-input p-3 text-center cursor-pointer bg-slate-800 border-dashed hover:bg-slate-800/80 transition" :class="hasSignedInspection ? 'border-emerald-500 bg-emerald-500/5' : 'border-slate-500/50'">
                                <span v-if="hasSignedInspection" class="text-emerald-500 font-bold text-[10px] flex items-center justify-center gap-1">
                                    <i class="fas fa-check"></i> SIGNED
                                </span>
                                <span v-else class="text-slate-400 text-[10px]"><i class="fas fa-pen mr-1"></i> Click to Sign</span>
                            </div>
                        </div>
                        <div>
                             <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Witness/Subject / 当事人签字</label>
                             <div @click="openSigModal('inspection_target')" class="ind-input p-3 text-center cursor-pointer bg-slate-800 border-dashed hover:bg-slate-800/80 transition" :class="hasSignedInspectionTarget ? 'border-emerald-500 bg-emerald-500/5' : 'border-slate-500/50'">
                                <span v-if="hasSignedInspectionTarget" class="text-emerald-500 font-bold text-[10px] flex items-center justify-center gap-1">
                                    <i class="fas fa-check"></i> SIGNED
                                </span>
                                <span v-else class="text-slate-400 text-[10px]"><i class="fas fa-pen mr-1"></i> Click to Sign</span>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-800">
                        <button @click="submitInspection" 
                                :disabled="!inspectionForm.company || !checkTranslationStatus(inspectionForm.content) || inspectionForm.photos.length===0 || !hasSignedInspection || isLoading" 
                                class="btn btn-inspect w-full py-4 shadow-lg transition-all text-xs font-bold tracking-wider hover:brightness-110">
                            <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                            <i v-else class="fas fa-paper-plane mr-2"></i>
                            {{ isLoading ? 'SUBMITTING...' : (!checkTranslationStatus(inspectionForm.content) ? 'TRANSLATE FIRST / 请先翻译' : 'SUBMIT REPORT / 提交督察报告') }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'task_form'" class="pt-2 animate-fade-in">
                <div class="mb-4 text-center">
                    <h2 class="text-lg font-bold text-slate-200">Select Type / 选择任务类型</h2>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div @click="taskMode='routine'; tempTask.is_temp=false" class="mode-card" :class="taskMode==='routine'?'active':''">
                        <i class="fas fa-building text-3xl text-blue-500 mb-2"></i>
                        <h3 class="text-xs font-bold text-white">Fixed Point</h3>
                        <p class="text-[10px] text-slate-400">固定安保岗</p>
                    </div>
                    <div @click="taskMode='temp'; tempTask.is_temp=true; tempTask.title=''; tempTask.content=''" class="mode-card" :class="taskMode==='temp'?'active-temp':''">
                        <i class="fas fa-user-clock text-3xl text-amber-500 mb-2"></i>
                        <h3 class="text-xs font-bold text-white">Non-Fixed</h3>
                        <p class="text-[10px] text-slate-400">非固定任务</p>
                    </div>
                </div>
                
                <div v-if="taskMode === 'routine'" class="space-y-6 animate-fade-in">
                    <div class="p-4 bg-slate-800/50 rounded-xl border border-blue-500/30">
                        <h3 class="text-xs font-bold text-blue-400 uppercase mb-3"><i class="fas fa-map-marker-alt mr-1"></i> Routine / 固定指派</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-500 block mb-1">Company / 公司</label>
                                <select v-model="tempTask.assigned_team" class="ind-input text-xs" @change="tempTask.title=''">
                                    <option value="">-- Select Company / 选择公司 --</option>
                                    <option v-for="c in config.companies" :value="c">{{c}}</option>
                                </select>
                            </div>
                            <div v-if="tempTask.assigned_team" class="animate-fade-in">
                                <div class="flex justify-between items-center mb-1">
                                    <label class="text-[10px] text-blue-400 block">Point / 点位</label>
                                    <button @click="showPointManager = !showPointManager" class="text-[9px] text-blue-500 bg-blue-900/20 px-2 py-0.5 rounded border border-blue-500/30 hover:bg-blue-900/40 transition">
                                        <i class="fas fa-cog mr-1"></i> Manage
                                    </button>
                                </div>
                                
                                <div v-if="showPointManager" class="mb-2 p-3 bg-slate-900 border border-slate-700 rounded animate-fade-in shadow-inner">
                                     <div class="flex gap-2 mb-2">
                                         <input v-model="newPointName" class="ind-input py-1 text-xs" placeholder="New Point Name...">
                                         <button @click="quickAddPoint" class="btn btn-primary py-1 px-3 text-xs">Add</button>
                                     </div>
                                     <div class="max-h-32 overflow-y-auto space-y-1 pr-1">
                                         <div v-for="(p, idx) in (config.pointsMap[tempTask.assigned_team] || [])" class="flex justify-between items-center text-xs text-slate-400 p-1.5 hover:bg-slate-800 rounded transition border border-transparent hover:border-slate-700">
                                             <span>{{p.name}}</span>
                                             <button @click="quickRemovePoint(idx)" class="text-rose-500 hover:text-white"><i class="fas fa-times"></i></button>
                                         </div>
                                     </div>
                                </div>

                                <select v-model="tempTask.title" class="ind-input text-xs font-bold text-blue-100 border-blue-500/50 bg-blue-900/10" @change="autoFillContent">
                                    <option value="" disabled>-- Select Point / 选择点位 --</option>
                                    <option v-for="p in (config.pointsMap[tempTask.assigned_team] || [])" :value="p.name">{{p.name}}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="taskMode === 'temp'" class="space-y-6 animate-fade-in">
                    <div class="p-4 bg-slate-800/50 rounded-xl border border-amber-500/30">
                        <h3 class="text-xs font-bold text-amber-400 uppercase mb-3"><i class="fas fa-stopwatch mr-1"></i> Non-Fixed / 非固定任务</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-500 block mb-1">Assign To (Internal) / 指派给(内部人员)</label>
                                <select v-model="tempTask.assigned_team" class="ind-input text-xs font-bold text-amber-100 bg-amber-900/20 border-amber-500/50">
                                    <option value="">-- Select Staff / 选择人员 --</option>
                                    <option v-for="u in internalStaff" :value="u.name">{{u.name}} ({{u.login_id}})</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="text-[10px] text-amber-400 block mb-1 font-bold">Task Title / 任务标题</label>
                                <div class="flex flex-col gap-2">
                                    <select class="ind-input text-xs h-9 bg-slate-900 text-slate-400 border-slate-700" 
                                            @change="tempTask.title = $event.target.value">
                                            <option value="">-- Select Preset / 选择预设 --</option>
                                            <option v-for="p in nonFixedPresets" :value="p">{{p}}</option>
                                    </select>
                                    <input v-model="tempTask.title" class="ind-input border-amber-500/50" placeholder="Or type manually / 或手动输入...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="(taskMode==='routine' && tempTask.title) || taskMode==='temp'" class="animate-fade-in">
                    <div class="mt-6 mb-2">
                        <label v-if="taskMode==='routine'" class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Standard (Editable) / 约定标准 <span class="text-rose-500">*</span></label>
                        <label v-if="taskMode==='temp'" class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Details / 详情 <span class="text-rose-500">*</span></label>
                    </div>

                    <div class="relative bg-slate-800 rounded-lg border border-slate-700 overflow-hidden mb-2">
                        <div class="flex justify-between items-center bg-slate-900/50 px-3 py-2 border-b border-slate-700">
                            <span class="text-[9px] text-slate-400 font-bold uppercase">Task Requirements</span>
                            <button @click="translate('content', tempTask)" :disabled="isLoading" 
                                    class="flex items-center gap-1.5 px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-[9px] font-bold transition-colors">
                                <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                                <i v-else class="fas fa-language"></i>
                                TRANSLATE / 翻译
                            </button>
                        </div>
                        <textarea v-model="tempTask.content" class="w-full bg-transparent text-white text-xs p-3 h-32 outline-none resize-none" 
                                  :class="checkTranslationStatus(tempTask.content)?'text-emerald-300':'text-slate-200'"
                                  placeholder="Contract details / 合同要求..."></textarea>
                    </div>
                    
                    <p class="text-[10px] mt-1 mb-4 text-right font-mono" :class="checkTranslationStatus(tempTask.content)?'text-emerald-500':'text-rose-500'">
                        {{ checkTranslationStatus(tempTask.content) ? '[✔ Translated / 已翻译]' : '[⚠ Click Translate / 请先点击翻译]' }}
                    </p>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <label class="flex items-center gap-2 text-[10px] text-slate-300 bg-slate-800 p-3 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition select-none">
                            <input type="checkbox" v-model="tempTask.req_photo" class="accent-blue-500 w-4 h-4">
                            <span><i class="fas fa-camera mr-1"></i> Force Photo</span>
                        </label>
                        <label class="flex items-center gap-2 text-[10px] text-slate-300 bg-slate-800 p-3 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition select-none">
                            <input type="checkbox" v-model="tempTask.req_sign" class="accent-blue-500 w-4 h-4">
                            <span><i class="fas fa-file-signature mr-1"></i> Force Sign</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-800">
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">Priority / 优先级</label>
                        <select v-model="tempTask.priority" class="ind-input text-xs h-10">
                            <option value="medium">Medium / 中</option>
                            <option value="high">High / 高</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">Deadline / 截止</label>
                        <input type="datetime-local" v-model="tempTask.due_date" class="ind-input text-xs h-10 text-white">
                    </div>
                </div>

                <div class="pt-6 pb-6">
                    <button v-if="taskMode==='routine'" @click="saveTask(tempTask, false)" :disabled="!tempTask.title || !checkTranslationStatus(tempTask.content) || isLoading" class="btn btn-primary w-full py-4 shadow-lg text-xs tracking-wider font-bold">
                        <i v-if="!checkTranslationStatus(tempTask.content) && !isLoading" class="fas fa-lock mr-2"></i>
                        <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ isLoading ? 'SAVING...' : (!checkTranslationStatus(tempTask.content) ? 'TRANSLATE FIRST / 请先翻译' : 'CONFIRM ROUTINE TASK / 确认固定任务') }}
                    </button>
                    <button v-else @click="saveTask(tempTask, false)" :disabled="!checkTranslationStatus(tempTask.content) || !tempTask.title || isLoading" class="btn btn-temp w-full py-4 shadow-lg font-bold text-xs tracking-wider">
                        <i v-if="!checkTranslationStatus(tempTask.content) && !isLoading" class="fas fa-lock mr-2"></i>
                        <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ isLoading ? 'PUBLISHING...' : (!checkTranslationStatus(tempTask.content) ? 'TRANSLATE FIRST / 请先翻译' : 'PUBLISH NON-FIXED / 发布非固定任务') }}
                    </button>
                </div>
            </div>

            <div v-if="currentView === 'task_exec'" class="pt-2 animate-fade-in">
                 <div class="mb-4">
                    <span class="text-[10px] text-blue-400 font-bold uppercase mb-1 block">Current Task / 当前任务</span>
                    <h2 class="text-lg font-bold text-slate-100 mb-2 leading-tight">{{tempExecution.title}}</h2>
                    <div class="p-3 bg-slate-800/50 rounded border border-slate-700 text-xs text-slate-400 font-mono mb-4">
                        <span class="text-yellow-500 font-bold block mb-1">CONTRACT REQ / 合同要求:</span>
                        {{tempExecution.content}}
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Actual Situation / 现场实际情况 <span class="text-rose-500">*</span></label>
                        
                        <div class="relative bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                            <div class="flex justify-between items-center bg-slate-900/50 px-3 py-2 border-b border-slate-700">
                                <span class="text-[9px] text-slate-400 font-bold uppercase">Situation Report</span>
                                <button @click="translate('note', executionForm)" :disabled="isLoading" 
                                        class="flex items-center gap-1.5 px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-[9px] font-bold transition-colors">
                                    <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                                    <i v-else class="fas fa-language"></i>
                                    TRANSLATE / 翻译
                                </button>
                            </div>
                            <textarea v-model="executionForm.note" class="w-full bg-transparent text-white text-xs p-3 h-32 outline-none resize-none" 
                                      :class="checkTranslationStatus(executionForm.note)?'text-emerald-300':'text-slate-200'"
                                      placeholder="Describe actual situation / 描述现场情况..."></textarea>
                        </div>
                        
                        <p class="text-[10px] mt-1 text-right font-mono" :class="checkTranslationStatus(executionForm.note)?'text-emerald-500':'text-rose-500'">
                            {{ checkTranslationStatus(executionForm.note) ? '[✔ Translated / 已翻译]' : '[⚠ Click Translate / 请先点击翻译]' }}
                        </p>
                    </div>
                    
                    <div class="p-4 bg-slate-800 rounded-xl border border-slate-700 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-amber-500"></i>
                            <div class="text-xs font-bold text-slate-200">Violation Found? / 发现违规?</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="executionForm.has_violation" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-rose-500"></div>
                        </label>
                    </div>

                    <div v-if="executionForm.has_violation || tempExecution.req_photo || tempExecution.req_sign" class="animate-fade-in p-4 border border-rose-500/30 rounded-xl bg-rose-500/5">
                        <div v-if="executionForm.has_violation" class="text-xs text-rose-400 font-bold mb-3 uppercase flex items-center justify-between border-b border-rose-500/20 pb-2">
                            <span><i class="fas fa-user-secret mr-1"></i> SUPERVISION MODE / 督查模式</span>
                        </div>
                        
                        <div v-if="executionForm.has_violation" class="mb-4">
                            <label class="text-[10px] text-rose-300 block mb-1">Violation Type / 违规类型</label>
                            <select v-model="executionForm.violation_type" class="ind-input text-xs border-rose-500/50 bg-rose-500/10">
                                <option value="">-- Select Type / 选择类型 --</option>
                                <option value="Sleeping / 睡岗">Sleeping / 睡岗</option>
                                <option value="Missing / 脱岗">Missing / 脱岗</option>
                                <option value="No Uniform / 未穿制服">No Uniform / 未穿制服</option>
                                <option value="Drunk / 酗酒">Drunk / 酗酒</option>
                                <option value="Other / 其他">Other / 其他</option>
                            </select>
                        </div>

                         <div class="mb-4" v-if="executionForm.has_violation || tempExecution.req_photo">
                            <label class="text-[10px] text-slate-500 block mb-1">Photos / 照片 (Required)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="border-2 border-dashed border-rose-500/50 bg-slate-800 rounded flex flex-col items-center justify-center h-20 cursor-pointer relative hover:bg-slate-700/50 transition">
                                    <i class="fas fa-camera text-xl text-rose-500"></i>
                                    <input type="file" accept="image/*" capture="environment" @change="handlePhotoUploadExec" class="absolute inset-0 opacity-0 w-full h-full">
                                </div>
                                <div v-for="(img, idx) in executionForm.photos" :key="idx" class="relative h-20 bg-black rounded border border-slate-700 overflow-hidden group">
                                    <img :src="img" class="w-full h-full object-cover">
                                    <button @click="executionForm.photos.splice(idx,1)" class="absolute top-0 right-0 bg-black/50 text-white w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">×</button>
                                </div>
                            </div>
                        </div>

                         <div class="grid grid-cols-1 gap-3">
                            <div v-if="executionForm.has_violation || tempExecution.req_sign">
                                <label class="text-[10px] text-slate-500 block mb-1">Patrol Signature / 巡逻员签字</label>
                                <div class="ind-input p-3 text-center bg-slate-800/50 border border-slate-600 text-slate-400 text-xs italic">
                                    <i class="fas fa-fingerprint mr-1"></i> Signed by {{currentUser.name}} (Digital ID)
                                </div>
                            </div>
                            
                            <div v-if="executionForm.has_violation">
                                <label class="text-[10px] text-rose-400 block mb-1 font-bold">Person Involved Signature / 当事人签字 (Required)</label>
                                <div @click="openSigModal('target')" class="ind-input p-3 text-center cursor-pointer bg-slate-800 border-dashed border-rose-500/50 hover:bg-rose-500/10 transition">
                                    <span v-if="hasSignedTarget" class="text-emerald-500 font-bold"><i class="fas fa-signature mr-1"></i> SIGNED / 已签字</span>
                                    <span v-else class="text-rose-400">Click to Sign / 点击签字</span>
                                </div>
                            </div>
                            
                            <div v-if="!executionForm.has_violation && tempExecution.req_sign">
                                <label class="text-[10px] text-slate-500 block mb-1">Recipient Signature / 接收人签字</label>
                                <div @click="openSigModal('vendor')" class="ind-input p-3 text-center cursor-pointer bg-slate-800 border-dashed border-slate-500/50 hover:bg-slate-700/50 transition">
                                    <span v-if="hasSignedVendor" class="text-emerald-500 font-bold"><i class="fas fa-check mr-1"></i> SIGNED / 已签字</span>
                                    <span v-else class="text-slate-400">Click to Sign / 点击签字</span>
                                </div>
                            </div>
                        </div>
                     </div>
                     
                    <div class="pt-4 border-t border-slate-800 pb-6">
                        <button @click="submitExecution" 
                                :disabled="!checkTranslationStatus(executionForm.note) || 
                                           ((executionForm.has_violation || tempExecution.req_photo) && executionForm.photos.length===0) || 
                                           (executionForm.has_violation && (!hasSignedTarget || !executionForm.violation_type)) ||
                                           (!executionForm.has_violation && tempExecution.req_sign && !hasSignedVendor) || 
                                           isLoading" 
                                class="btn w-full py-4 shadow-lg transition-all text-xs font-bold tracking-wider hover:brightness-110"
                                :class="executionForm.has_violation ? 'btn-danger' : 'btn-primary'">
                            <i v-if="!checkTranslationStatus(executionForm.note) && !isLoading" class="fas fa-lock mr-2"></i>
                            <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                            {{ isLoading ? 'SUBMITTING...' : (!checkTranslationStatus(executionForm.note) ? 'TRANSLATE FIRST / 请先翻译' : (executionForm.has_violation ? 'SUBMIT SUPERVISION / 提交督查' : 'SUBMIT REPORT / 提交报告')) }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'reports'" class="pt-2 animate-fade-in">
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div class="kpi-card" @click="resetFilters">
                        <span class="text-3xl font-bold text-white">{{kpiStats.total}}</span>
                        <span class="text-[9px] text-slate-400 uppercase mt-1">Total Logs<br>全部记录</span>
                    </div>
                    <div class="kpi-card bg-rose-500/10 border-rose-500/30" @click="reportTab='incident'; renderChart()">
                        <span class="text-3xl font-bold text-rose-500">{{kpiStats.incidents}}</span>
                        <span class="text-[9px] text-rose-300 uppercase mt-1">Incidents<br>异常/违规</span>
                    </div>
                    <div class="kpi-card bg-amber-500/10 border-amber-500/30" @click="filters.status='pending'">
                        <span class="text-3xl font-bold text-amber-500">{{kpiStats.pending}}</span>
                        <span class="text-[9px] text-amber-300 uppercase mt-1">Pending<br>待处理</span>
                    </div>
                </div>

                <div v-if="kpiStats.incidents > 0" class="p-4 bg-slate-800 rounded-xl mb-4 border border-slate-700 shadow-sm animate-fade-in">
                    <h3 class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2"><i class="fas fa-chart-pie"></i> Analysis / 统计分析</h3>
                    <div class="h-40 relative">
                        <canvas id="incidentChart"></canvas>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-200">Records / 记录</h2>
                    <div class="flex gap-2">
                        <!-- 新增的 PDF 导出按钮 -->
                        <button class="text-xs text-rose-400 border border-rose-500/30 px-2 py-1 rounded hover:bg-rose-500/10 transition shadow-sm" @click="generateListPDF">
                            <i class="fas fa-file-pdf mr-1"></i> PDF
                        </button>
                        <button class="text-xs text-emerald-400 border border-emerald-500/30 px-2 py-1 rounded hover:bg-emerald-500/10 transition" @click="exportExcel">
                            <i class="fas fa-file-excel mr-1"></i> Excel
                        </button>
                        <button class="text-xs text-blue-400 border border-blue-500/30 px-2 py-1 rounded hover:bg-blue-500/10 transition" @click="showFilter=!showFilter">
                            <i class="fas fa-filter mr-1"></i> Filter / 筛选
                        </button>
                    </div>
                </div>
                
                <div class="tab-bar">
                    <button class="tab-btn tab-all" :class="reportTab==='all'?'active':''" @click="reportTab='all'">All / 全部</button>
                    <button class="tab-btn tab-patrol" :class="reportTab==='duty'?'active':''" @click="reportTab='duty'">Patrol / 勤务</button>
                    <button class="tab-btn tab-incident" :class="reportTab==='incident'?'active':''" @click="reportTab='incident'">Incident / 异常</button>
                    <button class="tab-btn tab-supervision" :class="reportTab==='supervision'?'active':''" @click="reportTab='supervision'">Inspect / 督查</button>
                </div>
                
                <div v-if="showFilter" class="p-4 bg-slate-800 rounded-xl border border-slate-700 mb-4 animate-fade-in shadow-lg">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="date" v-model="filters.start" class="ind-input text-xs">
                        <input type="date" v-model="filters.end" class="ind-input text-xs">
                    </div>
                    
                    <select v-model="filters.staff" class="ind-input text-xs mb-2">
                        <option value="">All Staff / 全部员工</option>
                        <option v-for="s in staffList" :value="s.login_id">{{s.name}}</option>
                    </select>
                    
                    <select v-model="filters.vendor" class="ind-input text-xs mb-2">
                        <option value="">All Companies / 全部公司</option>
                        <option v-for="c in config.companies" :value="c">{{c}}</option>
                    </select>
                    
                    <button @click="resetFilters" class="btn btn-ghost w-full py-1 text-[10px]">Reset Filters / 重置</button>
                </div>

                <div id="records-list-pdf-target" :class="{'pdf-export-mode': isExportingList}" class="pb-4 -mx-1 px-1 rounded">
                    
                    <div class="pdf-export-header">
                        <h2 class="text-lg font-bold text-white uppercase tracking-wider">KMC Security Operations Log</h2>
                        <p class="text-xs text-slate-400 font-mono">{{new Date().toISOString().substring(0,16).replace('T', ' ')}} • {{filteredSubmissions.length}} Records</p>
                    </div>

                    <div v-if="filteredSubmissions.length===0" class="text-center py-12 text-slate-600 border border-dashed border-slate-800 rounded-xl">
                        <p class="text-xs">No records found / 暂无记录</p>
                    </div>

                    <div v-for="sub in filteredSubmissions" :key="sub.id" class="ind-card log-card" :class="getLogCardClass(sub)">
                        <div class="p-3 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/30 cursor-pointer" @click="toggleExpand(sub.id)">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-300">{{sub.staff_name}}</span>
                                <span v-if="sub.type==='supervision'" class="text-[9px] font-bold px-2 py-0.5 rounded bg-blue-500 text-white uppercase shadow-sm">INSPECT</span>
                                <span v-if="sub.is_violation" class="text-[9px] font-bold px-2 py-0.5 rounded bg-rose-500 text-white uppercase shadow-sm">VIOLATION</span>
                            </div>
                            <span class="text-[10px] font-mono tabular-nums text-slate-400 tracking-wider">{{sub.time.substring(5,16)}}</span>
                        </div>
                        
                        <div class="p-3 pl-4" @click="toggleExpand(sub.id)">
                            <h4 class="text-sm font-bold text-slate-100 truncate mb-1">{{sub.title}}</h4>
                            
                            <div v-if="!expanded.includes(sub.id)" class="text-xs text-slate-500 truncate">
                                {{sub.note.split('\n')[0]}}... <span class="text-[9px] opacity-50 ml-1">(Click to expand)</span>
                            </div>

                            <div v-if="expanded.includes(sub.id)" class="mt-3 animate-fade-in border-t border-slate-700/50 pt-3">
                                <div class="grid grid-cols-2 gap-2 mb-3 text-[10px]">
                                    <div class="bg-slate-900/50 p-2 rounded border border-slate-700/30">
                                        <span class="text-slate-500 block mb-0.5">Log ID / 记录号</span>
                                        <span class="text-slate-300 font-mono">#{{sub.id}}</span>
                                    </div>
                                    <div class="bg-slate-900/50 p-2 rounded border border-slate-700/30">
                                        <span class="text-slate-500 block mb-0.5">Task Type / 任务类型</span>
                                        <span class="text-slate-300 uppercase">{{sub.type}}</span>
                                    </div>
                                </div>
                            
                                <div class="bg-slate-900/80 p-3 rounded-lg border border-slate-700/50 mb-3 relative">
                                    <span class="text-[9px] text-blue-400 font-bold uppercase mb-2 block border-b border-slate-700/50 pb-1">Details & Remarks / 详情描述</span>
                                    <p class="text-xs text-slate-300 font-mono whitespace-pre-wrap leading-relaxed">{{sub.note}}</p>
                                </div>
                                
                                <div v-if="sub.photos && sub.photos.length > 0" class="mb-3">
                                    <span class="text-[9px] text-emerald-400 font-bold uppercase mb-2 block border-b border-slate-700/50 pb-1">Evidence & Signatures / 证据与签字</span>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div v-for="(p, pi) in sub.photos" :key="pi" class="relative bg-white rounded border border-slate-600 overflow-hidden flex items-center justify-center min-h-[80px] cursor-zoom-in group" @click.stop="previewImage(p)">
                                            <img :src="p" class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-300">
                                            <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                <i class="fas fa-search-plus text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            
                                <div class="mt-4 flex justify-between items-center pt-3 border-t border-slate-700/30">
                                    <div class="flex gap-2 ml-auto">
                                        <span v-if="sub.status==='verified'" class="text-[10px] text-emerald-500 font-bold flex items-center bg-emerald-500/10 px-2 py-0.5 rounded-full"><i class="fas fa-check-circle mr-1"></i> Verified / 已审核</span>
                                        <span v-else-if="sub.status==='rejected'" class="text-[10px] text-rose-500 font-bold flex items-center bg-rose-500/10 px-2 py-0.5 rounded-full"><i class="fas fa-times-circle mr-1"></i> Rejected / 已驳回</span>
                                        <div v-else class="flex items-center gap-2">
                                            <span class="text-[10px] text-amber-500 flex items-center"><i class="fas fa-clock mr-1"></i> Pending / 待审核</span>
                                            <div v-if="isManagement" class="flex gap-1 ml-2 animate-fade-in export-hide">
                                                <button @click.stop="updateSubmissionStatus(sub, 'verified')" class="text-[10px] bg-emerald-600/20 text-emerald-400 border border-emerald-500/30 px-2 py-1 rounded hover:bg-emerald-500 hover:text-white transition shadow-sm"><i class="fas fa-check"></i> Approve</button>
                                                <button @click.stop="updateSubmissionStatus(sub, 'rejected')" class="text-[10px] bg-rose-600/20 text-rose-400 border border-rose-500/30 px-2 py-1 rounded hover:bg-rose-500 hover:text-white transition shadow-sm"><i class="fas fa-times"></i> Reject</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'team'" class="pt-2 animate-fade-in">
                <!-- ... existing team view ... (unchanged) -->
                <div class="mb-6"><h2 class="text-lg font-bold text-slate-200">Management / 管理</h2></div>
                
                <div class="ind-card p-5 bg-slate-800 mb-6 border-l-4 border-l-blue-500 relative overflow-hidden group cursor-pointer hover:bg-slate-750 transition" @click="currentView='config'">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-white">Config Center / 配置中心</h3>
                        <i class="fas fa-chevron-right text-slate-500 group-hover:translate-x-1 transition"></i>
                    </div>
                    <p class="text-[10px] text-slate-400 mb-4">Manage Companies & Points / 管理公司及点位</p>
                    <button class="btn btn-primary w-full py-2 text-xs">Enter / 进入</button>
                </div>

                <div v-if="isManagement" class="mb-6 animate-fade-in">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Staff Accounts / 员工账号</h3>
                    </div>
                    <div class="ind-card p-2 bg-slate-800/50 border border-slate-700 max-h-60 overflow-y-auto">
                        <div v-for="u in staffList" :key="u.id" class="flex justify-between items-center py-2 px-2 border-b border-slate-700/50 last:border-0 hover:bg-slate-700/30 transition rounded">
                            <div>
                                <div class="text-xs font-bold text-slate-200">{{u.name}} <span class="text-[9px] text-slate-500 font-normal ml-1">({{u.login_id}})</span></div>
                                <div class="text-[9px] text-slate-400 uppercase mt-0.5" :class="u.role!=='patrol'?'text-blue-400':''">{{u.role}} - {{u.team}}</div>
                            </div>
                            <button @click="openPwdModal(u)" class="text-[10px] bg-slate-700 border border-slate-600 px-2 py-1 rounded text-slate-300 hover:text-white hover:border-blue-500 transition shadow">
                                <i class="fas fa-key mr-1"></i> PWD
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Honor Boards / 荣誉榜</h3>
                        <button v-if="isManagement" @click="addRanking" class="text-[10px] bg-blue-600 px-2 py-1 rounded text-white shadow hover:bg-blue-500 transition">+ Add Board</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div v-for="(rank, idx) in config.manualRankings" :key="idx" class="ind-card p-3 border-l-4 shadow-sm" :class="getRankColor(idx)">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="text-xs font-bold mb-1 flex items-center" :class="getRankTextColor(idx)">
                                        <i class="fas mr-2" :class="getRankIcon(idx)"></i> {{rank.title}}
                                    </h4>
                                    <p class="text-[9px] text-slate-500 italic">{{rank.desc}}</p>
                                </div>
                                <div v-if="isManagement" class="flex gap-2">
                                     <button @click="editRanking(idx)" class="text-blue-400 text-xs hover:text-white transition"><i class="fas fa-edit"></i></button>
                                     <button @click="removeRanking(idx)" class="text-rose-400 text-xs hover:text-white transition"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <div v-for="(u, i) in rank.list" :key="i" class="flex justify-between items-center py-1 border-b border-slate-700/50 last:border-0">
                                <span class="text-xs text-slate-300">{{i+1}}. {{u.name}}</span>
                                <span class="text-xs font-mono font-bold text-white">{{u.val}}</span>
                            </div>
                            <div v-if="rank.list.length===0" class="text-[10px] text-slate-600 text-center py-2">No Records / 暂无记录</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="currentView === 'config'" class="pt-2 animate-fade-in">
                 <!-- ... config view ... (unchanged) -->
                 <div class="mb-6">
                    <h2 class="text-lg font-bold text-slate-200">Config Center / 配置中心</h2>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="ind-card h-fit">
                        <div class="p-3 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-xs font-bold text-blue-400 uppercase">1. Companies / 公司</h3>
                            <button @click="addCompanyPrompt" class="text-[10px] bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-500 transition">+ Add / 添加</button>
                        </div>
                        <div class="p-2 space-y-1 max-h-60 overflow-y-auto">
                            <div v-for="c in config.companies" :key="c" @click="selectedCompany=c" 
                                 class="p-3 rounded cursor-pointer border transition flex justify-between items-center" 
                                 :class="selectedCompany===c ? 'bg-blue-600/20 border-blue-500 text-white' : 'bg-slate-900 border-slate-800 text-slate-400 hover:bg-slate-800'">
                                <span class="text-xs font-bold">{{c}}</span>
                                <button v-if="selectedCompany!==c" @click.stop="removeCompany(c)" class="text-rose-500 hover:text-white px-2">×</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="selectedCompany" class="ind-card h-fit border-l-4 border-l-blue-500 animate-fade-in">
                        <div class="p-3 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-xs font-bold text-white uppercase">2. Points / 点位</h3>
                            <button @click="addPointPrompt" class="text-[10px] bg-emerald-600 text-white px-2 py-1 rounded hover:bg-emerald-500 transition">+ Add / 添加</button>
                        </div>
                        <div class="p-2 space-y-1 max-h-60 overflow-y-auto">
                            <div v-if="!config.pointsMap[selectedCompany] || config.pointsMap[selectedCompany].length===0" class="text-center py-4 text-xs text-slate-500 italic">No points yet / 暂无</div>
                            <div v-for="(p, idx) in config.pointsMap[selectedCompany]" :key="idx" class="p-2 bg-slate-900 border border-slate-800 rounded flex flex-col gap-1 group">
                                <div class="flex justify-between items-start">
                                    <span class="text-xs text-slate-200 font-bold leading-tight">{{p.name}}</span>
                                    <button @click="removePoint(idx)" class="text-rose-500 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                                </div>
                                <span class="text-[9px] text-slate-500 truncate">{{p.note}}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 space-y-3">
                    <button @click="resetToFactoryDefaults" class="btn btn-danger w-full py-3 text-xs tracking-wider font-bold">
                        <i class="fas fa-sync-alt mr-2"></i> Reset to Factory Defaults / 重置为出厂
                    </button>
                    <p class="text-center text-[9px] text-slate-600">This will restore the 2026-02 verified security points.</p>
                </div>
            </div>

            <div v-if="currentView === 'sos'" class="pt-4 animate-fade-in">
                 <!-- ... sos view ... (unchanged) -->
                 <div class="p-4 bg-rose-500/10 border-l-4 border-rose-500 mb-6 rounded-r flex justify-between items-start">
                    <div>
                        <h2 class="text-lg font-bold text-rose-500">SOS ALERT / 紧急求救</h2>
                        <p class="text-xs text-rose-300">Emergency Only / 仅限危险</p>
                    </div>
                    <button @click="showSosConfig = !showSosConfig" class="text-[10px] bg-slate-800 border border-slate-600 text-slate-300 px-2 py-1 rounded hover:text-white transition">
                        <i class="fas fa-cog mr-1"></i> Manage
                    </button>
                </div>

                <div v-if="showSosConfig" class="mb-6 p-4 bg-slate-800 border border-slate-700 rounded-xl animate-fade-in shadow-lg">
                    <h3 class="text-xs font-bold text-white mb-3">Manage SOS Types / 管理求救类型</h3>
                    <div class="flex gap-2 mb-3 relative">
                        <input v-model="newSosType" class="ind-input text-xs" :class="checkTranslationStatus(newSosType)?'has-translated':'need-translate'" placeholder="New Type (e.g. Snake) / 新类型">
                         <button @click="translateSimple(newSosType, (t)=>newSosType=t)" class="absolute right-1 top-1 bottom-1 px-2 text-slate-400 hover:text-white transition">
                            <i class="fas fa-language"></i>
                        </button>
                    </div>
                    <button @click="addSosType" :disabled="!newSosType || !checkTranslationStatus(newSosType)" class="btn btn-primary w-full py-2 mb-4 text-xs">
                        {{ !checkTranslationStatus(newSosType) ? 'Translate First / 请先翻译' : 'Add Type / 添加类型' }}
                    </button>
                    
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                        <div v-for="(type, idx) in config.sosTypes" :key="idx" class="flex justify-between items-center p-2 bg-slate-900 rounded border border-slate-800">
                            <span class="text-xs text-slate-300">{{type}}</span>
                            <button @click="removeSosType(idx)" class="text-rose-500 text-xs px-2 hover:text-white">×</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-5">
                    <select v-model="form.type" class="ind-input font-bold text-rose-500 h-12 bg-rose-500/5 border-rose-500/50">
                        <option v-for="t in config.sosTypes" :value="t">{{t}}</option>
                        <option value="other">Other / 其他 (Custom)</option>
                    </select>
                    
                    <div v-if="form.type === 'other'" class="relative animate-fade-in">
                        <input v-model="form.custom_type" class="ind-input border-rose-500/50" :class="checkTranslationStatus(form.custom_type)?'has-translated':'need-translate'" placeholder="Enter Emergency Type / 输入紧急类型">
                        <button @click="translate('custom_type', form)" :disabled="isLoading" class="absolute top-1.5 right-1.5 text-[10px] bg-slate-800 border border-slate-600 px-2 py-1 rounded text-slate-300 hover:text-white flex items-center gap-1 transition">
                            <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                            <i v-else class="fas fa-language"></i>
                            Translate
                        </button>
                    </div>

                    <div class="relative bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                        <div class="flex justify-between items-center bg-slate-900/50 px-3 py-2 border-b border-slate-700">
                            <span class="text-[9px] text-slate-400 font-bold uppercase">Details</span>
                            <button @click="translate('note', form)" :disabled="isLoading" 
                                    class="flex items-center gap-1.5 px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-[9px] font-bold transition-colors">
                                <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                                <i v-else class="fas fa-language"></i>
                                TRANSLATE / 翻译
                            </button>
                        </div>
                        <textarea v-model="form.note" class="w-full bg-transparent text-white text-xs p-3 h-32 outline-none resize-none" 
                                  :class="checkTranslationStatus(form.note)?'text-emerald-300':'text-slate-200'"
                                  placeholder="Details (Location, status...) / 详情 (位置，状况)..."></textarea>
                    </div>
                    
                    <button @click="submit('emergency')" class="btn btn-danger w-full py-4 shadow-lg text-xs font-bold tracking-widest animate-pulse" :disabled="!checkTranslationStatus(form.note) || isLoading || (form.type==='other' && (!form.custom_type || !checkTranslationStatus(form.custom_type)))">
                        <i v-if="!checkTranslationStatus(form.note) && !isLoading" class="fas fa-lock mr-2"></i>
                        <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ isLoading ? 'SENDING...' : (!checkTranslationStatus(form.note) ? 'TRANSLATE FIRST / 请先翻译' : 'SEND ALERT / 发送警报') }}
                    </button>
                </div>
            </div>

        </main>

        <nav v-if="!['task_form','config','sos', 'task_exec', 'inspection'].includes(currentView)" class="nav-bar no-print">
            <div class="nav-item" :class="{active: currentView==='tasks'}" @click="currentView='tasks'">
                <i class="fas fa-clipboard-list"></i>
                <span>Tasks / 任务</span>
            </div>
             <div class="nav-item" :class="{'active-inspect': currentView==='inspection'}" @click="openInspection">
                 <i class="fas fa-search-plus"></i>
                 <span>Inspect / 督察</span>
            </div>
            
            <div class="nav-item text-rose-500" :class="{active: currentView==='sos'}" @click="resetForm('sos'); currentView='sos'">
                <i class="fas fa-bolt"></i>
                <span>SOS</span>
            </div>
            <div class="nav-item" :class="{active: currentView==='reports'}" @click="currentView='reports'">
                <i class="fas fa-file-contract"></i>
                <span>Log / 记录</span>
            </div>
            <div v-if="isManagement" class="nav-item" :class="{active: currentView==='team'}" @click="currentView='team'">
                <i class="fas fa-users-gear"></i>
                <span>Team / 团队</span>
            </div>
        </nav>
    </div>

    <!-- ... (Modals and PDF Template remain unchanged for brevity but are included in final file) ... -->
    <div v-if="showSigModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                <span class="font-bold text-white"><i class="fas fa-file-signature mr-2 text-blue-500"></i>Signature / 签字</span>
                <button @click="closeSigModal" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="bg-white rounded h-40 mb-4 border border-dashed border-slate-500 relative shadow-inner overflow-hidden">
                <canvas id="signature-pad" class="w-full h-full cursor-crosshair"></canvas>
            </div>
            <div class="flex gap-4">
                <button @click="clearSignature" class="btn btn-ghost flex-1">Clear / 重写</button>
                <button @click="saveSignature" class="btn btn-success flex-1">Confirm / 确认</button>
            </div>
        </div>
    </div>
    
    <div v-if="showPwdModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                <span class="font-bold text-white"><i class="fas fa-key mr-2 text-blue-500"></i>Change Password / 修改密码</span>
                <button @click="showPwdModal = false" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Target Account / 目标账号</label>
                <div class="ind-input text-xs bg-slate-900 border-slate-700 text-slate-300 cursor-not-allowed">{{pwdForm.name}} ({{pwdForm.login_id}})</div>
            </div>

            <div class="mb-4">
                <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">New Password / 新密码 <span class="text-rose-500">*</span></label>
                <input type="password" v-model="pwdForm.new_pwd" class="ind-input text-xs tracking-widest text-center" placeholder="Enter new password / 输入新密码">
            </div>
            
            <div class="mb-6">
                <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Confirm Password / 确认密码 <span class="text-rose-500">*</span></label>
                <input type="password" v-model="pwdForm.confirm_pwd" class="ind-input text-xs tracking-widest text-center" placeholder="Confirm new password / 确认新密码">
            </div>

            <button @click="submitPasswordChange" :disabled="isLoading || !pwdForm.new_pwd || pwdForm.new_pwd !== pwdForm.confirm_pwd" class="btn btn-primary w-full py-3 text-xs tracking-wider shadow-lg">
                <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                {{ isLoading ? 'UPDATING...' : (pwdForm.new_pwd && pwdForm.new_pwd !== pwdForm.confirm_pwd ? 'PASSWORD MISMATCH / 密码不一致' : 'UPDATE PASSWORD / 更新密码') }}
            </button>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div v-if="previewImageUrl" class="modal-overlay" @click="previewImageUrl = null">
        <div class="max-w-full max-h-full p-4 relative animate-fade-in flex items-center justify-center">
            <button class="absolute top-2 right-2 text-white bg-black/60 rounded-full w-8 h-8 flex items-center justify-center hover:bg-rose-500 transition z-50" @click.stop="previewImageUrl = null">
                <i class="fas fa-times"></i>
            </button>
            <img :src="previewImageUrl" class="max-w-full max-h-[85vh] object-contain border-2 border-slate-700 shadow-2xl rounded bg-white" @click.stop>
        </div>
    </div>

    <!-- Official PDF Template -->
    <div id="pdf-template" class="pdf-container" :class="{'pdf-active': isGeneratingPDF}">
        <div v-if="pdfData" class="border-4 border-slate-800 p-8 font-sans bg-white text-slate-900 relative">
            
            <div class="flex justify-between items-center border-b-2 border-slate-800 pb-4 mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-14 h-14 bg-blue-600 rounded-lg flex items-center justify-center text-white text-3xl shadow"><i class="fas fa-shield-alt"></i></div>
                    <div>
                        <div class="text-3xl font-black uppercase tracking-wider text-slate-900">KMC Security</div>
                        <div class="text-sm text-slate-500 font-bold tracking-widest mt-1">OFFICIAL OPERATIONS REPORT</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-bold text-slate-800">Print Date: {{new Date().toISOString().substring(0,10)}}</div>
                    <div class="text-xs text-slate-500 font-mono mt-1">Ref: #{{pdfData.id}}-{{pdfData.time.substring(0,10).replace(/-/g,'')}}</div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-6 bg-slate-100 p-4 border-l-4 border-slate-800 shadow-sm">
                <h1 class="text-xl font-bold uppercase text-slate-800">{{pdfData.title}}</h1>
                <div class="px-4 py-1.5 font-bold text-sm border-2 rounded uppercase tracking-widest" :class="pdfData.status==='verified' ? 'border-emerald-500 text-emerald-600 bg-emerald-50' : (pdfData.status==='rejected' ? 'border-rose-500 text-rose-600 bg-rose-50' : 'border-amber-500 text-amber-600 bg-amber-50')">
                    {{pdfData.status}}
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div class="border border-slate-300 p-3 rounded bg-white">
                    <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">Incident / Report Time</div>
                    <div class="font-bold font-mono text-slate-800">{{pdfData.time.replace('T', ' ').substring(0,16)}}</div>
                </div>
                <div class="border border-slate-300 p-3 rounded bg-white">
                    <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">Reporting Officer</div>
                    <div class="font-bold text-slate-800">{{pdfData.staff_name}} <span class="text-slate-500 font-normal ml-1">({{pdfData.staff_id}})</span></div>
                </div>
                <div class="border border-slate-300 p-3 rounded bg-white">
                    <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">Report Category</div>
                    <div class="font-bold uppercase text-slate-800">{{pdfData.type}}</div>
                </div>
                <div class="border border-slate-300 p-3 rounded bg-white">
                    <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">Violation / Emergency Flag</div>
                    <div class="font-bold" :class="pdfData.is_violation || pdfData.type==='emergency' ? 'text-rose-600' : 'text-slate-800'">
                        {{(pdfData.is_violation || pdfData.type==='emergency') ? 'YES / 是 (Critical)' : 'NO / 否 (Routine)'}}
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <div class="text-xs font-bold bg-slate-800 text-white p-2.5 mb-2 uppercase rounded-t">Details & Remarks / 详情描述</div>
                <div class="p-4 border border-slate-300 min-h-[120px] whitespace-pre-wrap text-sm font-mono leading-relaxed bg-slate-50 rounded-b text-slate-800">{{pdfData.note}}</div>
            </div>

            <div v-if="pdfData.photos && pdfData.photos.length > 0" class="mb-6 html2pdf__page-break-before-if-needed">
                <div class="text-xs font-bold bg-slate-800 text-white p-2.5 mb-3 uppercase rounded-t">Evidence & Signatures / 证据及签字</div>
                <div class="grid grid-cols-2 gap-4 border border-slate-300 p-4 bg-slate-50 rounded-b">
                    <div v-for="(p, i) in pdfData.photos" :key="i" class="border-2 border-slate-200 p-2 rounded flex items-center justify-center bg-white h-56 shadow-sm">
                         <img :src="p" class="max-w-full max-h-full object-contain bg-white">
                    </div>
                </div>
            </div>

            <div class="mt-12 text-center text-[10px] text-slate-500 border-t-2 border-slate-800 pt-6">
                <strong>KMC SiteOps System V13.9</strong> - Security Operations Division<br>
                This is a computer-generated document. No signature is required for its validity unless physically signed above.<br>
                <span class="font-mono mt-1 block">CONFIDENTIAL / 内部机密文件</span>
            </div>
        </div>
    </div>
</div>

<script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://wwtkagzvdxgvcagwvvdz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3dGthZ3p2ZHhndmNhZ3d2dmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNjUxMzIsImV4cCI6MjA4NTY0MTEzMn0.uVRP7UKAOMSRHRVpzjK5s2TCreY7_RaerVdYcS0ZrX8';
    
    // Initialize Client
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Vue Composition API
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // User Session
            const currentUser = ref(null);
            const loginForm = ref({ id: '', password: '' });
            
            // UI State
            const currentView = ref('tasks');
            const isLoading = ref(false);
            const isGeneratingPDF = ref(false); 
            const isExportingList = ref(false); // [NEW] Added List Export State
            const expanded = ref([]); 
            
            // Data
            const staffList = ref([]);
            const tasks = ref([]);
            const submissions = ref([]);
            
            // Forms
            const tempTask = ref({ title:'', content:'', priority:'medium', is_temp:false, req_photo:false, req_sign:false });
            const executionForm = ref({ note: '', photos: [], has_violation: false, violation_type: '' });
            const inspectionForm = ref({ company: '', point: '', content: '', photos: [] });
            const form = ref({ type:'Car Accident', custom_type: '', note:'', photos:[] }); 
            
            // Config
            const selectedCompany = ref('');
            const showPointManager = ref(false);
            const newPointName = ref('');
            const showSosConfig = ref(false);
            const newSosType = ref('');
            const tempExecution = ref({});
            
            // Filters
            const showFilter = ref(false);
            const filters = ref({ start:'', end:'', vendor:'', staff: '', search:'', status: '' });
            const reportTab = ref('all');
            
            // Signature & Modals
            const showSigModal = ref(false);
            const sigTarget = ref(''); 
            const hasSignedVendor = ref(false);
            const hasSignedTarget = ref(false); 
            const hasSignedInspection = ref(false);
            const hasSignedInspectionTarget = ref(false);
            const showPwdModal = ref(false);
            const pwdForm = ref({ login_id: '', name: '', new_pwd: '', confirm_pwd: '' });

            // Task Mode & Visuals
            const taskMode = ref('routine');
            let chartInstance = null;
            const pdfData = ref(null);
            const previewImageUrl = ref(null);
            const previewImage = (url) => { previewImageUrl.value = url; };

            const nonFixedPresets = ['Package Pickup / 取快递', 'Visitor Escort / 访客护送', 'Emergency Drill / 应急演练', 'Traffic Control / 交通疏导', 'Equipment Check / 设备检查'];

            const factoryConfig = {
                companies: ['EASYRING SECURITY', 'SHOCK SECURITY', 'FOCUS SECURITY'],
                sosTypes: ['Car Accident / 车祸', 'Fire / 火灾', 'Intruder / 入侵', 'Medical / 医疗', 'Snake / 蛇患'],
                pointsMap: {
                    'EASYRING SECURITY': [{name: 'Phase I Plant', note: '24h check'}, {name: 'Phase II Plant', note: 'Check generators'}, {name: 'Main Gate', note: 'Check entry'}],
                    'SHOCK SECURITY': [{name: 'New Office', note: '24h shift'}, {name: 'South Boomgate', note: 'Check vehicles'}],
                    'FOCUS SECURITY': [{name: 'Single Cottage', note: 'Front Door'}, {name: 'Guest House', note: 'Night shift'}]
                },
                manualRankings: [
                    { title: 'Most Patrols', desc: 'Highest frequency', list: [{name:'Kudat', val:'150'}, {name:'EDWIN', val:'120'}] },
                    { title: 'Most Issues', desc: 'Safety hazards', list: [{name:'Kudat', val:'15'}] },
                    { title: 'Violations', desc: 'SOP violations', list: [] }
                ]
            };

            const config = ref(JSON.parse(localStorage.getItem('kmc_config_v13_9_manual')) || factoryConfig);
            if(!config.value.manualRankings) config.value.manualRankings = factoryConfig.manualRankings;
            
            watch(config, (newVal) => { localStorage.setItem('kmc_config_v13_9_manual', JSON.stringify(newVal)); }, { deep: true });
            watch(currentView, (val) => {
                if(val === 'reports') { nextTick(() => renderChart()); }
                else { if(chartInstance) { chartInstance.destroy(); chartInstance = null; } }
            });

            onMounted(() => {
                const storedUser = localStorage.getItem('kmc_user_session_v13');
                if (storedUser) currentUser.value = JSON.parse(storedUser);
                document.getElementById('app').style.display = 'block';
                fetchData();
            });

            const isManagement = computed(() => currentUser.value && ['admin', 'manager'].includes(currentUser.value.role));
            const internalStaff = computed(() => staffList.value.filter(u => u.role === 'patrol'));

            const sortedTasks = computed(() => {
                if(!currentUser.value) return [];
                let list = tasks.value.filter(t => t.active);
                if(!isManagement.value) {
                    list = list.filter(t => t.assigned_team === currentUser.value.team || t.assigned_to === currentUser.value.login_id);
                }
                return list.sort((a,b) => (a.priority==='high' ? -1 : 1));
            });

            const filteredSubmissions = computed(() => {
                let list = submissions.value;
                if(!isManagement.value) list = list.filter(s => s.staff_id === currentUser.value.login_id);
                if (reportTab.value === 'duty') list = list.filter(s => s.type === 'duty');
                else if (reportTab.value === 'incident') list = list.filter(s => s.type === 'emergency' || s.type === 'violation');
                else if (reportTab.value === 'supervision') list = list.filter(s => s.type === 'supervision'); 
                
                if(filters.value.vendor) list = list.filter(s => s.title && s.title.includes(filters.value.vendor));
                if(filters.value.staff) list = list.filter(s => s.staff_id === filters.value.staff);
                if(filters.value.status) list = list.filter(s => s.status === filters.value.status);
                if(filters.value.start && filters.value.end) {
                    const sTime = new Date(filters.value.start).getTime();
                    const eTime = new Date(filters.value.end).getTime() + 86400000;
                    list = list.filter(s => {
                        const t = new Date(s.time).getTime();
                        return t >= sTime && t < eTime;
                    });
                }
                return list;
            });

            const kpiStats = computed(() => {
                const total = filteredSubmissions.value.length;
                const incidents = filteredSubmissions.value.filter(s => s.type==='emergency' || s.type==='violation' || s.type==='supervision').length;
                const pending = filteredSubmissions.value.filter(s => s.status!=='verified').length;
                return { total, incidents, pending };
            });

            const renderChart = () => {
                const ctx = document.getElementById('incidentChart');
                if(!ctx) return;
                const counts = {};
                filteredSubmissions.value.forEach(s => {
                    if(s.type !== 'duty' || s.is_violation) {
                        let label = s.type === 'supervision' ? 'Supervision' : (s.is_violation ? 'Violation' : 'SOS');
                        counts[label] = (counts[label] || 0) + 1;
                    }
                });
                if(Object.keys(counts).length === 0) return;
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(counts),
                        datasets: [{ data: Object.values(counts), backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 10, font:{size:10} } } } }
                });
            };

            const exportExcel = () => {
                if(filteredSubmissions.value.length === 0) return alert('No data to export');
                const ws = XLSX.utils.json_to_sheet(filteredSubmissions.value.map(s => ({
                    ID: s.id, Date: s.time.replace('T', ' ').substring(0,16), Staff: s.staff_name,
                    Type: s.type, Title: s.title, Note: s.note, Status: s.status
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Report");
                XLSX.writeFile(wb, "KMC_Report.xlsx");
            };

            // === 核心优化功能：前端图片智能压缩逻辑 ===
            const compressImage = (file, maxWidth = 1024, quality = 0.7) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            // 压缩为较小体积的 JPEG
                            const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                            resolve(compressedBase64);
                        };
                        img.onerror = (e) => reject(e);
                    };
                    reader.onerror = (e) => reject(e);
                });
            };

            // === CRITICAL PDF FIX ===
            const generatePDF = (sub) => {
                if(isGeneratingPDF.value) return;

                const mainEl = document.querySelector('main');
                const mainScrollY = mainEl ? mainEl.scrollTop : 0;
                
                // 强制回到顶部，防止滚动偏移导致截取位置错误
                window.scrollTo(0, 0); 

                // 【核心修复】：暴力篡改 body 尺寸，骗过手机浏览器，防止由于屏幕窄导致的坐标切断
                const originStyles = {
                    w: document.body.style.width,
                    h: document.body.style.height,
                    ox: document.body.style.overflowX,
                    oy: document.body.style.overflowY
                };
                
                document.body.style.width = '800px';
                document.body.style.height = 'auto';
                document.body.style.overflowX = 'visible';
                document.body.style.overflowY = 'visible';

                isGeneratingPDF.value = true; 
                pdfData.value = sub; 

                nextTick(() => {
                    setTimeout(() => {
                        const element = document.getElementById('pdf-template');
                        const timeStr = sub.time ? sub.time.substring(0,10) : 'Date';

                        const opt = { 
                            margin: [20, 20, 20, 20], 
                            filename: `KMC_Report_${sub.id}_${timeStr}.pdf`, 
                            image: { type: 'jpeg', quality: 1.0 }, 
                            html2canvas: { 
                                scale: 2, 
                                useCORS: true, 
                                logging: false,
                                windowWidth: 800, // 锁定虚拟窗口宽度
                                x: 0, // 【解决切断】：强制从绝对 X 坐标 0 开始抓取！
                                y: 0, // 强制从绝对 Y 坐标 0 开始抓取！
                                scrollX: 0,
                                scrollY: 0
                            }, 
                            jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' },
                            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                        };

                        html2pdf().set(opt).from(element).save().then(() => { 
                            isGeneratingPDF.value = false; 
                            pdfData.value = null; 
                            
                            // 恢复现场原始样式
                            document.body.style.width = originStyles.w;
                            document.body.style.height = originStyles.h;
                            document.body.style.overflowX = originStyles.ox;
                            document.body.style.overflowY = originStyles.oy;
                            
                            nextTick(() => { if(mainEl) mainEl.scrollTop = mainScrollY; });
                        }).catch(err => { 
                            console.error("PDF Export Error:", err); 
                            isGeneratingPDF.value = false; 
                            pdfData.value = null; 
                            
                            // 报错也要恢复现场，防止页面卡死
                            document.body.style.width = originStyles.w;
                            document.body.style.height = originStyles.h;
                            document.body.style.overflowX = originStyles.ox;
                            document.body.style.overflowY = originStyles.oy;
                            
                            nextTick(() => { if(mainEl) mainEl.scrollTop = mainScrollY; });
                            alert('PDF Generation Failed / PDF生成失败'); 
                        });
                    }, 800); 
                });
            };
            
            // 新增：自动展开详情并导出完整界面的所见即所得PDF功能 (A4适配优化版)
            const generateListPDF = () => {
                if(isExportingList.value || isGeneratingPDF.value) return;
                if(filteredSubmissions.value.length === 0) return alert('No data to export / 暂无数据');

                isExportingList.value = true;
                
                // 1. 自动展开所有列表项
                const originalExpanded = [...expanded.value];
                expanded.value = filteredSubmissions.value.map(s => s.id);

                const mainEl = document.querySelector('main');
                const mainScrollY = mainEl ? mainEl.scrollTop : 0;
                window.scrollTo(0, 0); 

                nextTick(() => {
                    // 等待渲染
                    setTimeout(() => {
                        const element = document.getElementById('records-list-pdf-target');
                        if (!element) {
                            isExportingList.value = false;
                            return alert("Element not found");
                        }

                        // 局部固定元素宽度，确保暗黑模式背景填充
                        const originalWidth = element.style.width;
                        const originalMaxWidth = element.style.maxWidth;
                        // 600px 在 A4 纸上打印时宽度比较合适
                        element.style.width = '800px';
                        element.style.maxWidth = '800px';
                        element.style.backgroundColor = '#ffffff'; 

                        const timeStr = new Date().toISOString().substring(0,10);

                        const opt = { 
                            // 【优化点1】减小边距，留出更多打印空间 (上, 右, 下, 左) 单位mm
                            margin: [10, 8, 10, 8], 
                            filename: `KMC_Records_List_${timeStr}.pdf`, 
                            image: { type: 'jpeg', quality: 0.98 }, // 提高一点图片质量
                            html2canvas: { 
                                // 【优化点2】将缩放比设为 1.5。比 1 更清晰，比 2 更稳定。
                                scale: 1.5, 
                                useCORS: true, 
                                logging: false,
                                windowWidth: 800, // 锁定截屏窗口宽度
                                backgroundColor: '#ffffff' // 【修改】截屏背景强制为纯白
                            }, 
                            // 【优化点3】使用 mm 作为单位更利于打印排版
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
                            // 允许 CSS 控制分页 (配合第一步的 page-break-inside: avoid)
                            pagebreak: { mode: ['css', 'legacy'] } 
                        };

                        html2pdf().set(opt).from(element).save().then(() => { 
                            // 恢复现场
                            element.style.width = originalWidth;
                            element.style.maxWidth = originalMaxWidth;
                            element.style.backgroundColor = '';
                            
                            isExportingList.value = false; 
                            expanded.value = originalExpanded; 
                            
                            nextTick(() => { if(mainEl) mainEl.scrollTop = mainScrollY; });
                        }).catch(err => { 
                            console.error("PDF Export Error:", err); 
                            // 恢复现场
                            element.style.width = originalWidth;
                            element.style.maxWidth = originalMaxWidth;
                            element.style.backgroundColor = '';
                            
                            isExportingList.value = false; 
                            expanded.value = originalExpanded;
                            
                            nextTick(() => { if(mainEl) mainEl.scrollTop = mainScrollY; });
                            alert('PDF Generation Failed / PDF生成失败'); 
                        });
                    }, 1500); // 等待时间加长
                });
            };

            const resetFilters = () => { filters.value = {start:'',end:'',vendor:'',staff:'',search:'', status:''}; reportTab.value='all'; renderChart(); };

            const handleLogin = async () => {
                if (isLoading.value) return;
                isLoading.value = true;
                try {
                    await new Promise(r => setTimeout(r, 800));
                    const u = staffList.value.find(x => x.login_id === loginForm.value.id && x.password === loginForm.value.password);
                    if(u) { currentUser.value = u; localStorage.setItem('kmc_user_session_v13', JSON.stringify(u)); currentView.value = 'tasks'; }
                    else alert('Login Failed');
                } finally { isLoading.value = false; }
            };
            
            const logout = () => { if(confirm('Exit System?')) { currentUser.value = null; loginForm.value.password = ''; localStorage.removeItem('kmc_user_session_v13'); } };
            const goBack = () => { currentView.value = 'tasks'; };

            const checkTranslationStatus = (text) => { if(!text) return false; return (text.includes('(') && text.includes(')')) || /^[\x00-\x7F]*$/.test(text); };
            
            const translate = async (field, obj) => {
                const text = obj[field]; if(!text) return;
                isLoading.value = true;
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|zh-CN`);
                    const data = await res.json();
                    if(data.responseData.translatedText) obj[field] = `${text} (${data.responseData.translatedText})`;
                } catch(e) { alert('Service Busy'); } finally { isLoading.value = false; }
            };
            
            const translateSimple = async (text, callback) => {
                if(!text) return; isLoading.value = true;
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|zh-CN`);
                    const data = await res.json();
                    if(data.responseData.translatedText) callback(`${text} (${data.responseData.translatedText})`);
                } finally { isLoading.value = false; }
            };

            const getLogCardClass = (sub) => {
                if(sub.type === 'supervision') return 'type-inspect';
                if(sub.type === 'duty') return sub.title && sub.title.includes('Task Exec:') && !isPredefinedTitle(sub.title) ? 'type-temp' : 'type-routine';
                if(sub.type === 'emergency' || sub.type === 'violation') return 'type-sos';
                return 'type-routine';
            };

            const isPredefinedTitle = (title) => {
                if(!title) return false;
                const clean = title.replace('Task Exec: ', '');
                for(const c in config.value.pointsMap) { if(config.value.pointsMap[c].some(p => p.name === clean)) return true; }
                return false;
            };

            const toggleExpand = (id) => { if(expanded.value.includes(id)) expanded.value = expanded.value.filter(i=>i!==id); else expanded.value.push(id); };
            const formatDate = (d) => d ? d.replace('T', ' ') : '';

            const fetchData = async () => {
                try {
                    const { data: s } = await _supabase.from('kmc_staff').select('*'); 
                    if(s) staffList.value = s;
                    const newPatrols = ['EDWIN', 'Gweme', 'Clement', 'FRED', 'ADMIRE', 'DEREK', 'LEVIOUS', 'SOFT', 'EDWELL', 'READY'];
                    newPatrols.forEach((name, index) => {
                        if(!staffList.value.some(u => u.name === name)) {
                            staffList.value.push({ id: 'auto_' + index, login_id: name, name: name, password: '0000', role: 'patrol', team: 'Internal' });
                        }
                    });
                    const { data: t } = await _supabase.from('kmc_tasks').select('*'); if(t) tasks.value = t;
                    const { data: sub } = await _supabase.from('kmc_submissions').select('*').limit(50).order('id', {ascending:false}); if(sub) submissions.value = sub;
                } catch(e) { console.error("Fetch Error", e); }
            };

            const saveTask = async (task, quick) => {
                if(isLoading.value) return; if(!quick) isLoading.value = true;
                try {
                    const payload = {...task};
                    if(task.id) await _supabase.from('kmc_tasks').update(payload).eq('id', task.id);
                    else await _supabase.from('kmc_tasks').insert([payload]);
                    if(!quick) { currentView.value='tasks'; fetchData(); }
                } catch(e) { alert('Save Failed'); } finally { isLoading.value = false; }
            };
            
            const deleteTask = async (id) => { if(confirm('Delete Task?')) await _supabase.from('kmc_tasks').delete().eq('id', id); fetchData(); };
            
            const submit = async (type) => {
                if(isLoading.value) return; isLoading.value = true;
                let finalTitle = 'SOS: ' + form.value.type;
                if(form.value.type === 'other') {
                    if(!form.value.custom_type) { alert('Please enter type'); isLoading.value = false; return; }
                    finalTitle = 'SOS: ' + form.value.custom_type;
                }
                try {
                    await _supabase.from('kmc_submissions').insert([{
                        type: type, title: finalTitle, note: form.value.note,
                        staff_name: currentUser.value.name, staff_id: currentUser.value.login_id,
                        time: new Date().toISOString(), status: 'pending'
                    }]);
                    alert('Sent'); currentView.value='reports'; fetchData();
                } catch(e) { alert('Failed'); } finally { isLoading.value = false; }
            };

            const editTask = (t) => {
                tempTask.value = t ? {...t} : {priority:'medium', active:true, is_temp:false, req_photo:false, req_sign:false};
                taskMode.value = (t && t.is_temp) ? 'temp' : 'routine';
                currentView.value = 'task_form';
            };
            
            const resetForm = (t) => { form.value = {type:'Car Accident', custom_type: '', note:'', photos:[]}; };
            
            const updateSubmissionStatus = async (sub, newStatus) => {
                if (isLoading.value) return;
                isLoading.value = true;
                try {
                    const { error } = await _supabase.from('kmc_submissions').update({ status: newStatus }).eq('id', sub.id);
                    if (error) throw error;
                    sub.status = newStatus;
                } catch (e) { alert('Status Update Failed: ' + e.message); } finally { isLoading.value = false; }
            };
            
            const openPwdModal = (user) => {
                pwdForm.value = { login_id: user.login_id, name: user.name, new_pwd: '', confirm_pwd: '' };
                showPwdModal.value = true;
            };

            const submitPasswordChange = async () => {
                if (pwdForm.value.new_pwd !== pwdForm.value.confirm_pwd || isLoading.value) return;
                isLoading.value = true;
                try {
                    const { error } = await _supabase.from('kmc_staff').update({ password: pwdForm.value.new_pwd }).eq('login_id', pwdForm.value.login_id);
                    if (error) throw error;
                    const staffIndex = staffList.value.findIndex(u => u.login_id === pwdForm.value.login_id);
                    if (staffIndex !== -1) staffList.value[staffIndex].password = pwdForm.value.new_pwd;
                    if (currentUser.value.login_id === pwdForm.value.login_id) {
                        currentUser.value.password = pwdForm.value.new_pwd;
                        localStorage.setItem('kmc_user_session_v13', JSON.stringify(currentUser.value));
                    }
                    alert('Password Updated'); showPwdModal.value = false;
                } catch (e) { alert('Update Failed: ' + e.message); } finally { isLoading.value = false; }
            };

            const addCompanyPrompt = () => { const name = prompt("New Company:"); if(name) { config.value.companies.push(name); config.value.pointsMap[name] = []; } };
            const removeCompany = (c) => { if(confirm("Delete Company?")) { config.value.companies = config.value.companies.filter(i=>i!==c); delete config.value.pointsMap[c]; } };
            const addPointPrompt = () => { const name = prompt("Point Name:"); if(name) config.value.pointsMap[selectedCompany.value].push({name: name, note: 'Routine Check'}); };
            const removePoint = (idx) => { if(confirm("Delete Point?")) config.value.pointsMap[selectedCompany.value].splice(idx, 1); };
            const resetToFactoryDefaults = () => { if(confirm("Reset to Defaults?")) config.value = JSON.parse(JSON.stringify(factoryConfig)); };
            const addSosType = () => { if(newSosType.value) { config.value.sosTypes.push(newSosType.value); newSosType.value = ''; } };
            const removeSosType = (idx) => { if(confirm("Delete?")) config.value.sosTypes.splice(idx, 1); };

            const addRanking = () => { const title = prompt("Ranking Title:"); if(title) config.value.manualRankings.push({ title: title, desc: 'Description...', list: [] }); };
            const editRanking = (idx) => {
                const r = config.value.manualRankings[idx];
                const newTitle = prompt("Edit Title:", r.title); if(newTitle) r.title = newTitle;
                const newDesc = prompt("Edit Description:", r.desc); if(newDesc) r.desc = newDesc;
                const action = prompt("Type 'add' or 'clear'");
                if(action === 'add') { const name = prompt("Name:"); const val = prompt("Value:"); if(name && val) r.list.push({name, val}); } 
                else if (action === 'clear') { r.list = []; }
            };
            const removeRanking = (idx) => { if(confirm("Remove?")) config.value.manualRankings.splice(idx,1); };
            const getRankColor = (idx) => ['border-l-emerald-500', 'border-l-blue-500', 'border-l-rose-500', 'border-l-amber-500'][idx % 4];
            const getRankTextColor = (idx) => ['text-emerald-400', 'text-blue-400', 'text-rose-400', 'text-amber-400'][idx % 4];
            const getRankIcon = (idx) => ['fa-award', 'fa-search', 'fa-thumbs-down', 'fa-star'][idx % 4];

            const quickAddPoint = () => {
                if(newPointName.value && tempTask.value.assigned_team) {
                    if(!config.value.pointsMap[tempTask.value.assigned_team]) config.value.pointsMap[tempTask.value.assigned_team] = [];
                    config.value.pointsMap[tempTask.value.assigned_team].push({name: newPointName.value, note: 'Added via Task Form'});
                    newPointName.value = '';
                }
            };
            const quickRemovePoint = (idx) => { if(confirm("Delete?")) config.value.pointsMap[tempTask.value.assigned_team].splice(idx, 1); };
            const autoFillContent = () => {
                if(tempTask.value.assigned_team && tempTask.value.title) {
                    const pts = config.value.pointsMap[tempTask.value.assigned_team];
                    const p = pts.find(x => x.name === tempTask.value.title);
                    if(p) tempTask.value.content = p.note;
                }
            };

            let canvas, ctx;
            const openSigModal = (target) => {
                sigTarget.value = target; showSigModal.value = true;
                nextTick(() => {
                    canvas = document.getElementById('signature-pad'); ctx = canvas.getContext('2d');
                    canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight;
                    ctx.lineWidth = 2; ctx.strokeStyle = "#000"; ctx.fillStyle = "#fff"; ctx.fillRect(0,0, canvas.width, canvas.height);
                    let drawing = false;
                    canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
                    canvas.onmousemove = (e) => { if(drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
                    canvas.onmouseup = () => drawing = false;
                    canvas.ontouchstart = (e) => { e.preventDefault(); drawing = true; const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top); };
                    canvas.ontouchmove = (e) => { e.preventDefault(); if(drawing) { const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top); ctx.stroke(); } };
                    canvas.ontouchend = () => drawing = false;
                });
            };
            const closeSigModal = () => showSigModal.value = false;
            const clearSignature = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "#fff"; ctx.fillRect(0,0, canvas.width, canvas.height); };
            const saveSignature = () => { 
                const dataUrl = canvas.toDataURL(); 
                if(sigTarget.value === 'vendor') { hasSignedVendor.value = true; executionForm.value.photos.push(dataUrl); } 
                else if(sigTarget.value === 'target') { hasSignedTarget.value = true; executionForm.value.photos.push(dataUrl); }
                else if(sigTarget.value === 'inspection') { hasSignedInspection.value = true; inspectionForm.value.photos.push(dataUrl); }
                else if(sigTarget.value === 'inspection_target') { hasSignedInspectionTarget.value = true; inspectionForm.value.photos.push(dataUrl); }
                closeSigModal(); 
            };

            const goToExec = (task) => {
                tempExecution.value = task;
                executionForm.value = { note: '', photos: [], has_violation: false, violation_type: '' };
                hasSignedVendor.value = false; hasSignedTarget.value = false;
                currentView.value = 'task_exec';
            };
            
            // --- 优化更新位置：使用智能压缩方法处理执行任务的照片 ---
            const handlePhotoUploadExec = async (e) => {
                const file = e.target.files[0]; if (!file) return;
                try {
                    const compressedBase64 = await compressImage(file, 1024, 0.7);
                    executionForm.value.photos.push(compressedBase64);
                } catch (err) {
                    console.error("Image compression error", err);
                    alert("图片处理失败，请重试 / Image processing failed");
                }
            };
            
            const submitExecution = async () => {
                if(isLoading.value) return; isLoading.value = true;
                try {
                    const isSupervision = executionForm.value.has_violation;
                    await _supabase.from('kmc_submissions').insert([{
                        type: isSupervision ? 'supervision' : 'duty',
                        title: 'Task Exec: ' + tempExecution.value.title,
                        note: executionForm.value.note + (isSupervision ? `\n[VIOLATION: ${executionForm.value.violation_type}]` : ''),
                        is_violation: executionForm.value.has_violation,
                        staff_name: currentUser.value.name, staff_id: currentUser.value.login_id,
                        time: new Date().toISOString(), status: 'pending', photos: executionForm.value.photos
                    }]);
                    alert('Done'); currentView.value = 'tasks'; fetchData();
                } catch(e) { alert('Error: ' + e.message); } finally { isLoading.value = false; }
            };

            const openInspection = () => {
                inspectionForm.value = { company: '', point: '', content: '', photos: [] };
                hasSignedInspection.value = false; hasSignedInspectionTarget.value = false;
                currentView.value = 'inspection';
            };
            
            // --- 优化更新位置：使用智能压缩方法处理督察任务的照片 ---
            const handleInspectionPhoto = async (e) => {
                const file = e.target.files[0]; if (!file) return;
                try {
                    const compressedBase64 = await compressImage(file, 1024, 0.7);
                    inspectionForm.value.photos.push(compressedBase64);
                } catch (err) {
                    console.error("Image compression error", err);
                    alert("图片处理失败，请重试 / Image processing failed");
                }
            };
            
            const submitInspection = async () => {
                if(isLoading.value) return; isLoading.value = true;
                try {
                    await _supabase.from('kmc_submissions').insert([{
                        type: 'supervision',
                        title: `Supervision: ${inspectionForm.value.company} - ${inspectionForm.value.point || 'General'}`,
                        note: inspectionForm.value.content,
                        staff_name: currentUser.value.name, staff_id: currentUser.value.login_id,
                        time: new Date().toISOString(), status: 'pending', photos: inspectionForm.value.photos
                    }]);
                    alert('Submitted'); currentView.value = 'reports'; fetchData();
                } catch(e) { alert('Error: ' + e.message); } finally { isLoading.value = false; }
            };

            return {
                currentUser, loginForm, currentView, staffList, sortedTasks, submissions, expanded, isManagement, 
                tempTask, form, config, selectedCompany, tempExecution, executionForm, showFilter, filters, filteredSubmissions,
                taskMode, reportTab, showSigModal, hasSignedVendor, hasSignedTarget, isLoading, internalStaff, nonFixedPresets, showSosConfig, newSosType,
                inspectionForm, hasSignedInspection, hasSignedInspectionTarget, kpiStats, pdfData, showPointManager, newPointName,
                showPwdModal, pwdForm, previewImageUrl, previewImage, isGeneratingPDF,
                isExportingList, generateListPDF, // <--- 在此处添加
                handleLogin, logout, goBack, fetchData, toggleExpand, formatDate, checkTranslationStatus, translate, translateSimple,
                addCompanyPrompt, removeCompany, addPointPrompt, removePoint, resetToFactoryDefaults, addSosType, removeSosType,
                autoFillContent, isPredefinedTitle, getLogCardClass, saveTask, deleteTask, editTask, submit, resetForm, goToExec, handlePhotoUploadExec, submitExecution,
                openSigModal, closeSigModal, clearSignature, saveSignature, openInspection, handleInspectionPhoto, submitInspection,
                renderChart, resetFilters, exportExcel, generatePDF, updateSubmissionStatus,
                addRanking, editRanking, removeRanking, getRankColor, getRankTextColor, getRankIcon, quickAddPoint, quickRemovePoint,
                openPwdModal, submitPasswordChange
            };
        }
    }).mount('#app');
</script>
</body>
</html>
