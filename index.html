<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- === PWA 配置核心 === -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KMC Ops">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2766/2766308.png">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="KMC Security Operations Management System - Bilingual Edition">
    
    <title>KMC SiteOps V15.0 (Full Integrated)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- 使用最新版 html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================
           KMC SiteOps V15.0 — UI Refined Edition
           包含：完整业务逻辑 + PDF 修复 + 样式优化
           ============================================ */

        /* 1. CSS VARIABLES & ROOT SETTINGS */
        :root {
            --bg-body: #0b1120;
            --bg-card: #151d30;
            --bg-input: #0d1526;
            --border: #1f2b42;
            --border-light: #293a57;
            --text: #e4e9f1;
            --text-sub: #8495b3;
            --text-hint: #4e5f7a;
            --primary: #5b8def;
            --primary-glow: rgba(91, 141, 239, 0.12);
            --success: #34d399;
            --danger: #f06b81;
            --warning: #f5b731;
            --inspect: #a78bfa;
            color-scheme: dark;
        }

        input[type="date"].ind-input { color: var(--text-sub); text-transform: uppercase; }
        input[type="date"].ind-input.has-value { color: var(--text); border-color: rgba(91,141,239,0.4); }
        select.ind-input option { background-color: var(--bg-body); color: var(--text); }

        /* 2. GLOBAL — 放松行高 / 字体平滑 */
        * { box-sizing: border-box; }
        body {
            background-color: var(--bg-body);
            color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            width: 100%; height: 100%;
            line-height: 1.7;
            letter-spacing: 0.01em;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }
        .app-container {
            max-width: 520px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--bg-body);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 3. CARDS — 大圆角 / 柔影 */
        .ind-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 16px rgba(0,0,0,0.22);
            transition: all 0.25s ease;
            position: relative;
        }
        .ind-card:active { transform: scale(0.98); }

        .log-card {
            border: 1px solid rgba(255,255,255,0.04);
            background: rgba(21, 29, 48, 0.75);
            backdrop-filter: blur(16px);
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(0,0,0,0.28);
            margin-bottom: 16px;
        }
        .log-card::before {
            content: ''; position: absolute;
            left: 0; top: 0; bottom: 0; width: 3px; z-index: 10;
        }
        .log-card.type-routine::before { background: var(--primary); box-shadow: 0 0 14px rgba(91,141,239,0.45); }
        .log-card.type-temp::before   { background: var(--warning); box-shadow: 0 0 14px rgba(245,183,49,0.45); }
        .log-card.type-sos::before    { background: var(--danger);  box-shadow: 0 0 14px rgba(240,107,129,0.45); }
        .log-card.type-inspect::before{ background: var(--inspect); box-shadow: 0 0 14px rgba(167,139,250,0.45); }
        .log-card .border-b { border-color: rgba(255,255,255,0.04) !important; }
        .log-card .bg-slate-800\/30 { background-color: transparent !important; }

        /* 4. INPUTS — 更大内距 */
        .ind-input {
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 12px;
            width: 100%;
            padding: 15px 16px;
            transition: all 0.3s ease;
            font-size: 13.5px;
            line-height: 1.55;
            outline: none;
            box-sizing: border-box;
        }
        .ind-input:focus {
            border-color: var(--primary);
            background-color: #101b32;
            box-shadow: 0 0 0 3px var(--primary-glow);
        }
        .ind-input::placeholder { color: var(--text-hint); font-style: normal; }
        textarea.ind-input { resize: none; line-height: 1.75; }

        /* 5. BUTTONS — 圆润质感 */
        .btn {
            font-weight: 600;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            padding: 14px 18px;
            font-size: 11.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            letter-spacing: 0.5px;
            gap: 7px;
        }
        .btn:active { transform: scale(0.96); }
        .btn:disabled, .btn.disabled { opacity: 0.45; filter: grayscale(0.7); cursor: not-allowed; pointer-events: none; }

        .btn-primary {
            background: linear-gradient(135deg, #5b8def 0%, #3b6fd9 100%);
            color: white;
            border: 1px solid rgba(91,141,239,0.25);
            box-shadow: 0 4px 18px -4px rgba(91,141,239,0.35), inset 0 1px 0 rgba(255,255,255,0.12);
        }
        .btn-primary:hover { box-shadow: 0 6px 22px -4px rgba(91,141,239,0.5); filter: brightness(1.06); }

        .btn-danger {
            background: linear-gradient(135deg, #f06b81 0%, #dc4060 100%);
            color: white;
            border: 1px solid rgba(240,107,129,0.25);
            box-shadow: 0 4px 18px -4px rgba(240,107,129,0.35), inset 0 1px 0 rgba(255,255,255,0.12);
        }
        .btn-danger:hover { filter: brightness(1.06); }

        .btn-temp {
            background: linear-gradient(135deg, #f5b731 0%, #e09d15 100%);
            color: #fff;
            border: 1px solid rgba(245,183,49,0.25);
            box-shadow: 0 4px 18px -4px rgba(245,183,49,0.35), inset 0 1px 0 rgba(255,255,255,0.12);
        }

        .btn-success { background: linear-gradient(135deg, #34d399, #10b981); color: white; border: 1px solid rgba(52,211,153,0.25); }
        .btn-inspect { background: var(--bg-card); color: var(--text); border: 1px solid var(--border-light); }
        .btn-ghost { border: 1px solid var(--border); color: var(--text-sub); background: transparent; border-radius: 10px; }
        .btn-ghost:hover { background: rgba(255,255,255,0.04); color: var(--text); }

        /* 6. NAVIGATION — 精致 */
        .header-bar {
            padding: 16px 20px;
            background: rgba(11, 17, 32, 0.92);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(20px) saturate(1.2);
        }
        .nav-bar {
            display: flex;
            background: rgba(11, 17, 32, 0.95);
            border-top: 1px solid var(--border);
            position: fixed; bottom: 0; left: 0; right: 0;
            max-width: 520px;
            margin: 0 auto; z-index: 50;
            padding: 2px 4px;
            padding-bottom: env(safe-area-inset-bottom);
            backdrop-filter: blur(20px);
        }
        .nav-item {
            flex: 1;
            padding: 10px 0 8px;
            color: var(--text-hint);
            font-size: 9.5px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
            gap: 4px;
            transition: all 0.2s;
            border-radius: 10px;
            margin: 3px 2px;
        }
        .nav-item i { font-size: 17px; }
        .nav-item.active { color: var(--primary); background: var(--primary-glow); }
        .nav-item.active-inspect { color: var(--inspect); background: rgba(167,139,250,0.1); }

        /* 7. TABS — 药片形 */
        .tab-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 18px; scrollbar-width: none; }
        .tab-bar::-webkit-scrollbar { display: none; }
        .tab-btn {
            white-space: nowrap; padding: 9px 18px; border-radius: 99px;
            font-size: 11px; font-weight: 600;
            background: var(--bg-card); color: var(--text-sub);
            border: 1px solid var(--border); transition: all 0.25s; cursor: pointer;
        }
        .tab-btn:hover { border-color: var(--border-light); color: var(--text); }
        .tab-btn.tab-all.active { background: var(--border-light); color: white; border-color: transparent; }
        .tab-btn.tab-patrol.active { background: linear-gradient(135deg,#5b8def,#3b6fd9); color: white; border-color: transparent; box-shadow: 0 0 14px rgba(91,141,239,0.3); }
        .tab-btn.tab-incident.active { background: linear-gradient(135deg,#f06b81,#dc4060); color: white; border-color: transparent; box-shadow: 0 0 14px rgba(240,107,129,0.3); }
        .tab-btn.tab-supervision.active { background: linear-gradient(135deg,#a78bfa,#7c5ce0); color: white; border-color: transparent; box-shadow: 0 0 14px rgba(167,139,250,0.3); }

        /* 8. UTILITIES */
        .need-translate { border: 1px dashed var(--danger) !important; background: rgba(240,107,129,0.04) !important; }
        .has-translated { border: 1px solid var(--success) !important; background: rgba(52,211,153,0.04) !important; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .content-collapsed { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; opacity: 0.6; }
        .content-expanded { display: block; opacity: 1; }
        #signature-pad { touch-action: none; background-color: #fff; border-radius: 8px; }

        /* 功能说明卡片 */
        .guide-tip {
            padding: 14px 16px;
            border-radius: 14px;
            margin-bottom: 18px;
            font-size: 11.5px;
            line-height: 1.8;
            color: var(--text-sub);
        }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(5,8,18,0.92); z-index: 100;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--bg-card); width: 100%; max-width: 440px;
            border-radius: 20px; padding: 28px;
            border: 1px solid var(--border-light); max-height: 85vh; overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
            animation: modalPop 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop { 0% { transform: scale(0.92); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Mode Cards */
        .mode-card {
            cursor: pointer; border: 2px solid var(--border); background: var(--bg-card);
            border-radius: 16px; padding: 24px;
            text-align: center; transition: all 0.25s; opacity: 0.55;
        }
        .mode-card:hover { opacity: 0.75; }
        .mode-card.active { opacity: 1; border-color: var(--primary); background: var(--primary-glow); transform: scale(1.02); box-shadow: 0 0 20px rgba(91,141,239,0.15); }
        .mode-card.active-temp { opacity: 1; border-color: var(--warning); background: rgba(245,183,49,0.08); transform: scale(1.02); box-shadow: 0 0 20px rgba(245,183,49,0.15); }

        /* KPI Dashboard */
        .kpi-card {
            background: linear-gradient(145deg, var(--bg-card) 0%, var(--bg-body) 100%);
            border: 1px solid var(--border); border-radius: 16px; padding: 18px 14px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; transition: all 0.15s;
            position: relative; overflow: hidden;
        }
        .kpi-card:active { transform: scale(0.95); }

        /* ==========================================================================
           PDF 打印专用样式 (CSS For Fixed PDF Generation)
           ========================================================================== */
        
        /* 隐藏的渲染区域 - 不在屏幕上显示，但 DOM 存在以便 html2canvas 捕捉 */
        .pdf-render-zone {
            position: fixed !important;
            top: 0 !important;
            left: -9999px !important; /* 移出屏幕 */
            z-index: 200000 !important;
            width: 800px !important; /* A4 宽度模拟 */
            background: #ffffff !important;
            color: #000000 !important;
            font-family: 'Arial', sans-serif !important;
            visibility: visible !important;
            padding: 20px !important;
        }

        /* 强制内部所有元素为白底黑字 */
        .pdf-render-zone * {
            color: #000000 !important;
            background-color: transparent !important;
            box-shadow: none !important;
            text-shadow: none !important;
            border-color: #000000 !important;
        }

        .pdf-render-zone .pdf-header {
            border-bottom: 3px solid #000 !important;
            margin-bottom: 20px !important;
            padding-bottom: 10px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .pdf-render-zone .pdf-record {
            border-bottom: 1px dashed #999 !important;
            padding-bottom: 20px !important;
            margin-bottom: 20px !important;
            page-break-inside: avoid !important;
        }

        .pdf-render-zone .pdf-title-bar {
            background-color: #f0f0f0 !important;
            border-left: 5px solid #000 !important;
            padding: 8px !important;
            margin-bottom: 10px !important;
            display: flex !important;
            justify-content: space-between !important;
        }

        .pdf-render-zone table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-bottom: 10px !important;
        }

        .pdf-render-zone td {
            border: 1px solid #ccc !important;
            padding: 6px !important;
            font-size: 12px !important;
        }

        .pdf-render-zone img {
            max-width: 100% !important;
            max-height: 250px !important;
            display: block !important;
            margin: 0 auto !important;
            object-fit: contain !important;
        }

        .log-card { page-break-inside: avoid; }

        @media print {
            .no-print { display: none; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body>

<div id="app" style="display: none;">
    <!-- === 新增：全局 Toast 提示组件 === -->
    <div v-if="toast.show" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100000] px-5 py-3 rounded-xl shadow-[0_10px_40px_rgba(0,0,0,0.5)] flex items-center gap-2 text-xs font-bold text-white animate-fade-in border"
         :class="toast.type === 'error' ? 'bg-rose-600 border-rose-500' : (toast.type === 'success' ? 'bg-emerald-600 border-emerald-500' : 'bg-blue-600 border-blue-500')">
        <i class="fas" :class="toast.type === 'error' ? 'fa-exclamation-circle' : (toast.type === 'success' ? 'fa-check-circle' : 'fa-info-circle')"></i>
        <span>{{ toast.msg }}</span>
    </div>
    
    <!-- 全屏PDF导出加载遮罩 -->
    <div v-if="isGeneratingPDF || isExportingList" class="fixed inset-0 bg-slate-900/95 z-[99999] flex flex-col items-center justify-center text-white backdrop-blur-sm">
        <i class="fas fa-spinner fa-spin text-5xl mb-4 text-blue-500"></i>
        <h2 class="text-xl font-bold tracking-widest uppercase">{{isExportingList ? 'Exporting All Records' : 'Rendering PDF'}}</h2>
        <p class="text-xs text-slate-400 mt-2 font-mono">Processing document, please wait... / 正在生成文件，请稍候...</p>
    </div>

    <div v-if="!currentUser" class="min-h-screen flex flex-col items-center justify-center p-8 bg-slate-900">
        <div class="mb-10 text-center animate-fade-in">
            <div class="w-24 h-24 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-slate-700 shadow-2xl">
                <i class="fas fa-shield-alt text-5xl text-blue-500"></i>
            </div>
            <h1 class="text-4xl font-bold text-white tracking-tight">KMC SiteOps</h1>
            <div class="flex flex-col items-center mt-3 gap-1">
                <span class="px-3 py-1 rounded-full bg-blue-500/10 text-blue-400 text-[10px] font-bold border border-blue-500/20">V15.0</span>
                <p class="text-xs text-slate-500 uppercase tracking-widest mt-1">2026-02 Final / PDF Fixed</p>
            </div>
        </div>
        
        <div class="w-full max-w-sm space-y-4 animate-fade-in" style="animation-delay: 0.1s;">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-user text-slate-500 text-xs"></i>
                </div>
                <select v-model="loginForm.id" class="ind-input bg-slate-900 h-12 pl-10">
                    <option value="" disabled>-- Select Identity / 选择身份 --</option>
                    <optgroup label="Management / 管理层">
                        <option v-for="u in staffList.filter(x=>x.role!=='patrol')" :value="u.login_id">{{u.name}}</option>
                    </optgroup>
                    <optgroup label="Patrol / 安保队">
                        <option v-for="u in staffList.filter(x=>x.role==='patrol')" :value="u.login_id">{{u.name}}</option>
                    </optgroup>
                </select>
            </div>

            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-lock text-slate-500 text-xs"></i>
                </div>
                <input type="password" v-model="loginForm.password" class="ind-input bg-slate-900 text-center tracking-widest h-12 pl-10" placeholder="Password / 密码">
            </div>
            
            <button @click="handleLogin" :disabled="isLoading" class="btn btn-primary w-full shadow-lg h-12 text-xs font-bold tracking-wider">
                <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                {{ isLoading ? 'VERIFYING / 验证中...' : 'LOGIN SYSTEM / 登录系统' }}
            </button>
            
            <p class="text-center text-[10px] text-slate-600 mt-4">Protected System. Authorized Access Only.<br>内部系统 仅限授权访问</p>
            
            <!-- 系统功能快览 / System Guide -->
            <div class="mt-6 p-4 bg-slate-800/50 border border-slate-700/50 rounded-xl text-[10px] text-slate-500 leading-relaxed max-w-sm w-full">
                <div class="text-center text-slate-400 font-bold uppercase tracking-wider mb-2"><i class="fas fa-book-open mr-1"></i> Quick Guide / 功能快览</div>
                <div class="space-y-1.5">
                    <div><strong class="text-blue-400">Tasks / 任务</strong> — View & execute patrol assignments / 查看并执行巡逻任务</div>
                    <div><strong class="text-purple-400">Inspect / 督察</strong> — Report violations with evidence & signatures / 违规上报（含证据照片及签字）</div>
                    <div><strong class="text-rose-400">SOS</strong> — Emergency alerts (fire, intruder, accident) / 紧急求救（火灾、入侵、事故）</div>
                    <div><strong class="text-slate-300">Log / 记录</strong> — Browse all reports, export PDF/Excel / 浏览所有报告，导出PDF或Excel</div>
                    <div><strong class="text-emerald-400">Team / 团队</strong> — Manage staff, config, rankings (managers) / 管理员工、配置、排行榜（管理层）</div>
                </div>
            </div>
        </div>
    </div>

    <div v-else class="app-container" v-show="!isGeneratingPDF">
        
        <header class="header-bar">
            <div class="flex items-center">
                <div v-if="currentView !== 'tasks'" @click="goBack" class="flex items-center gap-2 cursor-pointer text-slate-400 hover:text-white transition group">
                    <div class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center group-hover:bg-slate-700 transition">
                        <i class="fas fa-arrow-left text-xs"></i>
                    </div>
                    <span class="text-xs font-bold uppercase group-hover:text-blue-400 transition">Back / 返回</span>
                </div>
                
                <div v-else class="flex items-center gap-3 cursor-pointer group" @click="openPwdModal(currentUser)" title="Click to change password / 点击修改密码">
                    <div class="w-9 h-9 rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center text-xs font-bold text-blue-500 shadow-inner group-hover:border-blue-500 transition">
                        {{currentUser.name[0]}}
                    </div>
                    <div class="flex flex-col">
                        <h2 class="text-sm font-bold text-slate-100 leading-none mb-1 group-hover:text-blue-400 transition">
                            {{currentUser.name}} <i class="fas fa-pen text-[9px] ml-1 opacity-50"></i>
                        </h2>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-[9px] text-slate-400 uppercase font-medium">Online / 在线</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2.5 px-3 py-1.5 bg-slate-900/80 rounded-full border border-slate-700/50 shadow-inner mr-1 hidden sm:flex lg:flex md:flex" style="display: flex;">
                    <i class="fas fa-cloud text-[11px] transition-colors duration-300"
                       :class="isOffline ? 'text-rose-500' : (offlineQueue && offlineQueue.length > 0 ? 'text-amber-500 animate-pulse' : 'text-emerald-500')"
                       :title="isOffline ? 'Offline / 离线' : ((offlineQueue && offlineQueue.length > 0) ? 'Pending Sync / 待同步' : 'Online & Synced / 在线已同步')">
                    </i>
                    
                    <span class="w-[1px] h-3.5 bg-slate-600/50"></span> <i class="fas fa-clipboard-list text-[11px] transition-colors duration-300"
                       :class="(sortedTasks && sortedTasks.length > 0) ? 'text-amber-500' : 'text-emerald-500'"
                       :title="(sortedTasks && sortedTasks.length > 0) ? sortedTasks.length + ' Active Tasks / 有待执行任务' : 'All Tasks Clear / 任务已全清空'">
                    </i>
                </div>
                <button v-if="offlineQueue && offlineQueue.length > 0" @click="syncOfflineData" class="text-[10px] bg-amber-500 text-black px-3 py-1.5 rounded font-bold shadow-[0_0_15px_rgba(245,158,11,0.5)] animate-bounce flex items-center gap-1.5">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>SYNC ({{offlineQueue.length}})</span>
                </button>
                <button @click="logout" class="text-[10px] text-rose-500 border border-rose-500/30 px-3 py-1.5 rounded hover:bg-rose-500/10 transition">
                    <i class="fas fa-sign-out-alt mr-1"></i> Exit / 退出
                </button>
            </div>
        </header>

        <main class="flex-1 px-5 py-5 overflow-y-auto pb-28 scroll-smooth">

            <div v-if="currentView === 'tasks'" class="animate-fade-in">
                
                <!-- 功能说明 / Module Guide -->
                <div class="guide-tip" style="background:rgba(91,141,239,0.05); border:1px solid rgba(91,141,239,0.15);">
                    <i class="fas fa-info-circle text-blue-400 mr-1.5"></i>
                    <strong class="text-blue-300">Tasks / 任务列表：</strong>
                    View and execute assigned security tasks. Tap a task card to expand details, then press "EXECUTE" to start reporting.
                    <span class="block mt-1 opacity-60">查看并执行分配的安保任务。点击任务卡片展开详情，按"执行任务"开始上报。</span>
                </div>

                <div class="flex justify-between items-end mb-4 border-b border-slate-800 pb-3">
                    <div>
                        <h2 class="text-lg font-bold text-slate-100">Tasks / 任务列表</h2>
                        <p class="text-[10px] text-slate-500 font-mono mt-0.5">
                            {{ new Date().toLocaleDateString() }} • {{ sortedTasks.length }} Active
                        </p>
                    </div>
                    
                    <div class="flex gap-2">
                        <button v-if="!isManagement" @click="openInspection" class="btn btn-inspect px-3 py-2 text-[10px] rounded-full shadow-lg">
                             <i class="fas fa-search-plus mr-1"></i> INSPECT / 督察
                        </button>

                        <button v-if="isManagement" @click="editTask(null)" class="btn btn-primary px-4 py-2 text-[10px] rounded-full shadow-lg">
                            <i class="fas fa-plus mr-1"></i> New / 新增
                        </button>
                    </div>
                </div>

                <div v-if="sortedTasks.length===0" class="flex flex-col items-center justify-center py-12 text-slate-600 border border-dashed border-slate-800 rounded-xl bg-slate-800/20">
                    <i class="fas fa-clipboard-check text-4xl mb-3 opacity-20"></i>
                    <p class="text-xs font-medium">No tasks found / 暂无任务数据</p>
                </div>

                <div v-for="task in sortedTasks" :key="task.id" class="ind-card relative border-l-4 group" :class="task.is_temp ? 'border-l-warning' : 'border-l-primary'">
                    
                    <div class="p-3 bg-slate-800/50 border-b border-slate-700/50 flex justify-between items-start">
                        <div class="flex items-center flex-wrap gap-1.5">
                            <span v-if="task.is_temp" class="text-[9px] font-bold px-2 py-0.5 rounded bg-amber-500 text-black uppercase shadow-sm">TEMP / 临时</span>
                            <span class="text-[9px] font-bold px-2 py-0.5 rounded border uppercase" :class="task.priority==='high'?'text-rose-400 border-rose-500/30 bg-rose-500/10':'text-blue-400 border-blue-500/30 bg-blue-500/10'">
                                {{task.priority}}
                            </span>
                            <span v-if="task.assigned_team" class="text-[10px] text-slate-300 bg-slate-700/50 border border-slate-600/50 px-2 py-0.5 rounded truncate max-w-[120px]">
                                <i class="fas fa-shield-alt text-[9px] mr-1 opacity-50"></i>{{task.assigned_team}}
                            </span>
                        </div>
                        <span class="text-[10px] font-mono tabular-nums text-slate-400 tracking-wider">{{formatDate(task.due_date)}}</span>
                    </div>
                    
                    <div class="p-4 cursor-pointer hover:bg-slate-800/30 transition" @click="toggleExpand(task.id)">
                        <h3 class="font-bold text-base text-slate-200 mb-1 leading-snug">{{task.title}}</h3>
                        
                        <div class="text-xs text-slate-400 font-mono mt-2" :class="expanded.includes(task.id)?'content-expanded':'content-collapsed'">
                            <span class="text-yellow-500 font-bold mr-1">REQ:</span> {{task.content}}
                        </div>
                        
                        <div class="text-center mt-3 opacity-30 group-hover:opacity-100 transition-opacity">
                            <i class="fas text-[10px]" :class="expanded.includes(task.id)?'fa-chevron-up':'fa-chevron-down'"></i>
                        </div>
                    </div>

                    <div class="p-3 bg-slate-900 border-t border-slate-800 flex gap-2">
                        <button v-if="!isManagement" @click="goToExec(task)" class="btn btn-primary flex-1 py-3 text-xs shadow-lg hover:brightness-110 transition">
                            <i class="fas fa-play mr-2"></i> EXECUTE / 执行任务
                        </button>
                        
                        <div v-if="isManagement" class="flex w-full gap-2 items-center justify-between">
                            <label class="flex items-center gap-2 text-[10px] text-slate-400 bg-slate-800 px-3 py-2 rounded border border-slate-700 cursor-pointer hover:border-slate-500 transition">
                                <input type="checkbox" v-model="task.active" @change="saveTask(task, true)" class="accent-blue-500 w-4 h-4"> Active / 启用
                            </label>
                            <div class="flex gap-2">
                                <button @click="editTask(task)" class="btn btn-ghost px-3 py-1.5 text-[10px] text-blue-400 border-blue-500/30 hover:bg-blue-500/10">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button @click="deleteTask(task.id)" class="btn btn-ghost px-3 py-1.5 text-[10px] text-rose-500 border-rose-500/30 hover:bg-rose-500/10">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'inspection'" class="pt-2 animate-fade-in">
                 <div class="mb-6">
                    <span class="text-[10px] text-slate-400 font-bold uppercase mb-1 block tracking-wider">Supervision / 督察</span>
                    <h2 class="text-lg font-bold text-slate-100">Report Violation / 违规上报</h2>
                </div>

                <!-- 功能说明 / Module Guide -->
                <div class="guide-tip" style="background:rgba(167,139,250,0.05); border:1px solid rgba(167,139,250,0.15);">
                    <i class="fas fa-info-circle text-purple-400 mr-1.5"></i>
                    <strong class="text-purple-300">Inspection / 督察模式：</strong>
                    Select the target company and point, describe the violation, take evidence photos, then sign and submit. Both patrol officer and the person involved must sign.
                    <span class="block mt-1 opacity-60">选择目标公司和点位，描述违规情况，拍摄证据照片，签字后提交。巡逻员和当事人均需签字。</span>
                </div>

                <div class="space-y-6">
                    <div class="p-4 bg-slate-800/50 rounded-xl border border-slate-600/30 shadow-sm">
                        <label class="text-[10px] text-slate-500 uppercase font-bold block mb-2">Target / 目标 <span class="text-rose-500">*</span></label>
                        <div class="space-y-3">
                             <select v-model="inspectionForm.company" class="ind-input text-xs font-bold text-blue-100 bg-blue-900/10 border-blue-500/30 h-10">
                                <option value="">-- Select Company / 选择公司 --</option>
                                <option v-for="c in config.companies" :value="c">{{c}}</option>
                            </select>
                            
                            <div v-if="inspectionForm.company" class="animate-fade-in">
                                <select v-model="inspectionForm.point" class="ind-input text-xs text-slate-300 border-slate-600 h-10">
                                    <option value="">-- Select Point / 选择点位 --</option>
                                    <option v-for="p in (config.pointsMap[inspectionForm.company] || [])" :value="p.name">{{p.name}}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Violation Details / 违规详情 <span class="text-rose-500">*</span></label>
                        
                        <div class="relative bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                            <div class="flex justify-between items-center bg-slate-900/50 px-3 py-2 border-b border-slate-700">
                                <span class="text-[9px] text-slate-400 font-bold uppercase">Content Editor</span>
                                <button @click="translate('content', inspectionForm)" :disabled="isLoading" 
                                        class="flex items-center gap-1.5 px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-[9px] font-bold transition-colors">
                                    <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                                    <i v-else class="fas fa-language"></i>
                                    TRANSLATE / 翻译
                                </button>
                            </div>
                            
                            <textarea v-model="inspectionForm.content" class="w-full bg-transparent text-white text-xs p-3 h-32 outline-none resize-none" 
                                      :class="checkTranslationStatus(inspectionForm.content)?'text-emerald-300':'text-slate-200'" 
                                      placeholder="Describe the violation (Sleeping, Uniform, etc) / 描述违规情况 (睡觉、未穿制服等)..."></textarea>
                        </div>

                        <p class="text-[10px] mt-1 transition-colors duration-300 text-right font-mono" :class="checkTranslationStatus(inspectionForm.content)?'text-emerald-500':'text-rose-500'">
                            {{ checkTranslationStatus(inspectionForm.content) ? '[✔ Translated / 已翻译]' : '[⚠ Click Translate / 请先点击翻译]' }}
                        </p>
                    </div>

                    <div class="p-4 border border-slate-500/30 rounded-xl bg-slate-800/20">
                        <div class="text-xs text-slate-400 font-bold mb-3 uppercase flex items-center gap-2">
                             <i class="fas fa-camera"></i> Evidence / 证据照片 (Required)
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="border-2 border-dashed border-slate-500/50 bg-slate-800 rounded flex flex-col items-center justify-center h-20 cursor-pointer relative hover:bg-slate-700/50 transition">
                                <i class="fas fa-camera text-xl text-slate-500"></i>
                                <input type="file" accept="image/*" capture="environment" @change="handleInspectionPhoto" class="absolute inset-0 opacity-0 w-full h-full">
                            </div>
                            <div v-for="(img, idx) in inspectionForm.photos" :key="idx" class="relative h-20 bg-black rounded border border-slate-700 overflow-hidden group">
                                <img :src="img" class="w-full h-full object-cover">
                                <button @click="inspectionForm.photos.splice(idx,1)" class="absolute top-0 right-0 bg-black/50 text-white w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">×</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                         <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Patrol Sign / 巡逻员签字</label>
                            <div @click="openSigModal('inspection')" class="ind-input p-3 text-center cursor-pointer bg-slate-800 border-dashed hover:bg-slate-800/80 transition" :class="hasSignedInspection ? 'border-emerald-500 bg-emerald-500/5' : 'border-slate-500/50'">
                                <span v-if="hasSignedInspection" class="text-emerald-500 font-bold text-[10px] flex items-center justify-center gap-1">
                                    <i class="fas fa-check"></i> SIGNED
                                </span>
                                <span v-else class="text-slate-400 text-[10px]"><i class="fas fa-pen mr-1"></i> Click to Sign</span>
                            </div>
                        </div>
                        <div>
                             <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Witness/Subject / 当事人签字</label>
                             <div @click="openSigModal('inspection_target')" class="ind-input p-3 text-center cursor-pointer bg-slate-800 border-dashed hover:bg-slate-800/80 transition" :class="hasSignedInspectionTarget ? 'border-emerald-500 bg-emerald-500/5' : 'border-slate-500/50'">
                                <span v-if="hasSignedInspectionTarget" class="text-emerald-500 font-bold text-[10px] flex items-center justify-center gap-1">
                                    <i class="fas fa-check"></i> SIGNED
                                </span>
                                <span v-else class="text-slate-400 text-[10px]"><i class="fas fa-pen mr-1"></i> Click to Sign</span>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-800">
                        <button @click="submitInspection" 
                                :disabled="!inspectionForm.company || !checkTranslationStatus(inspectionForm.content) || inspectionForm.photos.length===0 || !hasSignedInspection || isLoading" 
                                class="btn btn-inspect w-full py-4 shadow-lg transition-all text-xs font-bold tracking-wider hover:brightness-110">
                            <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                            <i v-else class="fas fa-paper-plane mr-2"></i>
                            {{ isLoading ? 'SUBMITTING...' : (!checkTranslationStatus(inspectionForm.content) ? 'TRANSLATE FIRST / 请先翻译' : 'SUBMIT REPORT / 提交督察报告') }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'task_form'" class="pt-2 animate-fade-in">
                <div class="mb-4 text-center">
                    <h2 class="text-lg font-bold text-slate-200">Select Type / 选择任务类型</h2>
                </div>

                <!-- 功能说明 / Module Guide -->
                <div class="guide-tip" style="background:rgba(91,141,239,0.05); border:1px solid rgba(91,141,239,0.15);">
                    <i class="fas fa-info-circle text-blue-400 mr-1.5"></i>
                    <strong class="text-blue-300">Create Task / 创建任务：</strong>
                    <strong>Fixed Point</strong> = Assign patrol to a specific company security post (routine check).
                    <strong>Non-Fixed</strong> = Assign special tasks to internal staff (package pickup, escort, etc).
                    All text must be translated (bilingual) before saving.
                    <span class="block mt-1 opacity-60"><strong>固定岗</strong> = 将巡逻指派到特定公司安保点位（例行检查）。<strong>非固定</strong> = 指派临时任务给内部人员（取快递、护送等）。所有文字必须翻译为双语后才能保存。</span>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div @click="taskMode='routine'; tempTask.is_temp=false" class="mode-card" :class="taskMode==='routine'?'active':''">
                        <i class="fas fa-building text-3xl text-blue-500 mb-2"></i>
                        <h3 class="text-xs font-bold text-white">Fixed Point</h3>
                        <p class="text-[10px] text-slate-400">固定安保岗</p>
                    </div>
                    <div @click="taskMode='temp'; tempTask.is_temp=true; tempTask.title=''; tempTask.content=''" class="mode-card" :class="taskMode==='temp'?'active-temp':''">
                        <i class="fas fa-user-clock text-3xl text-amber-500 mb-2"></i>
                        <h3 class="text-xs font-bold text-white">Non-Fixed</h3>
                        <p class="text-[10px] text-slate-400">非固定任务</p>
                    </div>
                </div>
                
                <div v-if="taskMode === 'routine'" class="space-y-6 animate-fade-in">
                    <div class="p-4 bg-slate-800/50 rounded-xl border border-blue-500/30">
                        <h3 class="text-xs font-bold text-blue-400 uppercase mb-3"><i class="fas fa-map-marker-alt mr-1"></i> Routine / 固定指派</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-500 block mb-1">Company / 公司</label>
                                <select v-model="tempTask.assigned_team" class="ind-input text-xs" @change="tempTask.title=''">
                                    <option value="">-- Select Company / 选择公司 --</option>
                                    <option v-for="c in config.companies" :value="c">{{c}}</option>
                                </select>
                            </div>
                            <div v-if="tempTask.assigned_team" class="animate-fade-in">
                                <div class="flex justify-between items-center mb-1">
                                    <label class="text-[10px] text-blue-400 block">Point / 点位</label>
                                    <button @click="showPointManager = !showPointManager" class="text-[9px] text-blue-500 bg-blue-900/20 px-2 py-0.5 rounded border border-blue-500/30 hover:bg-blue-900/40 transition">
                                        <i class="fas fa-cog mr-1"></i> Manage
                                    </button>
                                </div>
                                
                                <div v-if="showPointManager" class="mb-2 p-3 bg-slate-900 border border-slate-700 rounded animate-fade-in shadow-inner">
                                     <div class="flex gap-2 mb-2">
                                         <input v-model="newPointName" class="ind-input py-1 text-xs" placeholder="New Point Name...">
                                         <button @click="quickAddPoint" class="btn btn-primary py-1 px-3 text-xs">Add</button>
                                     </div>
                                     <div class="max-h-32 overflow-y-auto space-y-1 pr-1">
                                         <div v-for="(p, idx) in (config.pointsMap[tempTask.assigned_team] || [])" class="flex justify-between items-center text-xs text-slate-400 p-1.5 hover:bg-slate-800 rounded transition border border-transparent hover:border-slate-700">
                                             <span>{{p.name}}</span>
                                             <button @click="quickRemovePoint(idx)" class="text-rose-500 hover:text-white"><i class="fas fa-times"></i></button>
                                         </div>
                                     </div>
                                </div>

                                <select v-model="tempTask.title" class="ind-input text-xs font-bold text-blue-100 border-blue-500/50 bg-blue-900/10" @change="autoFillContent">
                                    <option value="" disabled>-- Select Point / 选择点位 --</option>
                                    <option v-for="p in (config.pointsMap[tempTask.assigned_team] || [])" :value="p.name">{{p.name}}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="taskMode === 'temp'" class="space-y-6 animate-fade-in">
                    <div class="p-4 bg-slate-800/50 rounded-xl border border-amber-500/30">
                        <h3 class="text-xs font-bold text-amber-400 uppercase mb-3"><i class="fas fa-stopwatch mr-1"></i> Non-Fixed / 非固定任务</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-500 block mb-1">Assign To (Internal) / 指派给(内部人员)</label>
                                <select v-model="tempTask.assigned_team" class="ind-input text-xs font-bold text-amber-100 bg-amber-900/20 border-amber-500/50">
                                    <option value="">-- Select Staff / 选择人员 --</option>
                                    <option v-for="u in internalStaff" :value="u.name">{{u.name}} ({{u.login_id}})</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="text-[10px] text-amber-400 block mb-1 font-bold">Task Title / 任务标题</label>
                                <div class="flex flex-col gap-2">
                                    <select class="ind-input text-xs h-9 bg-slate-900 text-slate-400 border-slate-700" 
                                            @change="tempTask.title = $event.target.value">
                                            <option value="">-- Select Preset / 选择预设 --</option>
                                            <option v-for="p in nonFixedPresets" :value="p">{{p}}</option>
                                    </select>
                                    <input v-model="tempTask.title" class="ind-input border-amber-500/50" placeholder="Or type manually / 或手动输入...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="(taskMode==='routine' && tempTask.title) || taskMode==='temp'" class="animate-fade-in">
                    <div class="mt-6 mb-2">
                        <label v-if="taskMode==='routine'" class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Standard (Editable) / 约定标准 <span class="text-rose-500">*</span></label>
                        <label v-if="taskMode==='temp'" class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Details / 详情 <span class="text-rose-500">*</span></label>
                    </div>

                    <div class="relative bg-slate-800 rounded-lg border border-slate-700 overflow-hidden mb-2">
                        <div class="flex justify-between items-center bg-slate-900/50 px-3 py-2 border-b border-slate-700">
                            <span class="text-[9px] text-slate-400 font-bold uppercase">Task Requirements</span>
                            <button @click="translate('content', tempTask)" :disabled="isLoading" 
                                    class="flex items-center gap-1.5 px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-[9px] font-bold transition-colors">
                                <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                                <i v-else class="fas fa-language"></i>
                                TRANSLATE / 翻译
                            </button>
                        </div>
                        <textarea v-model="tempTask.content" class="w-full bg-transparent text-white text-xs p-3 h-32 outline-none resize-none" 
                                  :class="checkTranslationStatus(tempTask.content)?'text-emerald-300':'text-slate-200'"
                                  placeholder="Contract details / 合同要求..."></textarea>
                    </div>
                    
                    <p class="text-[10px] mt-1 mb-4 text-right font-mono" :class="checkTranslationStatus(tempTask.content)?'text-emerald-500':'text-rose-500'">
                        {{ checkTranslationStatus(tempTask.content) ? '[✔ Translated / 已翻译]' : '[⚠ Click Translate / 请先点击翻译]' }}
                    </p>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <label class="flex items-center gap-2 text-[10px] text-slate-300 bg-slate-800 p-3 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition select-none">
                            <input type="checkbox" v-model="tempTask.req_photo" class="accent-blue-500 w-4 h-4">
                            <span><i class="fas fa-camera mr-1"></i> Force Photo</span>
                        </label>
                        <label class="flex items-center gap-2 text-[10px] text-slate-300 bg-slate-800 p-3 rounded border border-slate-700 cursor-pointer hover:border-blue-500 transition select-none">
                            <input type="checkbox" v-model="tempTask.req_sign" class="accent-blue-500 w-4 h-4">
                            <span><i class="fas fa-file-signature mr-1"></i> Force Sign</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-800">
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">Priority / 优先级</label>
                        <select v-model="tempTask.priority" class="ind-input text-xs h-10">
                            <option value="medium">Medium / 中</option>
                            <option value="high">High / 高</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">Deadline / 截止</label>
                        <input type="datetime-local" v-model="tempTask.due_date" class="ind-input text-xs h-10 text-white">
                    </div>
                </div>

                <div class="pt-6 pb-6">
                    <button v-if="taskMode==='routine'" @click="saveTask(tempTask, false)" :disabled="!tempTask.title || !checkTranslationStatus(tempTask.content) || isLoading" class="btn btn-primary w-full py-4 shadow-lg text-xs tracking-wider font-bold">
                        <i v-if="!checkTranslationStatus(tempTask.content) && !isLoading" class="fas fa-lock mr-2"></i>
                        <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ isLoading ? 'SAVING...' : (!checkTranslationStatus(tempTask.content) ? 'TRANSLATE FIRST / 请先翻译' : 'CONFIRM ROUTINE TASK / 确认固定任务') }}
                    </button>
                    <button v-else @click="saveTask(tempTask, false)" :disabled="!checkTranslationStatus(tempTask.content) || !tempTask.title || isLoading" class="btn btn-temp w-full py-4 shadow-lg font-bold text-xs tracking-wider">
                        <i v-if="!checkTranslationStatus(tempTask.content) && !isLoading" class="fas fa-lock mr-2"></i>
                        <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ isLoading ? 'PUBLISHING...' : (!checkTranslationStatus(tempTask.content) ? 'TRANSLATE FIRST / 请先翻译' : 'PUBLISH NON-FIXED / 发布非固定任务') }}
                    </button>
                </div>
            </div>

            <div v-if="currentView === 'task_exec'" class="pt-2 animate-fade-in">
                 <div class="mb-4">
                    <span class="text-[10px] text-blue-400 font-bold uppercase mb-1 block">Current Task / 当前任务</span>
                    <h2 class="text-lg font-bold text-slate-100 mb-2 leading-tight">{{tempExecution.title}}</h2>
                    <div class="p-3 bg-slate-800/50 rounded border border-slate-700 text-xs text-slate-400 font-mono mb-4">
                        <span class="text-yellow-500 font-bold block mb-1">CONTRACT REQ / 合同要求:</span>
                        {{tempExecution.content}}
                    </div>
                </div>

                <!-- 功能说明 / Module Guide -->
                <div class="guide-tip" style="background:rgba(52,211,153,0.05); border:1px solid rgba(52,211,153,0.15);">
                    <i class="fas fa-info-circle text-emerald-400 mr-1.5"></i>
                    <strong class="text-emerald-300">Execute Task / 执行任务：</strong>
                    1. Describe the actual situation on site. 2. Click TRANSLATE to generate bilingual text. 3. If violation found, toggle the switch — this activates Supervision Mode requiring photos, violation type, and signatures. 4. Submit.
                    <span class="block mt-1 opacity-60">1. 描述现场实际情况。2. 点击"翻译"生成双语文本。3. 如发现违规，打开开关 — 将激活督查模式，需拍照、选择违规类型并签字。4. 提交。</span>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Actual Situation / 现场实际情况 <span class="text-rose-500">*</span></label>
                        
                        <div class="relative bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                            <div class="flex justify-between items-center bg-slate-900/50 px-3 py-2 border-b border-slate-700">
                                <span class="text-[9px] text-slate-400 font-bold uppercase">Situation Report</span>
                                <button @click="translate('note', executionForm)" :disabled="isLoading" 
                                        class="flex items-center gap-1.5 px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-[9px] font-bold transition-colors">
                                    <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                                    <i v-else class="fas fa-language"></i>
                                    TRANSLATE / 翻译
                                </button>
                            </div>
                            <textarea v-model="executionForm.note" class="w-full bg-transparent text-white text-xs p-3 h-32 outline-none resize-none" 
                                      :class="checkTranslationStatus(executionForm.note)?'text-emerald-300':'text-slate-200'"
                                      placeholder="Describe actual situation / 描述现场情况..."></textarea>
                        </div>
                        
                        <p class="text-[10px] mt-1 text-right font-mono" :class="checkTranslationStatus(executionForm.note)?'text-emerald-500':'text-rose-500'">
                            {{ checkTranslationStatus(executionForm.note) ? '[✔ Translated / 已翻译]' : '[⚠ Click Translate / 请先点击翻译]' }}
                        </p>
                    </div>
                    
                    <div class="p-4 bg-slate-800 rounded-xl border border-slate-700 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-amber-500"></i>
                            <div class="text-xs font-bold text-slate-200">Violation Found? / 发现违规?</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="executionForm.has_violation" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-rose-500"></div>
                        </label>
                    </div>

                    <div v-if="executionForm.has_violation || tempExecution.req_photo || tempExecution.req_sign" class="animate-fade-in p-4 border border-rose-500/30 rounded-xl bg-rose-500/5">
                        <div v-if="executionForm.has_violation" class="text-xs text-rose-400 font-bold mb-3 uppercase flex items-center justify-between border-b border-rose-500/20 pb-2">
                            <span><i class="fas fa-user-secret mr-1"></i> SUPERVISION MODE / 督查模式</span>
                        </div>
                        
                        <div v-if="executionForm.has_violation" class="mb-4">
                            <label class="text-[10px] text-rose-300 block mb-1">Violation Type / 违规类型</label>
                            <select v-model="executionForm.violation_type" class="ind-input text-xs border-rose-500/50 bg-rose-500/10">
                                <option value="">-- Select Type / 选择类型 --</option>
                                <option value="Sleeping / 睡岗">Sleeping / 睡岗</option>
                                <option value="Missing / 脱岗">Missing / 脱岗</option>
                                <option value="No Uniform / 未穿制服">No Uniform / 未穿制服</option>
                                <option value="Drunk / 酗酒">Drunk / 酗酒</option>
                                <option value="Other / 其他">Other / 其他</option>
                            </select>
                        </div>

                         <div class="mb-4" v-if="executionForm.has_violation || tempExecution.req_photo">
                            <label class="text-[10px] text-slate-500 block mb-1">Photos / 照片 (Required)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="border-2 border-dashed border-rose-500/50 bg-slate-800 rounded flex flex-col items-center justify-center h-20 cursor-pointer relative hover:bg-slate-700/50 transition">
                                    <i class="fas fa-camera text-xl text-rose-500"></i>
                                    <input type="file" accept="image/*" capture="environment" @change="handlePhotoUploadExec" class="absolute inset-0 opacity-0 w-full h-full">
                                </div>
                                <div v-for="(img, idx) in executionForm.photos" :key="idx" class="relative h-20 bg-black rounded border border-slate-700 overflow-hidden group">
                                    <img :src="img" class="w-full h-full object-cover">
                                    <button @click="executionForm.photos.splice(idx,1)" class="absolute top-0 right-0 bg-black/50 text-white w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">×</button>
                                </div>
                            </div>
                        </div>

                         <div class="grid grid-cols-1 gap-3">
                            <div v-if="executionForm.has_violation || tempExecution.req_sign">
                                <label class="text-[10px] text-slate-500 block mb-1">Patrol Signature / 巡逻员签字</label>
                                <div class="ind-input p-3 text-center bg-slate-800/50 border border-slate-600 text-slate-400 text-xs italic">
                                    <i class="fas fa-fingerprint mr-1"></i> Signed by {{currentUser.name}} (Digital ID)
                                </div>
                            </div>
                            
                            <div v-if="executionForm.has_violation">
                                <label class="text-[10px] text-rose-400 block mb-1 font-bold">Person Involved Signature / 当事人签字 (Required)</label>
                                <div @click="openSigModal('target')" class="ind-input p-3 text-center cursor-pointer bg-slate-800 border-dashed border-rose-500/50 hover:bg-rose-500/10 transition">
                                    <span v-if="hasSignedTarget" class="text-emerald-500 font-bold"><i class="fas fa-signature mr-1"></i> SIGNED / 已签字</span>
                                    <span v-else class="text-rose-400">Click to Sign / 点击签字</span>
                                </div>
                            </div>
                            
                            <div v-if="!executionForm.has_violation && tempExecution.req_sign">
                                <label class="text-[10px] text-slate-500 block mb-1">Recipient Signature / 接收人签字</label>
                                <div @click="openSigModal('vendor')" class="ind-input p-3 text-center cursor-pointer bg-slate-800 border-dashed border-slate-500/50 hover:bg-slate-700/50 transition">
                                    <span v-if="hasSignedVendor" class="text-emerald-500 font-bold"><i class="fas fa-check mr-1"></i> SIGNED / 已签字</span>
                                    <span v-else class="text-slate-400">Click to Sign / 点击签字</span>
                                </div>
                            </div>
                        </div>
                     </div>
                     
                    <div class="pt-4 border-t border-slate-800 pb-6">
                        <button @click="submitExecution" 
                                :disabled="(!isOffline && !checkTranslationStatus(executionForm.note)) || 
                                           ((executionForm.has_violation || tempExecution.req_photo) && executionForm.photos.length===0) || 
                                           (executionForm.has_violation && (!hasSignedTarget || !executionForm.violation_type)) ||
                                           (!executionForm.has_violation && tempExecution.req_sign && !hasSignedVendor) || 
                                           isLoading" 
                                class="btn w-full py-4 shadow-lg transition-all text-xs font-bold tracking-wider hover:brightness-110"
                                :class="executionForm.has_violation ? 'btn-danger' : 'btn-primary'">
                            <i v-if="!isOffline && !checkTranslationStatus(executionForm.note) && !isLoading" class="fas fa-lock mr-2"></i>
                            <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                            <i v-if="isOffline" class="fas fa-wifi text-amber-300 mr-2 opacity-70" title="Offline Mode"></i>
                            {{ isLoading ? 'PROCESSING...' : (!isOffline && !checkTranslationStatus(executionForm.note) ? 'TRANSLATE FIRST / 请先翻译' : (executionForm.has_violation ? 'SUBMIT SUPERVISION / 提交督查' : (isOffline ? 'SAVE OFFLINE / 离线保存记录' : 'SUBMIT REPORT / 提交报告'))) }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'reports'" class="pt-2 animate-fade-in">
                <!-- 功能说明 / Module Guide -->
                <div class="guide-tip" style="background:rgba(132,149,179,0.05); border:1px solid rgba(132,149,179,0.12);">
                    <i class="fas fa-info-circle text-slate-400 mr-1.5"></i>
                    <strong class="text-slate-300">Log / 记录中心：</strong>
                    View all submitted reports. Use KPI cards to quick-filter. Click records to expand full details, photos, and signatures. Managers can Approve/Reject pending reports. Export as PDF or Excel.
                    <span class="block mt-1 opacity-60">查看所有提交的报告。点击KPI卡片快速筛选。点击记录展开完整详情、照片和签字。管理层可审批/驳回待处理的报告。支持导出PDF或Excel。</span>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div class="kpi-card" @click="resetFilters">
                        <span class="text-3xl font-bold text-white">{{kpiStats.total}}</span>
                        <span class="text-[9px] text-slate-400 uppercase mt-1">Total Logs<br>全部记录</span>
                    </div>
                    <div class="kpi-card bg-rose-500/10 border-rose-500/30" @click="reportTab='incident'; renderChart()">
                        <span class="text-3xl font-bold text-rose-500">{{kpiStats.incidents}}</span>
                        <span class="text-[9px] text-rose-300 uppercase mt-1">Incidents<br>异常/违规</span>
                    </div>
                    <div class="kpi-card bg-amber-500/10 border-amber-500/30" @click="filters.status='pending'">
                        <span class="text-3xl font-bold text-amber-500">{{kpiStats.pending}}</span>
                        <span class="text-[9px] text-amber-300 uppercase mt-1">Pending<br>待处理</span>
                    </div>
                </div>

                <div v-if="kpiStats.incidents > 0" class="p-4 bg-slate-800 rounded-xl mb-4 border border-slate-700 shadow-sm animate-fade-in">
                    <h3 class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2"><i class="fas fa-chart-pie"></i> Analysis / 统计分析</h3>
                    <div class="h-40 relative">
                        <canvas id="incidentChart"></canvas>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-200">Records / 记录</h2>
                    <div class="flex gap-2">
                        <!-- PDF 导出按钮 - 强制 A4 白底 -->
                        <button class="text-xs text-rose-400 border border-rose-500/30 px-2 py-1 rounded hover:bg-rose-500/10 transition shadow-sm" @click="generateListPDF">
                            <i class="fas fa-file-pdf mr-1"></i> PDF (A4)
                        </button>
                        <button class="text-xs text-emerald-400 border border-emerald-500/30 px-2 py-1 rounded hover:bg-emerald-500/10 transition" @click="exportExcel">
                            <i class="fas fa-file-excel mr-1"></i> Excel
                        </button>
                        <button class="text-xs text-blue-400 border border-blue-500/30 px-2 py-1 rounded hover:bg-blue-500/10 transition" @click="showFilter=!showFilter">
                            <i class="fas fa-filter mr-1"></i> Filter / 筛选
                        </button>
                    </div>
                </div>
                
                <div class="tab-bar">
                    <button class="tab-btn tab-all" :class="reportTab==='all'?'active':''" @click="reportTab='all'">All / 全部</button>
                    <button class="tab-btn tab-patrol" :class="reportTab==='duty'?'active':''" @click="reportTab='duty'">Patrol / 勤务</button>
                    <button class="tab-btn tab-incident" :class="reportTab==='incident'?'active':''" @click="reportTab='incident'">Incident / 异常</button>
                    <button class="tab-btn tab-supervision" :class="reportTab==='supervision'?'active':''" @click="reportTab='supervision'">Inspect / 督查</button>
                </div>
                
                <div v-if="showFilter" class="p-4 bg-slate-800 rounded-xl border border-slate-700 mb-4 animate-fade-in shadow-lg">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="date" v-model="filters.start" class="ind-input text-xs">
                        <input type="date" v-model="filters.end" class="ind-input text-xs">
                    </div>
                    
                    <select v-model="filters.staff" class="ind-input text-xs mb-2">
                        <option value="">All Staff / 全部员工</option>
                        <option v-for="s in staffList" :value="s.login_id">{{s.name}}</option>
                    </select>
                    
                    <select v-model="filters.vendor" class="ind-input text-xs mb-2">
                        <option value="">All Companies / 全部公司</option>
                        <option v-for="c in config.companies" :value="c">{{c}}</option>
                    </select>
                    
                    <button @click="resetFilters" class="btn btn-ghost w-full py-1 text-[10px]">Reset Filters / 重置</button>
                </div>

                <div v-if="filteredSubmissions.length===0" class="text-center py-12 text-slate-600 border border-dashed border-slate-800 rounded-xl">
                    <p class="text-xs">No records found / 暂无记录</p>
                </div>

                <div v-for="sub in filteredSubmissions" :key="sub.id" class="ind-card log-card" :class="getLogCardClass(sub)">
                    <div class="p-3 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/30 cursor-pointer" @click="toggleExpand(sub.id)">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-300">{{sub.staff_name}}</span>
                            <span v-if="sub.type==='supervision'" class="text-[9px] font-bold px-2 py-0.5 rounded bg-blue-500 text-white uppercase shadow-sm">INSPECT</span>
                            <span v-if="sub.is_violation" class="text-[9px] font-bold px-2 py-0.5 rounded bg-rose-500 text-white uppercase shadow-sm">VIOLATION</span>
                        </div>
                        <span class="text-[10px] font-mono tabular-nums text-slate-400 tracking-wider">{{sub.time.substring(5,16)}}</span>
                    </div>
                    
                    <div class="p-3 pl-4" @click="toggleExpand(sub.id)">
                        <h4 class="text-sm font-bold text-slate-100 truncate mb-1">{{sub.title}}</h4>
                        
                        <div v-if="!expanded.includes(sub.id)" class="text-xs text-slate-500 truncate">
                            {{sub.note.split('\n')[0]}}... <span class="text-[9px] opacity-50 ml-1">(Click to expand)</span>
                        </div>

                        <div v-if="expanded.includes(sub.id)" class="mt-3 animate-fade-in border-t border-slate-700/50 pt-3">
                            <div class="grid grid-cols-2 gap-2 mb-3 text-[10px]">
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700/30">
                                    <span class="text-slate-500 block mb-0.5">Log ID / 记录号</span>
                                    <span class="text-slate-300 font-mono">#{{sub.id}}</span>
                                </div>
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700/30">
                                    <span class="text-slate-500 block mb-0.5">Task Type / 任务类型</span>
                                    <span class="text-slate-300 uppercase">{{sub.type}}</span>
                                </div>
                            </div>
                        
                            <div class="bg-slate-900/80 p-3 rounded-lg border border-slate-700/50 mb-3 relative">
                                <span class="text-[9px] text-blue-400 font-bold uppercase mb-2 block border-b border-slate-700/50 pb-1">Details & Remarks / 详情描述</span>
                                <p class="text-xs text-slate-300 font-mono whitespace-pre-wrap leading-relaxed">{{sub.note}}</p>
                            </div>
                            
                            <div v-if="sub.photos && sub.photos.length > 0" class="mb-3">
                                <span class="text-[9px] text-emerald-400 font-bold uppercase mb-2 block border-b border-slate-700/50 pb-1">Evidence & Signatures / 证据与签字</span>
                                <div class="grid grid-cols-2 gap-2">
                                    <div v-for="(p, pi) in sub.photos" :key="pi" class="relative bg-white rounded border border-slate-600 overflow-hidden flex items-center justify-center min-h-[80px] cursor-zoom-in group" @click.stop="previewImage(p)">
                                        <img :src="p" class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-300">
                                        <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                            <i class="fas fa-search-plus text-white text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                            <div class="mt-4 flex justify-between items-center pt-3 border-t border-slate-700/30">
                                <button @click.stop="generatePDF(sub)" class="text-[10px] text-rose-400 border border-rose-500/30 px-2.5 py-1 rounded hover:bg-rose-500/10 transition export-hide flex items-center gap-1">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <div class="flex gap-2 ml-auto">
                                    <span v-if="sub.status==='offline_pending'" class="text-[10px] text-slate-300 font-bold flex items-center bg-slate-600/30 border border-slate-500/50 px-2.5 py-1 rounded-full shadow-[0_0_10px_rgba(100,116,139,0.3)] backdrop-blur-sm animate-pulse">
                                        <i class="fas fa-cloud-upload-alt mr-1.5"></i> Offline / 离线待同步
                                    </span>
                                    <span v-else-if="sub.status==='verified'" class="text-[10px] text-emerald-500 font-bold flex items-center bg-emerald-500/10 px-2 py-0.5 rounded-full"><i class="fas fa-check-circle mr-1"></i> Verified / 已审核</span>
                                    <span v-else-if="sub.status==='rejected'" class="text-[10px] text-rose-500 font-bold flex items-center bg-rose-500/10 px-2 py-0.5 rounded-full"><i class="fas fa-times-circle mr-1"></i> Rejected / 已驳回</span>
                                    <div v-else class="flex items-center gap-2">
                                        <span class="text-[10px] text-amber-500 flex items-center"><i class="fas fa-clock mr-1"></i> Pending / 待审核</span>
                                        <div v-if="isManagement" class="flex gap-1 ml-2 animate-fade-in export-hide">
                                            <button @click.stop="updateSubmissionStatus(sub, 'verified')" class="text-[10px] bg-emerald-600/20 text-emerald-400 border border-emerald-500/30 px-2 py-1 rounded hover:bg-emerald-500 hover:text-white transition shadow-sm"><i class="fas fa-check"></i> Approve</button>
                                            <button @click.stop="updateSubmissionStatus(sub, 'rejected')" class="text-[10px] bg-rose-600/20 text-rose-400 border border-rose-500/30 px-2 py-1 rounded hover:bg-rose-500 hover:text-white transition shadow-sm"><i class="fas fa-times"></i> Reject</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'team'" class="pt-2 animate-fade-in">
                <div class="mb-6"><h2 class="text-lg font-bold text-slate-200">Management / 管理</h2></div>

                <!-- 功能说明 / Module Guide -->
                <div class="guide-tip" style="background:rgba(91,141,239,0.05); border:1px solid rgba(91,141,239,0.15);">
                    <i class="fas fa-info-circle text-blue-400 mr-1.5"></i>
                    <strong class="text-blue-300">Team / 团队管理：</strong>
                    Access Config Center to manage companies & patrol points. View/change staff passwords (managers only). Edit Honor Boards to recognize top performers.
                    <span class="block mt-1 opacity-60">进入配置中心管理公司和巡逻点位。查看/修改员工密码（仅管理层）。编辑荣誉榜表彰优秀人员。</span>
                </div>
                
                <div class="ind-card p-5 bg-slate-800 mb-6 border-l-4 border-l-blue-500 relative overflow-hidden group cursor-pointer hover:bg-slate-750 transition" @click="currentView='config'">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-white">Config Center / 配置中心</h3>
                        <i class="fas fa-chevron-right text-slate-500 group-hover:translate-x-1 transition"></i>
                    </div>
                    <p class="text-[10px] text-slate-400 mb-4">Manage Companies & Points / 管理公司及点位</p>
                    <button class="btn btn-primary w-full py-2 text-xs">Enter / 进入</button>
                </div>

                <div v-if="isManagement" class="mb-6 animate-fade-in">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Staff Accounts / 员工账号</h3>
                    </div>
                    <div class="ind-card p-2 bg-slate-800/50 border border-slate-700 max-h-60 overflow-y-auto">
                        <div v-for="u in staffList" :key="u.id" class="flex justify-between items-center py-2 px-2 border-b border-slate-700/50 last:border-0 hover:bg-slate-700/30 transition rounded">
                            <div>
                                <div class="text-xs font-bold text-slate-200">{{u.name}} <span class="text-[9px] text-slate-500 font-normal ml-1">({{u.login_id}})</span></div>
                                <div class="text-[9px] text-slate-400 uppercase mt-0.5" :class="u.role!=='patrol'?'text-blue-400':''">{{u.role}} - {{u.team}}</div>
                            </div>
                            <button @click="openPwdModal(u)" class="text-[10px] bg-slate-700 border border-slate-600 px-2 py-1 rounded text-slate-300 hover:text-white hover:border-blue-500 transition shadow">
                                <i class="fas fa-key mr-1"></i> PWD
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Honor Boards / 荣誉榜</h3>
                        <button v-if="isManagement" @click="addRanking" class="text-[10px] bg-blue-600 px-2 py-1 rounded text-white shadow hover:bg-blue-500 transition">+ Add Board</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div v-for="(rank, idx) in config.manualRankings" :key="idx" class="ind-card p-3 border-l-4 shadow-sm" :class="getRankColor(idx)">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="text-xs font-bold mb-1 flex items-center" :class="getRankTextColor(idx)">
                                        <i class="fas mr-2" :class="getRankIcon(idx)"></i> {{rank.title}}
                                    </h4>
                                    <p class="text-[9px] text-slate-500 italic">{{rank.desc}}</p>
                                </div>
                                <div v-if="isManagement" class="flex gap-2">
                                     <button @click="editRanking(idx)" class="text-blue-400 text-xs hover:text-white transition"><i class="fas fa-edit"></i></button>
                                     <button @click="removeRanking(idx)" class="text-rose-400 text-xs hover:text-white transition"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <div v-for="(u, i) in rank.list" :key="i" class="flex justify-between items-center py-1 border-b border-slate-700/50 last:border-0">
                                <span class="text-xs text-slate-300">{{i+1}}. {{u.name}}</span>
                                <span class="text-xs font-mono font-bold text-white">{{u.val}}</span>
                            </div>
                            <div v-if="rank.list.length===0" class="text-[10px] text-slate-600 text-center py-2">No Records / 暂无记录</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="currentView === 'config'" class="pt-2 animate-fade-in">
                 <div class="mb-6">
                    <h2 class="text-lg font-bold text-slate-200">Config Center / 配置中心</h2>
                </div>

                <!-- 功能说明 / Module Guide -->
                <div class="guide-tip" style="background:rgba(245,183,49,0.05); border:1px solid rgba(245,183,49,0.12);">
                    <i class="fas fa-info-circle text-amber-400 mr-1.5"></i>
                    <strong class="text-amber-300">Config / 配置中心：</strong>
                    Step 1: Select or add a security company on the left. Step 2: Add patrol checkpoint names and notes on the right. These points will appear as task options when creating new patrol tasks. "Reset to Factory" restores the original 2026-02 default setup.
                    <span class="block mt-1 opacity-60">第1步：在左侧选择或添加保安公司。第2步：在右侧添加巡逻检查点名称和备注。这些点位将在创建新巡逻任务时显示为选项。"恢复出厂"将还原为2026-02默认配置。</span>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="ind-card h-fit">
                        <div class="p-3 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-xs font-bold text-blue-400 uppercase">1. Companies / 公司</h3>
                            <button @click="addCompanyPrompt" class="text-[10px] bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-500 transition">+ Add / 添加</button>
                        </div>
                        <div class="p-2 space-y-1 max-h-60 overflow-y-auto">
                            <div v-for="c in config.companies" :key="c" @click="selectedCompany=c" 
                                 class="p-3 rounded cursor-pointer border transition flex justify-between items-center" 
                                 :class="selectedCompany===c ? 'bg-blue-600/20 border-blue-500 text-white' : 'bg-slate-900 border-slate-800 text-slate-400 hover:bg-slate-800'">
                                <span class="text-xs font-bold">{{c}}</span>
                                <button v-if="selectedCompany!==c" @click.stop="removeCompany(c)" class="text-rose-500 hover:text-white px-2">×</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="selectedCompany" class="ind-card h-fit border-l-4 border-l-blue-500 animate-fade-in">
                        <div class="p-3 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-xs font-bold text-white uppercase">2. Points / 点位</h3>
                            <button @click="addPointPrompt" class="text-[10px] bg-emerald-600 text-white px-2 py-1 rounded hover:bg-emerald-500 transition">+ Add / 添加</button>
                        </div>
                        <div class="p-2 space-y-1 max-h-60 overflow-y-auto">
                            <div v-if="!config.pointsMap[selectedCompany] || config.pointsMap[selectedCompany].length===0" class="text-center py-4 text-xs text-slate-500 italic">No points yet / 暂无</div>
                            <div v-for="(p, idx) in config.pointsMap[selectedCompany]" :key="idx" class="p-2 bg-slate-900 border border-slate-800 rounded flex flex-col gap-1 group">
                                <div class="flex justify-between items-start">
                                    <span class="text-xs text-slate-200 font-bold leading-tight">{{p.name}}</span>
                                    <button @click="removePoint(idx)" class="text-rose-500 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                                </div>
                                <span class="text-[9px] text-slate-500 truncate">{{p.note}}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 space-y-3">
                    <button @click="resetToFactoryDefaults" class="btn btn-danger w-full py-3 text-xs tracking-wider font-bold">
                        <i class="fas fa-sync-alt mr-2"></i> Reset to Factory Defaults / 重置为出厂
                    </button>
                    <p class="text-center text-[9px] text-slate-600">This will restore the 2026-02 verified security points.</p>
                </div>
            </div>

            <div v-if="currentView === 'sos'" class="pt-4 animate-fade-in">
                 <div class="p-4 bg-rose-500/10 border-l-4 border-rose-500 mb-4 rounded-r flex justify-between items-start">
                    <div>
                        <h2 class="text-lg font-bold text-rose-500">SOS ALERT / 紧急求救</h2>
                        <p class="text-xs text-rose-300">Emergency Only / 仅限危险</p>
                    </div>
                    <button @click="showSosConfig = !showSosConfig" class="text-[10px] bg-slate-800 border border-slate-600 text-slate-300 px-2 py-1 rounded hover:text-white transition">
                        <i class="fas fa-cog mr-1"></i> Manage
                    </button>
                </div>

                <!-- 功能说明 / Module Guide -->
                <div class="guide-tip" style="background:rgba(240,107,129,0.05); border:1px solid rgba(240,107,129,0.15);">
                    <i class="fas fa-exclamation-triangle text-rose-400 mr-1.5"></i>
                    <strong class="text-rose-300">SOS / 紧急求救：</strong>
                    FOR EMERGENCIES ONLY (fire, intruder, accident, medical). Select type, describe the situation, translate to bilingual, then send alert. Managers can add/remove SOS types via "Manage" button.
                    <span class="block mt-1 opacity-60">仅限紧急情况使用（火灾、入侵、事故、医疗）。选择类型，描述情况，翻译为双语后发送警报。管理层可通过"管理"按钮增删SOS类型。</span>
                </div>

                <div v-if="showSosConfig" class="mb-6 p-4 bg-slate-800 border border-slate-700 rounded-xl animate-fade-in shadow-lg">
                    <h3 class="text-xs font-bold text-white mb-3">Manage SOS Types / 管理求救类型</h3>
                    <div class="flex gap-2 mb-3 relative">
                        <input v-model="newSosType" class="ind-input text-xs" :class="checkTranslationStatus(newSosType)?'has-translated':'need-translate'" placeholder="New Type (e.g. Snake) / 新类型">
                         <button @click="translateSimple(newSosType, (t)=>newSosType=t)" class="absolute right-1 top-1 bottom-1 px-2 text-slate-400 hover:text-white transition">
                            <i class="fas fa-language"></i>
                        </button>
                    </div>
                    <button @click="addSosType" :disabled="!newSosType || !checkTranslationStatus(newSosType)" class="btn btn-primary w-full py-2 mb-4 text-xs">
                        {{ !checkTranslationStatus(newSosType) ? 'Translate First / 请先翻译' : 'Add Type / 添加类型' }}
                    </button>
                    
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                        <div v-for="(type, idx) in config.sosTypes" :key="idx" class="flex justify-between items-center p-2 bg-slate-900 rounded border border-slate-800">
                            <span class="text-xs text-slate-300">{{type}}</span>
                            <button @click="removeSosType(idx)" class="text-rose-500 text-xs px-2 hover:text-white">×</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-5">
                    <select v-model="form.type" class="ind-input font-bold text-rose-500 h-12 bg-rose-500/5 border-rose-500/50">
                        <option v-for="t in config.sosTypes" :value="t">{{t}}</option>
                        <option value="other">Other / 其他 (Custom)</option>
                    </select>
                    
                    <div v-if="form.type === 'other'" class="relative animate-fade-in">
                        <input v-model="form.custom_type" class="ind-input border-rose-500/50" :class="checkTranslationStatus(form.custom_type)?'has-translated':'need-translate'" placeholder="Enter Emergency Type / 输入紧急类型">
                        <button @click="translate('custom_type', form)" :disabled="isLoading" class="absolute top-1.5 right-1.5 text-[10px] bg-slate-800 border border-slate-600 px-2 py-1 rounded text-slate-300 hover:text-white flex items-center gap-1 transition">
                            <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                            <i v-else class="fas fa-language"></i>
                            Translate
                        </button>
                    </div>

                    <div class="relative bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                        <div class="flex justify-between items-center bg-slate-900/50 px-3 py-2 border-b border-slate-700">
                            <span class="text-[9px] text-slate-400 font-bold uppercase">Details</span>
                            <button @click="translate('note', form)" :disabled="isLoading" 
                                    class="flex items-center gap-1.5 px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-[9px] font-bold transition-colors">
                                <i v-if="isLoading" class="fas fa-spinner fa-spin"></i>
                                <i v-else class="fas fa-language"></i>
                                TRANSLATE / 翻译
                            </button>
                        </div>
                        <textarea v-model="form.note" class="w-full bg-transparent text-white text-xs p-3 h-32 outline-none resize-none" 
                                  :class="checkTranslationStatus(form.note)?'text-emerald-300':'text-slate-200'"
                                  placeholder="Details (Location, status...) / 详情 (位置，状况)..."></textarea>
                    </div>
                    
                    <button @click="submit('emergency')" class="btn btn-danger w-full py-4 shadow-lg text-xs font-bold tracking-widest animate-pulse" :disabled="!checkTranslationStatus(form.note) || isLoading || (form.type==='other' && (!form.custom_type || !checkTranslationStatus(form.custom_type)))">
                        <i v-if="!checkTranslationStatus(form.note) && !isLoading" class="fas fa-lock mr-2"></i>
                        <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ isLoading ? 'SENDING...' : (!checkTranslationStatus(form.note) ? 'TRANSLATE FIRST / 请先翻译' : 'SEND ALERT / 发送警报') }}
                    </button>
                </div>
            </div>

        </main>

        <nav v-if="!['task_form','config','sos', 'task_exec', 'inspection'].includes(currentView)" class="nav-bar no-print">
            <div class="nav-item" :class="{active: currentView==='tasks'}" @click="currentView='tasks'" title="View assigned patrol tasks / 查看分配的巡逻任务">
                <i class="fas fa-clipboard-list"></i>
                <span>Tasks / 任务</span>
            </div>
             <div class="nav-item" :class="{'active-inspect': currentView==='inspection'}" @click="openInspection" title="Report violations with photos & signatures / 拍照签字上报违规">
                 <i class="fas fa-search-plus"></i>
                 <span>Inspect / 督察</span>
            </div>
            
            <div class="nav-item text-rose-500" :class="{active: currentView==='sos'}" @click="resetForm('sos'); currentView='sos'" title="Emergency alert: fire, intruder, accident / 紧急求救：火灾、入侵、事故">
                <i class="fas fa-bolt"></i>
                <span>SOS</span>
            </div>
            <div class="nav-item" :class="{active: currentView==='reports'}" @click="currentView='reports'" title="Browse all reports, export PDF/Excel / 浏览报告，导出PDF或Excel">
                <i class="fas fa-file-contract"></i>
                <span>Log / 记录</span>
            </div>
            <div v-if="isManagement" class="nav-item" :class="{active: currentView==='team'}" @click="currentView='team'" title="Manage staff, config, rankings / 管理员工、配置、排行榜">
                <i class="fas fa-users-gear"></i>
                <span>Team / 团队</span>
            </div>
        </nav>
    </div>

    <!-- Modals -->
    <div v-if="showSigModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                <span class="font-bold text-white"><i class="fas fa-file-signature mr-2 text-blue-500"></i>Signature / 签字</span>
                <button @click="closeSigModal" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="bg-white rounded h-40 mb-4 border border-dashed border-slate-500 relative shadow-inner overflow-hidden">
                <canvas id="signature-pad" class="w-full h-full cursor-crosshair"></canvas>
            </div>
            <div class="flex gap-4">
                <button @click="clearSignature" class="btn btn-ghost flex-1">Clear / 重写</button>
                <button @click="saveSignature" class="btn btn-success flex-1">Confirm / 确认</button>
            </div>
        </div>
    </div>
    
    <div v-if="showPwdModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                <span class="font-bold text-white"><i class="fas fa-key mr-2 text-blue-500"></i>Change Password / 修改密码</span>
                <button @click="showPwdModal = false" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Target Account / 目标账号</label>
                <div class="ind-input text-xs bg-slate-900 border-slate-700 text-slate-300 cursor-not-allowed">{{pwdForm.name}} ({{pwdForm.login_id}})</div>
            </div>

            <div class="mb-4">
                <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">New Password / 新密码 <span class="text-rose-500">*</span></label>
                <input type="password" v-model="pwdForm.new_pwd" class="ind-input text-xs tracking-widest text-center" placeholder="Enter new password / 输入新密码">
            </div>
            
            <div class="mb-6">
                <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Confirm Password / 确认密码 <span class="text-rose-500">*</span></label>
                <input type="password" v-model="pwdForm.confirm_pwd" class="ind-input text-xs tracking-widest text-center" placeholder="Confirm new password / 确认新密码">
            </div>

            <button @click="submitPasswordChange" :disabled="isLoading || !pwdForm.new_pwd || pwdForm.new_pwd !== pwdForm.confirm_pwd" class="btn btn-primary w-full py-3 text-xs tracking-wider shadow-lg">
                <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                {{ isLoading ? 'UPDATING...' : (pwdForm.new_pwd && pwdForm.new_pwd !== pwdForm.confirm_pwd ? 'PASSWORD MISMATCH / 密码不一致' : 'UPDATE PASSWORD / 更新密码') }}
            </button>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div v-if="previewImageUrl" class="modal-overlay" @click="previewImageUrl = null">
        <div class="max-w-full max-h-full p-4 relative animate-fade-in flex items-center justify-center">
            <button class="absolute top-2 right-2 text-white bg-black/60 rounded-full w-8 h-8 flex items-center justify-center hover:bg-rose-500 transition z-50" @click.stop="previewImageUrl = null">
                <i class="fas fa-times"></i>
            </button>
            <img :src="previewImageUrl" class="max-w-full max-h-[85vh] object-contain border-2 border-slate-700 shadow-2xl rounded bg-white" @click.stop>
        </div>
    </div>

</div>

<script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://wwtkagzvdxgvcagwvvdz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3dGthZ3p2ZHhndmNhZ3d2dmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNjUxMzIsImV4cCI6MjA4NTY0MTEzMn0.uVRP7UKAOMSRHRVpzjK5s2TCreY7_RaerVdYcS0ZrX8';
    
    // Initialize Client
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Vue Composition API
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // User Session
            const currentUser = ref(null);
            
            // === 新增：Toast 状态和方法 ===
            const toast = ref({ show: false, msg: '', type: 'info' });
            let toastTimer = null;
            const showToast = (msg, type = 'info') => {
                toast.value = { show: true, msg, type };
                if (toastTimer) clearTimeout(toastTimer);
                toastTimer = setTimeout(() => { toast.value.show = false; }, 3000);
            };

            // === 新增：防抖函数 (用于优化深层监听) ===
            const debounce = (fn, delay = 800) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => { fn(...args); }, delay);
                };
            };

            const loginForm = ref({ id: '', password: '' });
            
            // UI State
            const currentView = ref('tasks');
            const isLoading = ref(false);
            const isGeneratingPDF = ref(false); 
            const isExportingList = ref(false); // [NEW] Added List Export State
            const expanded = ref([]); 
            
            // Data
            const staffList = ref([]);
            const tasks = ref([]);
            const submissions = ref([]);
            
            // Forms
            const tempTask = ref({ title:'', content:'', priority:'medium', is_temp:false, req_photo:false, req_sign:false });
            const executionForm = ref({ note: '', photos: [], has_violation: false, violation_type: '' });
            const inspectionForm = ref({ company: '', point: '', content: '', photos: [] });
            const form = ref({ type:'Car Accident', custom_type: '', note:'', photos:[] }); 
            
            // Config
            const selectedCompany = ref('');
            const showPointManager = ref(false);
            const newPointName = ref('');
            const showSosConfig = ref(false);
            const newSosType = ref('');
            const tempExecution = ref({});
            
            // Filters
            const showFilter = ref(false);
            const filters = ref({ start:'', end:'', vendor:'', staff: '', search:'', status: '' });
            const reportTab = ref('all');
            
            // Signature & Modals
            const showSigModal = ref(false);
            const sigTarget = ref(''); 
            const hasSignedVendor = ref(false);
            const hasSignedTarget = ref(false); 
            const hasSignedInspection = ref(false);
            const hasSignedInspectionTarget = ref(false);
            const showPwdModal = ref(false);
            const pwdForm = ref({ login_id: '', name: '', new_pwd: '', confirm_pwd: '' });

            // Task Mode & Visuals
            const taskMode = ref('routine');
            let chartInstance = null;
            const pdfData = ref(null);
            const previewImageUrl = ref(null);
            const previewImage = (url) => { previewImageUrl.value = url; };

            // === 离线支持 (Offline Support) ===
            const isOffline = ref(!navigator.onLine);
            const offlineQueue = ref(JSON.parse(localStorage.getItem('kmc_offline_records_v14')) || []);

            window.addEventListener('online', () => { 
                isOffline.value = false; 
                if(offlineQueue.value.length > 0) showToast('Network restored. You have pending records. / 网络已恢复，您有待同步的记录。', 'info'); 
            });
            window.addEventListener('offline', () => { isOffline.value = true; });

            // === 优化：使用防抖保存离线队列，避免存储大图片时卡顿 ===
            const saveOfflineQueue = debounce((newVal) => {
                try {
                    localStorage.setItem('kmc_offline_records_v14', JSON.stringify(newVal));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        offlineQueue.value.pop();
                        showToast("Storage full! Please sync immediately. / 存储已满，请立即同步！", "error");
                    }
                }
            }, 1000);
            watch(offlineQueue, (newVal) => saveOfflineQueue(newVal), { deep: true });

            const nonFixedPresets = ['Package Pickup / 取快递', 'Visitor Escort / 访客护送', 'Emergency Drill / 应急演练', 'Traffic Control / 交通疏导', 'Equipment Check / 设备检查'];

            // === Integrated V13.9 Data Config ===
            const factoryConfig = {
                companies: ['EASYRING SECURITY', 'SHOCK SECURITY', 'FOCUS SECURITY'],
                sosTypes: ['Car Accident / 车祸', 'Fire / 火灾', 'Intruder / 入侵', 'Medical / 医疗', 'Snake / 蛇患'],
                pointsMap: {
                    'EASYRING SECURITY': [{name: 'Phase I Plant', note: '24h check'}, {name: 'Phase II Plant', note: 'Check generators'}, {name: 'Main Gate', note: 'Check entry'}],
                    'SHOCK SECURITY': [{name: 'New Office', note: '24h shift'}, {name: 'South Boomgate', note: 'Check vehicles'}],
                    'FOCUS SECURITY': [{name: 'Single Cottage', note: 'Front Door'}, {name: 'Guest House', note: 'Night shift'}]
                },
                manualRankings: [
                    { title: 'Most Patrols', desc: 'Highest frequency', list: [{name:'Kudat', val:'150'}, {name:'EDWIN', val:'120'}] },
                    { title: 'Most Issues', desc: 'Safety hazards', list: [{name:'Kudat', val:'15'}] },
                    { title: 'Violations', desc: 'SOP violations', list: [] }
                ]
            };

            const config = ref(JSON.parse(localStorage.getItem('kmc_config_v13_9_manual')) || factoryConfig);
            if(!config.value.manualRankings) config.value.manualRankings = factoryConfig.manualRankings;
            
            // === 优化：使用防抖保存配置文件 ===
            const saveConfig = debounce((newVal) => {
                localStorage.setItem('kmc_config_v13_9_manual', JSON.stringify(newVal));
            }, 1000);
            watch(config, (newVal) => saveConfig(newVal), { deep: true });

            watch(currentView, (val) => {
                if(val === 'reports') { nextTick(() => renderChart()); }
                else { if(chartInstance) { chartInstance.destroy(); chartInstance = null; } }
            });

            onMounted(() => {
                const storedUser = localStorage.getItem('kmc_user_session_v13');
                if (storedUser) currentUser.value = JSON.parse(storedUser);
                document.getElementById('app').style.display = 'block';
                fetchData();
            });

            const isManagement = computed(() => currentUser.value && ['admin', 'manager'].includes(currentUser.value.role));
            const internalStaff = computed(() => staffList.value.filter(u => u.role === 'patrol'));

            const sortedTasks = computed(() => {
                if(!currentUser.value) return [];
                let list = tasks.value.filter(t => t.active);
                if(!isManagement.value) {
                    list = list.filter(t => t.assigned_team === currentUser.value.team || t.assigned_to === currentUser.value.login_id);
                }
                return list.sort((a,b) => (a.priority==='high' ? -1 : 1));
            });

            const filteredSubmissions = computed(() => {
                // 合并离线队列记录（显示为 offline_pending 状态）
                const offlineDisplayList = offlineQueue.value.map(item => ({
                    ...item,
                    id: 'offline_' + item._local_id, 
                    status: 'offline_pending' 
                }));
                
                let list = [...offlineDisplayList, ...submissions.value];
                if(!isManagement.value) list = list.filter(s => s.staff_id === currentUser.value.login_id);
                if (reportTab.value === 'duty') list = list.filter(s => s.type === 'duty');
                else if (reportTab.value === 'incident') list = list.filter(s => s.type === 'emergency' || s.type === 'violation');
                else if (reportTab.value === 'supervision') list = list.filter(s => s.type === 'supervision'); 
                
                if(filters.value.vendor) list = list.filter(s => s.title && s.title.includes(filters.value.vendor));
                if(filters.value.staff) list = list.filter(s => s.staff_id === filters.value.staff);
                if(filters.value.status) list = list.filter(s => s.status === filters.value.status);
                if(filters.value.start && filters.value.end) {
                    const sTime = new Date(filters.value.start).getTime();
                    const eTime = new Date(filters.value.end).getTime() + 86400000;
                    list = list.filter(s => {
                        const t = new Date(s.time).getTime();
                        return t >= sTime && t < eTime;
                    });
                }
                return list;
            });

            const kpiStats = computed(() => {
                const total = filteredSubmissions.value.length;
                const incidents = filteredSubmissions.value.filter(s => s.type==='emergency' || s.type==='violation' || s.type==='supervision').length;
                const pending = filteredSubmissions.value.filter(s => s.status!=='verified').length;
                return { total, incidents, pending };
            });

            const renderChart = () => {
                const ctx = document.getElementById('incidentChart');
                if(!ctx) return;
                const counts = {};
                filteredSubmissions.value.forEach(s => {
                    if(s.type !== 'duty' || s.is_violation) {
                        let label = s.type === 'supervision' ? 'Supervision' : (s.is_violation ? 'Violation' : 'SOS');
                        counts[label] = (counts[label] || 0) + 1;
                    }
                });
                if(Object.keys(counts).length === 0) return;
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(counts),
                        datasets: [{ data: Object.values(counts), backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 10, font:{size:10} } } } }
                });
            };

            const exportExcel = () => {
                if(filteredSubmissions.value.length === 0) return showToast('No data to export / 暂无数据导出', 'warning');
                const ws = XLSX.utils.json_to_sheet(filteredSubmissions.value.map(s => ({
                    ID: s.id, Date: s.time.replace('T', ' ').substring(0,16), Staff: s.staff_name,
                    Type: s.type, Title: s.title, Note: s.note, Status: s.status
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Report");
                XLSX.writeFile(wb, "KMC_Report.xlsx");
            };

            // === 核心优化功能：前端图片智能压缩逻辑 ===
            const compressImage = (file, maxWidth = 1024, quality = 0.7) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            // 压缩为较小体积的 JPEG
                            const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                            resolve(compressedBase64);
                        };
                        img.onerror = (e) => reject(e);
                    };
                    reader.onerror = (e) => reject(e);
                });
            };

            // =====================================================
            // === PDF 导出核心 - 强制 A4 白底修复版 ===
            // =====================================================
            
            // 构建纯白底黑字的 HTML 字符串
            const buildRecordHTML = (sub) => {
                const time = sub.time ? sub.time.replace('T', ' ').substring(0, 16) : '';
                const timeShort = sub.time ? sub.time.substring(0, 10) : '';
                const isAlert = sub.is_violation || sub.type === 'emergency';
                const statusColor = sub.status === 'verified' ? '#16a34a' : (sub.status === 'rejected' ? '#dc2626' : '#d97706');
                const statusText = sub.status === 'verified' ? 'VERIFIED / 已审核' : (sub.status === 'rejected' ? 'REJECTED / 已驳回' : 'PENDING / 待审核');
                
                let photosHTML = '';
                if (sub.photos && sub.photos.length > 0) {
                    const photoItems = sub.photos.map(p => 
                        `<div style="display:inline-block; width:45%; margin:1%; border:1px solid #ccc; padding:5px; text-align:center; background:#fff;">
                            <img src="${p}" style="max-width:100%; max-height:220px; object-fit:contain;" crossorigin="anonymous">
                        </div>`
                    ).join('');
                    photosHTML = `
                        <div style="margin-top:20px; border-top:2px solid #000; padding-top:10px; page-break-inside:avoid;">
                            <div style="font-weight:bold; margin-bottom:10px; color:#000; font-size:12px;">EVIDENCE & SIGNATURES / 证据及签字</div>
                            <div style="text-align:center;">
                                ${photoItems}
                            </div>
                        </div>`;
                }

                return `
                    <div style="font-family:Arial, sans-serif; color:#000; background:#fff; padding:20px; margin-bottom:20px; border-bottom:1px dashed #999;">
                        <!-- Header -->
                        <div class="pdf-header" style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #000; padding-bottom:10px; margin-bottom:15px;">
                            <div>
                                <div style="font-size:20px; font-weight:900; color:#000;">KMC SECURITY</div>
                                <div style="font-size:10px; font-weight:bold; letter-spacing:1px;">OFFICIAL OPERATIONS REPORT</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px; font-weight:bold;">Ref: #${sub.id}</div>
                                <div style="font-size:10px; font-family:monospace;">${new Date().toISOString().substring(0, 10)}</div>
                            </div>
                        </div>

                        <!-- Title Bar -->
                        <div class="pdf-title-bar" style="background:#f0f0f0; border-left:5px solid #000; padding:10px; margin-bottom:15px; display:flex; justify-content:space-between;">
                            <h2 style="font-size:16px; font-weight:bold; margin:0; color:#000;">${sub.title || 'Untitled'}</h2>
                            <span style="border:1px solid #000; padding:2px 8px; font-size:10px; font-weight:bold; background:#fff;">${statusText}</span>
                        </div>

                        <!-- Info Grid -->
                        <table style="width:100%; border-collapse:collapse; margin-bottom:15px; font-size:12px;">
                            <tr>
                                <td style="width:20%; border:1px solid #999; padding:6px; font-weight:bold;">Time / 时间</td>
                                <td style="width:30%; border:1px solid #999; padding:6px;">${time}</td>
                                <td style="width:20%; border:1px solid #999; padding:6px; font-weight:bold;">Staff / 职员</td>
                                <td style="width:30%; border:1px solid #999; padding:6px;">${sub.staff_name}</td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #999; padding:6px; font-weight:bold;">Category / 类型</td>
                                <td style="border:1px solid #999; padding:6px; text-transform:uppercase;">${sub.type}</td>
                                <td style="border:1px solid #999; padding:6px; font-weight:bold;">Alert Level</td>
                                <td style="border:1px solid #999; padding:6px; font-weight:bold;">${isAlert ? 'CRITICAL (Yes)' : 'NORMAL (No)'}</td>
                            </tr>
                        </table>

                        <!-- Content -->
                        <div style="border:1px solid #000; padding:10px; min-height:80px; background:#fff;">
                            <div style="font-size:10px; font-weight:bold; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:2px;">DETAILS / 详情描述:</div>
                            <div style="font-size:12px; white-space:pre-wrap; line-height:1.5; color:#000;">${(sub.note || '').replace(/</g, '&lt;')}</div>
                        </div>

                        ${photosHTML}
                    </div>`;
            };

            const renderPDFFromHTML = (htmlContent, filename, loadingRef) => {
                loadingRef.value = true;

                // 1. 创建专门的渲染容器 (Invisible but rendered)
                const container = document.createElement('div');
                container.className = 'pdf-render-zone'; // 必须使用此 class 强制白底黑字
                container.innerHTML = htmlContent;
                document.body.appendChild(container);

                // 2. 强制等待所有图片加载完毕
                const images = container.querySelectorAll('img');
                const imagePromises = Array.from(images).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise((resolve) => {
                        img.onload = resolve;
                        img.onerror = resolve; // 即使失败也继续，防止卡死
                        setTimeout(resolve, 3000); // 3秒超时机制
                    });
                });

                Promise.all(imagePromises).then(() => {
                    // 3. 执行 PDF 生成
                    const opt = {
                        margin: [10, 10, 10, 10], // mm
                        filename: filename,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: {
                            scale: 2, // 提高清晰度
                            useCORS: true, // 允许跨域图片
                            logging: false,
                            backgroundColor: '#ffffff', // 强制背景白
                            windowWidth: 800 // 模拟桌面宽度
                        },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: ['css', 'legacy'] }
                    };

                    html2pdf().set(opt).from(container).save().then(() => {
                        document.body.removeChild(container);
                        loadingRef.value = false;
                        showToast('PDF Generated Successfully / PDF 生成成功', 'success');
                    }).catch(err => {
                        console.error("PDF Error:", err);
                        if (document.body.contains(container)) document.body.removeChild(container);
                        loadingRef.value = false;
                        showToast('PDF Generation Failed / PDF 生成失败', 'error');
                    });
                });
            };

            // 单条导出
            const generatePDF = (sub) => {
                if (isGeneratingPDF.value) return;
                const html = buildRecordHTML(sub);
                const timeStr = sub.time ? sub.time.substring(0, 10) : 'Report';
                renderPDFFromHTML(html, `KMC_Report_${sub.id}_${timeStr}.pdf`, isGeneratingPDF);
            };

            // 批量导出 (List Export)
            const generateListPDF = () => {
                if (isExportingList.value || isGeneratingPDF.value) return;
                if (filteredSubmissions.value.length === 0) return showToast('No data to export / 暂无数据', 'warning');
                
                const headerHTML = `
                    <div style="text-align:center; padding:20px; border-bottom:2px solid #000; margin-bottom:20px; color:#000; font-family:Arial;">
                        <h1 style="font-size:24px; font-weight:bold; margin:0;">KMC SECURITY OPERATIONS LOG</h1>
                        <p style="font-size:12px; margin-top:5px;">Export Date: ${new Date().toLocaleString()} • Total Records: ${filteredSubmissions.value.length}</p>
                    </div>`;
                
                // 拼接所有记录
                const allRecordsHTML = filteredSubmissions.value.map(sub => buildRecordHTML(sub)).join('<div class="html2pdf__page-break"></div>');
                
                const fullHTML = headerHTML + allRecordsHTML;
                const timeStr = new Date().toISOString().substring(0, 10);
                
                renderPDFFromHTML(fullHTML, `KMC_Full_Log_${timeStr}.pdf`, isExportingList);
            };

            const resetFilters = () => { filters.value = {start:'',end:'',vendor:'',staff:'',search:'', status:''}; reportTab.value='all'; renderChart(); };

            const handleLogin = async () => {
                if (isLoading.value) return;
                isLoading.value = true;
                try {
                    await new Promise(r => setTimeout(r, 800));
                    const u = staffList.value.find(x => x.login_id === loginForm.value.id && x.password === loginForm.value.password);
                    if(u) { currentUser.value = u; localStorage.setItem('kmc_user_session_v13', JSON.stringify(u)); currentView.value = 'tasks'; }
                    else showToast('Login Failed / 账号或密码错误', 'error');
                } finally { isLoading.value = false; }
            };
            
            const logout = () => { if(confirm('Exit System?')) { currentUser.value = null; loginForm.value.password = ''; localStorage.removeItem('kmc_user_session_v13'); } };
            const goBack = () => { currentView.value = 'tasks'; };

            const checkTranslationStatus = (text) => { if(!text) return false; return (text.includes('(') && text.includes(')')) || /^[\x00-\x7F]*$/.test(text); };
            
            const translate = async (field, obj) => {
                const text = obj[field]; if(!text) return;
                isLoading.value = true;
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|zh-CN`);
                    const data = await res.json();
                    if(data.responseData.translatedText) obj[field] = `${text} (${data.responseData.translatedText})`;
                } catch(e) { showToast('Service Busy / 服务繁忙', 'warning'); } finally { isLoading.value = false; }
            };
            
            const translateSimple = async (text, callback) => {
                if(!text) return; isLoading.value = true;
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|zh-CN`);
                    const data = await res.json();
                    if(data.responseData.translatedText) callback(`${text} (${data.responseData.translatedText})`);
                } finally { isLoading.value = false; }
            };

            const getLogCardClass = (sub) => {
                if(sub.type === 'supervision') return 'type-inspect';
                if(sub.type === 'duty') return sub.title && sub.title.includes('Task Exec:') && !isPredefinedTitle(sub.title) ? 'type-temp' : 'type-routine';
                if(sub.type === 'emergency' || sub.type === 'violation') return 'type-sos';
                return 'type-routine';
            };

            const isPredefinedTitle = (title) => {
                if(!title) return false;
                const clean = title.replace('Task Exec: ', '');
                for(const c in config.value.pointsMap) { if(config.value.pointsMap[c].some(p => p.name === clean)) return true; }
                return false;
            };

            const toggleExpand = (id) => { if(expanded.value.includes(id)) expanded.value = expanded.value.filter(i=>i!==id); else expanded.value.push(id); };
            const formatDate = (d) => d ? d.replace('T', ' ') : '';

            // === 优化：并发请求 Supabase 数据，大幅减少加载时间 ===
            const fetchData = async () => {
                try {
                    // 使用 Promise.all 同时发起三个请求
                    const [staffRes, tasksRes, subRes] = await Promise.all([
                        _supabase.from('kmc_staff').select('*'),
                        _supabase.from('kmc_tasks').select('*'),
                        _supabase.from('kmc_submissions').select('*').limit(50).order('id', {ascending:false})
                    ]);

                    // 1. 处理员工数据 (Integrated V13.9 Data Logic)
                    if(staffRes.data) {
                        staffList.value = staffRes.data;
                        const newPatrols = ['EDWIN', 'Gweme', 'Clement', 'FRED', 'ADMIRE', 'DEREK', 'LEVIOUS', 'SOFT', 'EDWELL', 'READY'];
                        newPatrols.forEach((name, index) => {
                            if(!staffList.value.some(u => u.name === name)) {
                                staffList.value.push({ id: 'auto_' + index, login_id: name, name: name, password: '0000', role: 'patrol', team: 'Internal' });
                            }
                        });
                    }
                    // 2. 处理任务数据
                    if(tasksRes.data) tasks.value = tasksRes.data;
                    // 3. 处理记录数据
                    if(subRes.data) submissions.value = subRes.data;

                } catch(e) { 
                    console.error("Fetch Error", e);
                    showToast("Data Sync Failed / 数据同步失败", "error");
                }
            };

            const saveTask = async (task, quick) => {
                if(isLoading.value) return; if(!quick) isLoading.value = true;
                try {
                    const payload = {...task};
                    if(task.id) await _supabase.from('kmc_tasks').update(payload).eq('id', task.id);
                    else await _supabase.from('kmc_tasks').insert([payload]);
                    if(!quick) { currentView.value='tasks'; fetchData(); }
                } catch(e) { showToast('Save Failed / 保存失败', 'error'); } finally { isLoading.value = false; }
            };
            
            const deleteTask = async (id) => { if(confirm('Delete Task?')) await _supabase.from('kmc_tasks').delete().eq('id', id); fetchData(); };
            
            const submit = async (type) => {
                if(isLoading.value) return; isLoading.value = true;
                let finalTitle = 'SOS: ' + form.value.type;
                if(form.value.type === 'other') {
                    if(!form.value.custom_type) { showToast('Please enter type / 请输入类型', 'warning'); isLoading.value = false; return; }
                    finalTitle = 'SOS: ' + form.value.custom_type;
                }
                try {
                    const payload = {
                        type: type, title: finalTitle, note: form.value.note,
                        staff_name: currentUser.value.name, staff_id: currentUser.value.login_id,
                        time: new Date().toISOString(), status: 'pending', photos: form.value.photos
                    };
                    // 离线分支
                    if(isOffline.value) {
                        payload._local_id = Date.now();
                        offlineQueue.value.push(payload);
                        showToast('Saved Offline / 已离线保存', 'success'); currentView.value='reports';
                        isLoading.value = false; return;
                    }
                    await _supabase.from('kmc_submissions').insert([payload]);
                    showToast('Alert Sent / 警报已发送', 'success'); currentView.value='reports'; fetchData();
                } catch(e) { showToast('Failed / 发送失败', 'error'); } finally { isLoading.value = false; }
            };

            const editTask = (t) => {
                tempTask.value = t ? {...t} : {priority:'medium', active:true, is_temp:false, req_photo:false, req_sign:false};
                taskMode.value = (t && t.is_temp) ? 'temp' : 'routine';
                currentView.value = 'task_form';
            };
            
            const resetForm = (t) => { form.value = {type:'Car Accident', custom_type: '', note:'', photos:[]}; };
            
            const updateSubmissionStatus = async (sub, newStatus) => {
                if (isLoading.value) return;
                isLoading.value = true;
                try {
                    const { error } = await _supabase.from('kmc_submissions').update({ status: newStatus }).eq('id', sub.id);
                    if (error) throw error;
                    sub.status = newStatus;
                } catch (e) { showToast('Status Update Failed: ' + e.message, 'error'); } finally { isLoading.value = false; }
            };
            
            const openPwdModal = (user) => {
                pwdForm.value = { login_id: user.login_id, name: user.name, new_pwd: '', confirm_pwd: '' };
                showPwdModal.value = true;
            };

            const submitPasswordChange = async () => {
                if (pwdForm.value.new_pwd !== pwdForm.value.confirm_pwd || isLoading.value) return;
                isLoading.value = true;
                try {
                    const { error } = await _supabase.from('kmc_staff').update({ password: pwdForm.value.new_pwd }).eq('login_id', pwdForm.value.login_id);
                    if (error) throw error;
                    const staffIndex = staffList.value.findIndex(u => u.login_id === pwdForm.value.login_id);
                    if (staffIndex !== -1) staffList.value[staffIndex].password = pwdForm.value.new_pwd;
                    if (currentUser.value.login_id === pwdForm.value.login_id) {
                        currentUser.value.password = pwdForm.value.new_pwd;
                        localStorage.setItem('kmc_user_session_v13', JSON.stringify(currentUser.value));
                    }
                    showToast('Password Updated / 密码已更新', 'success'); showPwdModal.value = false;
                } catch (e) { showToast('Update Failed: ' + e.message, 'error'); } finally { isLoading.value = false; }
            };

            const addCompanyPrompt = () => { const name = prompt("New Company:"); if(name) { config.value.companies.push(name); config.value.pointsMap[name] = []; } };
            const removeCompany = (c) => { if(confirm("Delete Company?")) { config.value.companies = config.value.companies.filter(i=>i!==c); delete config.value.pointsMap[c]; } };
            const addPointPrompt = () => { const name = prompt("Point Name:"); if(name) config.value.pointsMap[selectedCompany.value].push({name: name, note: 'Routine Check'}); };
            const removePoint = (idx) => { if(confirm("Delete Point?")) config.value.pointsMap[selectedCompany.value].splice(idx, 1); };
            const resetToFactoryDefaults = () => { if(confirm("Reset to Defaults?")) config.value = JSON.parse(JSON.stringify(factoryConfig)); };
            const addSosType = () => { if(newSosType.value) { config.value.sosTypes.push(newSosType.value); newSosType.value = ''; } };
            const removeSosType = (idx) => { if(confirm("Delete?")) config.value.sosTypes.splice(idx, 1); };

            const addRanking = () => { const title = prompt("Ranking Title:"); if(title) config.value.manualRankings.push({ title: title, desc: 'Description...', list: [] }); };
            const editRanking = (idx) => {
                const r = config.value.manualRankings[idx];
                const newTitle = prompt("Edit Title:", r.title); if(newTitle) r.title = newTitle;
                const newDesc = prompt("Edit Description:", r.desc); if(newDesc) r.desc = newDesc;
                const action = prompt("Type 'add' or 'clear'");
                if(action === 'add') { const name = prompt("Name:"); const val = prompt("Value:"); if(name && val) r.list.push({name, val}); } 
                else if (action === 'clear') { r.list = []; }
            };
            const removeRanking = (idx) => { if(confirm("Remove?")) config.value.manualRankings.splice(idx,1); };
            const getRankColor = (idx) => ['border-l-emerald-500', 'border-l-blue-500', 'border-l-rose-500', 'border-l-amber-500'][idx % 4];
            const getRankTextColor = (idx) => ['text-emerald-400', 'text-blue-400', 'text-rose-400', 'text-amber-400'][idx % 4];
            const getRankIcon = (idx) => ['fa-award', 'fa-search', 'fa-thumbs-down', 'fa-star'][idx % 4];

            const quickAddPoint = () => {
                if(newPointName.value && tempTask.value.assigned_team) {
                    if(!config.value.pointsMap[tempTask.value.assigned_team]) config.value.pointsMap[tempTask.value.assigned_team] = [];
                    config.value.pointsMap[tempTask.value.assigned_team].push({name: newPointName.value, note: 'Added via Task Form'});
                    newPointName.value = '';
                }
            };
            const quickRemovePoint = (idx) => { if(confirm("Delete?")) config.value.pointsMap[tempTask.value.assigned_team].splice(idx, 1); };
            const autoFillContent = () => {
                if(tempTask.value.assigned_team && tempTask.value.title) {
                    const pts = config.value.pointsMap[tempTask.value.assigned_team];
                    const p = pts.find(x => x.name === tempTask.value.title);
                    if(p) tempTask.value.content = p.note;
                }
            };

            let canvas, ctx;
            const openSigModal = (target) => {
                sigTarget.value = target; showSigModal.value = true;
                nextTick(() => {
                    canvas = document.getElementById('signature-pad'); ctx = canvas.getContext('2d');
                    canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight;
                    ctx.lineWidth = 2; ctx.strokeStyle = "#000"; ctx.fillStyle = "#fff"; ctx.fillRect(0,0, canvas.width, canvas.height);
                    let drawing = false;
                    canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
                    canvas.onmousemove = (e) => { if(drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
                    canvas.onmouseup = () => drawing = false;
                    canvas.ontouchstart = (e) => { e.preventDefault(); drawing = true; const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top); };
                    canvas.ontouchmove = (e) => { e.preventDefault(); if(drawing) { const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top); ctx.stroke(); } };
                    canvas.ontouchend = () => drawing = false;
                });
            };
            const closeSigModal = () => showSigModal.value = false;
            const clearSignature = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "#fff"; ctx.fillRect(0,0, canvas.width, canvas.height); };
            const saveSignature = () => { 
                const dataUrl = canvas.toDataURL(); 
                if(sigTarget.value === 'vendor') { hasSignedVendor.value = true; executionForm.value.photos.push(dataUrl); } 
                else if(sigTarget.value === 'target') { hasSignedTarget.value = true; executionForm.value.photos.push(dataUrl); }
                else if(sigTarget.value === 'inspection') { hasSignedInspection.value = true; inspectionForm.value.photos.push(dataUrl); }
                else if(sigTarget.value === 'inspection_target') { hasSignedInspectionTarget.value = true; inspectionForm.value.photos.push(dataUrl); }
                closeSigModal(); 
            };

            const goToExec = (task) => {
                tempExecution.value = task;
                executionForm.value = { note: '', photos: [], has_violation: false, violation_type: '' };
                hasSignedVendor.value = false; hasSignedTarget.value = false;
                currentView.value = 'task_exec';
            };
            
            // --- 优化更新位置：使用智能压缩方法处理执行任务的照片 ---
            const handlePhotoUploadExec = async (e) => {
                const file = e.target.files[0]; if (!file) return;
                try {
                    const compressedBase64 = await compressImage(file, 1024, 0.7);
                    executionForm.value.photos.push(compressedBase64);
                } catch (err) {
                    console.error("Image compression error", err);
                    showToast("Image processing failed / 图片处理失败", 'error');
                }
            };
            
            const submitExecution = async () => {
                if(isLoading.value) return; isLoading.value = true;
                try {
                    const isSupervision = executionForm.value.has_violation;
                    const payload = {
                        type: isSupervision ? 'supervision' : 'duty',
                        title: 'Task Exec: ' + tempExecution.value.title,
                        note: executionForm.value.note + (isSupervision ? `\n[VIOLATION: ${executionForm.value.violation_type}]` : '') + (isOffline.value ? '\n[OFFLINE RECORD]' : ''),
                        is_violation: executionForm.value.has_violation,
                        staff_name: currentUser.value.name, staff_id: currentUser.value.login_id,
                        time: new Date().toISOString(), status: 'pending', photos: executionForm.value.photos
                    };
                    // 离线分支
                    if(isOffline.value) {
                        payload._local_id = Date.now();
                        offlineQueue.value.push(payload);
                        showToast('No Network. Saved to local queue! / 无网络，已保存到本地队列！', 'warning');
                        currentView.value = 'tasks'; isLoading.value = false; return;
                    }
                    await _supabase.from('kmc_submissions').insert([payload]);
                    showToast('Done / 操作成功', 'success'); currentView.value = 'tasks'; fetchData();
                } catch(e) { showToast('Error: ' + e.message, 'error'); } finally { isLoading.value = false; }
            };

            const openInspection = () => {
                inspectionForm.value = { company: '', point: '', content: '', photos: [] };
                hasSignedInspection.value = false; hasSignedInspectionTarget.value = false;
                currentView.value = 'inspection';
            };
            
            // --- 优化更新位置：使用智能压缩方法处理督察任务的照片 ---
            const handleInspectionPhoto = async (e) => {
                const file = e.target.files[0]; if (!file) return;
                try {
                    const compressedBase64 = await compressImage(file, 1024, 0.7);
                    inspectionForm.value.photos.push(compressedBase64);
                } catch (err) {
                    console.error("Image compression error", err);
                    showToast("Image processing failed / 图片处理失败", 'error');
                }
            };
            
            const submitInspection = async () => {
                if(isLoading.value) return; isLoading.value = true;
                try {
                    await _supabase.from('kmc_submissions').insert([{
                        type: 'supervision',
                        title: `Supervision: ${inspectionForm.value.company} - ${inspectionForm.value.point || 'General'}`,
                        note: inspectionForm.value.content,
                        staff_name: currentUser.value.name, staff_id: currentUser.value.login_id,
                        time: new Date().toISOString(), status: 'pending', photos: inspectionForm.value.photos
                    }]);
                    showToast('Report Submitted / 报告已提交', 'success'); currentView.value = 'reports'; fetchData();
                } catch(e) { showToast('Error: ' + e.message, 'error'); } finally { isLoading.value = false; }
            };

            // === 离线数据同步 (Offline Sync) ===
            const syncOfflineData = async () => {
                if(isOffline.value) return showToast("Still offline! / 仍然无网络！", 'warning');
                if(isLoading.value || offlineQueue.value.length === 0) return;
                isLoading.value = true;
                let successCount = 0;
                const queueToSync = [...offlineQueue.value]; 

                for (const item of queueToSync) {
                    try {
                        const payload = { ...item };
                        delete payload._local_id;
                        const { error } = await _supabase.from('kmc_submissions').insert([payload]);
                        if (error) throw error;
                        offlineQueue.value = offlineQueue.value.filter(q => q._local_id !== item._local_id);
                        successCount++;
                    } catch (e) { console.error(e); }
                }
                isLoading.value = false;
                showToast(`Sync Complete: ${successCount} uploaded. / 同步完成：已上传 ${successCount} 条记录。`, 'success');
                if (successCount > 0) { currentView.value = 'reports'; fetchData(); }
            };

            return {
                toast, showToast, // <--- 确保添加了这两项
                currentUser, loginForm, currentView, staffList, sortedTasks, submissions, expanded, isManagement, 
                tempTask, form, config, selectedCompany, tempExecution, executionForm, showFilter, filters, filteredSubmissions,
                taskMode, reportTab, showSigModal, hasSignedVendor, hasSignedTarget, isLoading, internalStaff, nonFixedPresets, showSosConfig, newSosType,
                inspectionForm, hasSignedInspection, hasSignedInspectionTarget, kpiStats, pdfData, showPointManager, newPointName,
                showPwdModal, pwdForm, previewImageUrl, previewImage, isGeneratingPDF,
                isExportingList, generateListPDF,
                handleLogin, logout, goBack, fetchData, toggleExpand, formatDate, checkTranslationStatus, translate, translateSimple,
                addCompanyPrompt, removeCompany, addPointPrompt, removePoint, resetToFactoryDefaults, addSosType, removeSosType,
                autoFillContent, isPredefinedTitle, getLogCardClass, saveTask, deleteTask, editTask, submit, resetForm, goToExec, handlePhotoUploadExec, submitExecution,
                openSigModal, closeSigModal, clearSignature, saveSignature, openInspection, handleInspectionPhoto, submitInspection,
                renderChart, resetFilters, exportExcel, generatePDF, updateSubmissionStatus,
                addRanking, editRanking, removeRanking, getRankColor, getRankTextColor, getRankIcon, quickAddPoint, quickRemovePoint,
                openPwdModal, submitPasswordChange,
                isOffline, offlineQueue, syncOfflineData
            };
        }
    }).mount('#app');
</script>
</body>
</html>
